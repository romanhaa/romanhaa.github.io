<!DOCTYPE html>
<html lang="en-us"><head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="generator" content="Hugo 0.62.2" />
  
  <title>Roman Hillje - Data Visualization &amp; Bioinformatics</title>
  
  
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Righteous%7CMerriweather:300,300i,400,400i,700,700i">
  <link rel="stylesheet" href="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.css"/>
  <link rel="stylesheet" href="/css/medium.css">
</head>
<body><nav class="navbar navbar-expand-lg navbar-light bg-white mediumnavigation nav-down navbar-static-top">
  <div class="container pr-0">

    
    <a class="navbar-brand" href="http://romanhaa.github.io/">
      
      <span style="font-family:Righteous;">Roman Hillje - Data Visualization &amp; Bioinformatics</span>
      
    </a>

    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarMediumish" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    
    <div class="collapse navbar-collapse" id="navbarMediumish">
      
      <ul class="navbar-nav ml-auto">
        
        <li class="nav-item ">
          <a class="nav-link" href="/">About Me</a>
        </li>
        
        <li class="nav-item ">
          <a class="nav-link" href="/projects">Projects</a>
        </li>
        
        <li class="nav-item ">
          <a class="nav-link" href="/plots">Plot Gallery</a>
        </li>
        
        <li class="nav-item ">
          <a class="nav-link" href="/blog">Blog</a>
        </li>
        
      </ul>
    </div>

  </div>
</nav>
<div class="site-content">
      <div class="container">
  <link rel="stylesheet" href="/css/numbered_headers.css">
  
  <div class="main-content">
    
    <div class="container">
      <div class="row">
        
        <div class="col-sm-3">
          <nav id="toc" class="sticky-top" style="padding-top: 50px;"></nav>
        </div>
        <div class="col-sm-9">
        
          <div class="mainheading">
            
            <h1 class="posttitle">scRNA-seq analysis workflow</h1>
            <div class="article-post">
              Last update: Oct 7, 2020
            </div>
          </div>
          
          
            <img class="featured-image img-fluid" src="/images/projects/scrnaseq_workflow/title.png" alt="thumbnail for this post">
          
          
          <body>
            <div class="article-post">
              


<!-- <div class="btn-group" role="group" aria-label="Button group with nested dropdown">
  <div class="btn-group" role="group">
    <button id="btnGroupDrop1" type="button" class="btn btn-secondary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
      Version
    </button>
    <div class="dropdown-menu" aria-labelledby="btnGroupDrop1">
      <a class="dropdown-item" href="#">v1.1</a>
      <a class="dropdown-item" href="#">v1.0</a>
    </div>
  </div>
</div> -->






This is an example scRNA-seq workflow based on the <a href="https://satijalab.org/seurat/" target="_blank">Seurat</a> analysis framework which goes from transcript count tables until cell type annotation.
We will use three samples from a public data set <a href="https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE120221" target="_blank">GSE120221</a> of healthy bone marrow donors [1].





<div class="row">
  <div class="col-md-12">
    <div class="btn-group float-right">
      <button type="button" class="btn btn-default btn-xs code-folding-btn dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span>Code</span> <span class="caret"></span></button>
      <ul class="dropdown-menu" style="min-width: 100px; font-size: 12px;">
        <li><a id="show-all-code" href="#" style="color: black">Show All Code</a></li>
        <li><a id="hide-all-code" href="#" style="color: black">Hide All Code</a></li>
      </ul>
    </div>
  </div>
</div>


<h2 id="preparation">Preparation</h2>
<h3 id="load-r-packages">Load R packages</h3>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-r" data-lang="r"><span style="color:#900;font-weight:bold">library</span>(tidyverse)
<span style="color:#900;font-weight:bold">library</span>(Seurat)
<span style="color:#900;font-weight:bold">library</span>(scran)
<span style="color:#900;font-weight:bold">library</span>(patchwork)
<span style="color:#900;font-weight:bold">library</span>(viridis)
<span style="color:#900;font-weight:bold">library</span>(ggforce)
<span style="color:#900;font-weight:bold">library</span>(gghalves)
<span style="color:#900;font-weight:bold">library</span>(ggridges)
<span style="color:#900;font-weight:bold">library</span>(scDblFinder)
<span style="color:#900;font-weight:bold">library</span>(SingleR)
</code></pre></div><h3 id="define-colors">Define colors</h3>
<p>I have a custom color set that I like to use for discrete color scales.
It's two color palettes from <a href="https://flatuicolors.com">https://flatuicolors.com</a> merged together.
We also define some colors for the cell cycle phases.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-r" data-lang="r">custom_colors <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">list</span>()

colors_dutch <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">c</span>(
  <span style="color:#d14">&#39;</span><span style="color:#d14">#FFC312&#39;</span>,<span style="color:#d14">&#39;</span><span style="color:#d14">#C4E538&#39;</span>,<span style="color:#d14">&#39;</span><span style="color:#d14">#12CBC4&#39;</span>,<span style="color:#d14">&#39;</span><span style="color:#d14">#FDA7DF&#39;</span>,<span style="color:#d14">&#39;</span><span style="color:#d14">#ED4C67&#39;</span>,
  <span style="color:#d14">&#39;</span><span style="color:#d14">#F79F1F&#39;</span>,<span style="color:#d14">&#39;</span><span style="color:#d14">#A3CB38&#39;</span>,<span style="color:#d14">&#39;</span><span style="color:#d14">#1289A7&#39;</span>,<span style="color:#d14">&#39;</span><span style="color:#d14">#D980FA&#39;</span>,<span style="color:#d14">&#39;</span><span style="color:#d14">#B53471&#39;</span>,
  <span style="color:#d14">&#39;</span><span style="color:#d14">#EE5A24&#39;</span>,<span style="color:#d14">&#39;</span><span style="color:#d14">#009432&#39;</span>,<span style="color:#d14">&#39;</span><span style="color:#d14">#0652DD&#39;</span>,<span style="color:#d14">&#39;</span><span style="color:#d14">#9980FA&#39;</span>,<span style="color:#d14">&#39;</span><span style="color:#d14">#833471&#39;</span>,
  <span style="color:#d14">&#39;</span><span style="color:#d14">#EA2027&#39;</span>,<span style="color:#d14">&#39;</span><span style="color:#d14">#006266&#39;</span>,<span style="color:#d14">&#39;</span><span style="color:#d14">#1B1464&#39;</span>,<span style="color:#d14">&#39;</span><span style="color:#d14">#5758BB&#39;</span>,<span style="color:#d14">&#39;</span><span style="color:#d14">#6F1E51&#39;</span>
)

colors_spanish <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">c</span>(
  <span style="color:#d14">&#39;</span><span style="color:#d14">#40407a&#39;</span>,<span style="color:#d14">&#39;</span><span style="color:#d14">#706fd3&#39;</span>,<span style="color:#d14">&#39;</span><span style="color:#d14">#f7f1e3&#39;</span>,<span style="color:#d14">&#39;</span><span style="color:#d14">#34ace0&#39;</span>,<span style="color:#d14">&#39;</span><span style="color:#d14">#33d9b2&#39;</span>,
  <span style="color:#d14">&#39;</span><span style="color:#d14">#2c2c54&#39;</span>,<span style="color:#d14">&#39;</span><span style="color:#d14">#474787&#39;</span>,<span style="color:#d14">&#39;</span><span style="color:#d14">#aaa69d&#39;</span>,<span style="color:#d14">&#39;</span><span style="color:#d14">#227093&#39;</span>,<span style="color:#d14">&#39;</span><span style="color:#d14">#218c74&#39;</span>,
  <span style="color:#d14">&#39;</span><span style="color:#d14">#ff5252&#39;</span>,<span style="color:#d14">&#39;</span><span style="color:#d14">#ff793f&#39;</span>,<span style="color:#d14">&#39;</span><span style="color:#d14">#d1ccc0&#39;</span>,<span style="color:#d14">&#39;</span><span style="color:#d14">#ffb142&#39;</span>,<span style="color:#d14">&#39;</span><span style="color:#d14">#ffda79&#39;</span>,
  <span style="color:#d14">&#39;</span><span style="color:#d14">#b33939&#39;</span>,<span style="color:#d14">&#39;</span><span style="color:#d14">#cd6133&#39;</span>,<span style="color:#d14">&#39;</span><span style="color:#d14">#84817a&#39;</span>,<span style="color:#d14">&#39;</span><span style="color:#d14">#cc8e35&#39;</span>,<span style="color:#d14">&#39;</span><span style="color:#d14">#ccae62&#39;</span>
)

custom_colors<span style="color:#000;font-weight:bold">$</span>discrete <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">c</span>(colors_dutch, colors_spanish)

custom_colors<span style="color:#000;font-weight:bold">$</span>cell_cycle <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">setNames</span>(
  <span style="color:#900;font-weight:bold">c</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">#45aaf2&#39;</span>, <span style="color:#d14">&#39;</span><span style="color:#d14">#f1c40f&#39;</span>, <span style="color:#d14">&#39;</span><span style="color:#d14">#e74c3c&#39;</span>, <span style="color:#d14">&#39;</span><span style="color:#d14">#7f8c8d&#39;</span>),
  <span style="color:#900;font-weight:bold">c</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">G1&#39;</span>,      <span style="color:#d14">&#39;</span><span style="color:#d14">S&#39;</span>,       <span style="color:#d14">&#39;</span><span style="color:#d14">G2M&#39;</span>,     <span style="color:#d14">&#39;</span><span style="color:#d14">-&#39;</span>)
)
</code></pre></div><h3 id="helper-functions">Helper functions</h3>
<h4 id="format-numbers">Format numbers</h4>
<p>This is a function that will format numbers so they are easier to look at.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-r" data-lang="r">niceFormat <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">function</span>(number) {
  <span style="color:#900;font-weight:bold">formatC</span>(number, format <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">f&#39;</span>, big.mark <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">,&#39;</span>, digits <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>)
}
</code></pre></div><h4 id="load-transcript-count-matrix">Load transcript count matrix</h4>
<p>This function allows us to load transcript count matrices stored in <code>.mtx</code> format, such as the output from Cell Ranger.
Importantly, this function collapses the counts from genes with the same name (they usually have different gene IDs which is why they were reported separately).
It is not always done like this.
Others keep the genes separate by adding a suffix to the duplicate gene names.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-r" data-lang="r">load10xData <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">function</span>(
  sample_name,
  path,
  max_number_of_cells <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">NULL</span>
) {

  <span style="color:#998;font-style:italic">## read transcript count matrix</span>
  transcript_counts <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">list.files</span>(
      path,
      recursive <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">TRUE</span>,
      full.names <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">TRUE</span>
    ) <span style="color:#000;font-weight:bold">%&gt;%</span>
    <span style="color:#900;font-weight:bold">.[grep</span>(., pattern <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">mtx&#39;</span>)] <span style="color:#000;font-weight:bold">%&gt;%</span>
    Matrix<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">readMM</span>()

  <span style="color:#998;font-style:italic">## read cell barcodes and assign as column names of transcript count matrix</span>
  <span style="color:#900;font-weight:bold">colnames</span>(transcript_counts) <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">list.files</span>(
      path,
      recursive <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">TRUE</span>,
      full.names <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">TRUE</span>
    ) <span style="color:#000;font-weight:bold">%&gt;%</span>
    <span style="color:#900;font-weight:bold">.[grep</span>(., pattern <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">barcodes&#39;</span>)] <span style="color:#000;font-weight:bold">%&gt;%</span>
    <span style="color:#900;font-weight:bold">.[grep</span>(., pattern <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">tsv&#39;</span>)] <span style="color:#000;font-weight:bold">%&gt;%</span>
    <span style="color:#900;font-weight:bold">read_tsv</span>(col_names <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">FALSE</span>, col_types <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">cols</span>()) <span style="color:#000;font-weight:bold">%&gt;%</span>
    <span style="color:#900;font-weight:bold">pull</span>(<span style="color:#099">1</span>) <span style="color:#000;font-weight:bold">%&gt;%</span>
    <span style="color:#900;font-weight:bold">gsub</span>(., pattern <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">-[0-9]{1,2}&#39;</span>, replacement <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">&#39;</span>) <span style="color:#000;font-weight:bold">%&gt;%</span>
    <span style="color:#900;font-weight:bold">paste0</span>(., <span style="color:#d14">&#39;</span><span style="color:#d14">-&#39;</span>, sample_name)

  <span style="color:#998;font-style:italic">## read gene names</span>
  gene_names <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">list.files</span>(
      path,
      recursive <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">TRUE</span>,
      full.names <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">TRUE</span>
    ) <span style="color:#000;font-weight:bold">%&gt;%</span>
    <span style="color:#900;font-weight:bold">.[grep</span>(., pattern <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">genes|features&#39;</span>)] <span style="color:#000;font-weight:bold">%&gt;%</span>
    <span style="color:#900;font-weight:bold">read_tsv</span>(col_names <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">FALSE</span>, col_types <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">cols</span>()) <span style="color:#000;font-weight:bold">%&gt;%</span>
    <span style="color:#900;font-weight:bold">pull</span>(<span style="color:#900;font-weight:bold">ifelse</span>(<span style="color:#900;font-weight:bold">ncol</span>(.) <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#099">1</span>, <span style="color:#099">2</span>, <span style="color:#099">1</span>))

  <span style="color:#998;font-style:italic">## if necessary, merge counts from different transcripts of the same gene</span>
  <span style="color:#900;font-weight:bold">if </span>( <span style="color:#900;font-weight:bold">any</span>(<span style="color:#900;font-weight:bold">duplicated</span>(gene_names)) <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">TRUE</span> ) {

    <span style="color:#998;font-style:italic">## get names of genes with multiple entries</span>
    duplicated_gene_names <span style="color:#000;font-weight:bold">&lt;-</span> gene_names<span style="color:#900;font-weight:bold">[which</span>(<span style="color:#900;font-weight:bold">duplicated</span>(gene_names))]

    <span style="color:#998;font-style:italic">## log message</span>
    <span style="color:#900;font-weight:bold">message</span>(
      glue<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">glue</span>(
        <span style="color:#d14">&#34;</span><span style="color:#d14">{format(Sys.time(), &#39;[%Y-%m-%d %H:%M:%S]&#39;)} Summing up counts for &#34;</span>,
        <span style="color:#d14">&#34;</span><span style="color:#d14">{length(duplicated_gene_names)} genes with multiple entries.&#34;</span>
      )
    )

    <span style="color:#998;font-style:italic">## go through genes with multiple entries</span>
    <span style="color:#900;font-weight:bold">for </span>( i in duplicated_gene_names ) {

      <span style="color:#998;font-style:italic">## extract transcripts counts and calculate sum for each cell</span>
      tmp_counts <span style="color:#000;font-weight:bold">&lt;-</span> transcript_counts<span style="color:#900;font-weight:bold">[which</span>(gene_names <span style="color:#000;font-weight:bold">==</span> i),]
      tmp_counts_sum <span style="color:#000;font-weight:bold">&lt;-</span> Matrix<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">colSums</span>(tmp_counts)

      <span style="color:#998;font-style:italic">## remove original counts from transcript matrix and the gene name from</span>
      <span style="color:#998;font-style:italic">## the list of gene names</span>
      transcript_counts <span style="color:#000;font-weight:bold">&lt;-</span> transcript_counts[<span style="color:#000;font-weight:bold">-</span><span style="color:#900;font-weight:bold">c</span>(<span style="color:#900;font-weight:bold">which</span>(gene_names <span style="color:#000;font-weight:bold">==</span> i)),]
      gene_names <span style="color:#000;font-weight:bold">&lt;-</span> gene_names[<span style="color:#000;font-weight:bold">-</span><span style="color:#900;font-weight:bold">c</span>(<span style="color:#900;font-weight:bold">which</span>(gene_names <span style="color:#000;font-weight:bold">==</span> i))]

      <span style="color:#998;font-style:italic">## add summed counts to end of transcript count matrix and current gene</span>
      <span style="color:#998;font-style:italic">## name to end of gene names</span>
      transcript_counts <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">rbind</span>(transcript_counts, tmp_counts_sum)
      gene_names <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">c</span>(gene_names, i)
    }
  }

  <span style="color:#998;font-style:italic">## assign gene names as row names</span>
  <span style="color:#900;font-weight:bold">rownames</span>(transcript_counts) <span style="color:#000;font-weight:bold">&lt;-</span> gene_names

  <span style="color:#998;font-style:italic">## down-sample cells if more cells than `max_number_of_cells` are present in</span>
  <span style="color:#998;font-style:italic">## count matrix</span>
  <span style="color:#900;font-weight:bold">if </span>(
    <span style="color:#000;font-weight:bold">!</span><span style="color:#900;font-weight:bold">is.null</span>(max_number_of_cells) <span style="color:#000;font-weight:bold">&amp;&amp;</span>
    <span style="color:#900;font-weight:bold">is.numeric</span>(max_number_of_cells) <span style="color:#000;font-weight:bold">&amp;&amp;</span>
    max_number_of_cells <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#900;font-weight:bold">ncol</span>(transcript_counts)
  ) {
    temp_cells_to_keep <span style="color:#000;font-weight:bold">&lt;-</span> base<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">sample</span>(<span style="color:#099">1</span><span style="color:#000;font-weight:bold">:</span><span style="color:#900;font-weight:bold">ncol</span>(transcript_counts), max_number_of_cells)
    transcript_counts <span style="color:#000;font-weight:bold">&lt;-</span> transcript_counts[,temp_cells_to_keep]
  }

  <span style="color:#998;font-style:italic">##</span>
  <span style="color:#900;font-weight:bold">message</span>(
    glue<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">glue</span>(
      <span style="color:#d14">&#34;</span><span style="color:#d14">{format(Sys.time(), &#39;[%Y-%m-%d %H:%M:%S]&#39;)} Loaded counts for sample &#34;</span>,
      <span style="color:#d14">&#34;</span><span style="color:#d14">{sample_name} with {niceFormat(ncol(transcript_counts))} cells and &#34;</span>,
      <span style="color:#d14">&#34;</span><span style="color:#d14">{niceFormat(nrow(transcript_counts))} genes.&#34;</span>
    )
  )

  <span style="color:#998;font-style:italic">##</span>
  <span style="color:#900;font-weight:bold">return</span>(transcript_counts)
}
</code></pre></div><h4 id="check-if-gene-names-are-the-same">Check if gene names are the same</h4>
<p>When provided with a list of transcript count matrices, this function checks whether the gene names are the same in all the count matrices, which is an important premise for merging them.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-r" data-lang="r">sameGeneNames <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">function</span>(counts) {

  <span style="color:#998;font-style:italic">## create place holder for gene names from each count matrix</span>
  gene_names <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">list</span>()

  <span style="color:#998;font-style:italic">## go through count matrices</span>
  <span style="color:#900;font-weight:bold">for </span>( i in <span style="color:#900;font-weight:bold">names</span>(counts) ) {

    <span style="color:#998;font-style:italic">## extract gene names</span>
    gene_names[[i]] <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">rownames</span>(counts[[i]])
  }

  <span style="color:#998;font-style:italic">## check if all gene names are the same (using the first matrix as a reference</span>
  <span style="color:#998;font-style:italic">## for the others)</span>
  <span style="color:#900;font-weight:bold">return</span>(<span style="color:#900;font-weight:bold">all</span>(<span style="color:#900;font-weight:bold">sapply</span>(gene_names, FUN <span style="color:#000;font-weight:bold">=</span> identical, gene_names[[1]])))
}
</code></pre></div><h4 id="table-of-ncount-and-nfeature-by-sample">Table of nCount and nFeature by sample</h4>
<p>This function outputs a table of mean and median transcripts and expressed genes for every sample in our data set.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-r" data-lang="r">averagenCountnFeature <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">function</span>(cells) {
  output <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">tibble</span>(
    <span style="color:#d14">&#39;</span><span style="color:#d14">sample&#39;</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">character</span>(),
    <span style="color:#d14">&#39;</span><span style="color:#d14">mean(nCount)&#39;</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">numeric</span>(),
    <span style="color:#d14">&#39;</span><span style="color:#d14">median(nCount)&#39;</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">numeric</span>(),
    <span style="color:#d14">&#39;</span><span style="color:#d14">mean(nFeature)&#39;</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">numeric</span>(),
    <span style="color:#d14">&#39;</span><span style="color:#d14">median(nFeature)&#39;</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">numeric</span>()
  )
  <span style="color:#900;font-weight:bold">for </span>( i in <span style="color:#900;font-weight:bold">levels</span>(cells<span style="color:#000;font-weight:bold">$</span>sample) ) {
    tmp <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">tibble</span>(
      <span style="color:#d14">&#39;</span><span style="color:#d14">sample&#39;</span> <span style="color:#000;font-weight:bold">=</span> i,
      <span style="color:#d14">&#39;</span><span style="color:#d14">mean(nCount)&#39;</span> <span style="color:#000;font-weight:bold">=</span> cells <span style="color:#000;font-weight:bold">%&gt;%</span> <span style="color:#900;font-weight:bold">filter</span>(sample <span style="color:#000;font-weight:bold">==</span> i) <span style="color:#000;font-weight:bold">%&gt;%</span> <span style="color:#900;font-weight:bold">pull</span>(nCount) <span style="color:#000;font-weight:bold">%&gt;%</span> <span style="color:#900;font-weight:bold">mean</span>(),
      <span style="color:#d14">&#39;</span><span style="color:#d14">median(nCount)&#39;</span> <span style="color:#000;font-weight:bold">=</span> cells <span style="color:#000;font-weight:bold">%&gt;%</span> <span style="color:#900;font-weight:bold">filter</span>(sample <span style="color:#000;font-weight:bold">==</span> i) <span style="color:#000;font-weight:bold">%&gt;%</span> <span style="color:#900;font-weight:bold">pull</span>(nCount) <span style="color:#000;font-weight:bold">%&gt;%</span> <span style="color:#900;font-weight:bold">median</span>(),
      <span style="color:#d14">&#39;</span><span style="color:#d14">mean(nFeature)&#39;</span> <span style="color:#000;font-weight:bold">=</span> cells <span style="color:#000;font-weight:bold">%&gt;%</span> <span style="color:#900;font-weight:bold">filter</span>(sample <span style="color:#000;font-weight:bold">==</span> i) <span style="color:#000;font-weight:bold">%&gt;%</span> <span style="color:#900;font-weight:bold">pull</span>(nFeature) <span style="color:#000;font-weight:bold">%&gt;%</span> <span style="color:#900;font-weight:bold">mean</span>(),
      <span style="color:#d14">&#39;</span><span style="color:#d14">median(nFeature)&#39;</span> <span style="color:#000;font-weight:bold">=</span> cells <span style="color:#000;font-weight:bold">%&gt;%</span> <span style="color:#900;font-weight:bold">filter</span>(sample <span style="color:#000;font-weight:bold">==</span> i) <span style="color:#000;font-weight:bold">%&gt;%</span> <span style="color:#900;font-weight:bold">pull</span>(nFeature) <span style="color:#000;font-weight:bold">%&gt;%</span> <span style="color:#900;font-weight:bold">median</span>()
    )
    output <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">bind_rows</span>(output, tmp)
  }
  <span style="color:#900;font-weight:bold">return</span>(output)
}
</code></pre></div><h3 id="create-output-directories">Create output directories</h3>
<p>Every output of this workflow is either stored in <code>data</code> or <code>plots</code>.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-r" data-lang="r"><span style="color:#900;font-weight:bold">dir.create</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">data&#39;</span>)
<span style="color:#900;font-weight:bold">dir.create</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">plots&#39;</span>)
</code></pre></div><h2 id="load-data">Load data</h2>
<p>First, we load every sample by itself using the previously specified <code>load10xData()</code> function.
We will randomly down-sample each sample to 2,000 cells for faster processing.</p>
<h3 id="sample-wise">Sample-wise</h3>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-r" data-lang="r">sample_names <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">list.dirs</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">raw_data&#39;</span>, recursive <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">FALSE</span>) <span style="color:#000;font-weight:bold">%&gt;%</span> <span style="color:#900;font-weight:bold">basename</span>()

transcripts <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">list</span>(
  raw <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">list</span>()
)

<span style="color:#900;font-weight:bold">for </span>( i in sample_names ) {
  transcripts<span style="color:#000;font-weight:bold">$</span>raw[[i]] <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">load10xData</span>(
    i, <span style="color:#900;font-weight:bold">paste0</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">raw_data/&#39;</span>, i, <span style="color:#d14">&#39;</span><span style="color:#d14">/&#39;</span>),
    max_number_of_cells <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">2000</span>
  )
}
<span style="color:#998;font-style:italic"># [2020-10-06 21:32:01] Summing up counts for 34 genes with multiple entries.</span>
<span style="color:#998;font-style:italic"># [2020-10-06 21:32:10] Loaded counts for sample A with 2,000 cells and 33,660 genes.</span>
<span style="color:#998;font-style:italic"># [2020-10-06 21:32:12] Summing up counts for 34 genes with multiple entries.</span>
<span style="color:#998;font-style:italic"># [2020-10-06 21:32:19] Loaded counts for sample B with 2,000 cells and 33,660 genes.</span>
<span style="color:#998;font-style:italic"># [2020-10-06 21:32:21] Summing up counts for 34 genes with multiple entries.</span>
<span style="color:#998;font-style:italic"># [2020-10-06 21:32:28] Loaded counts for sample E with 2,000 cells and 33,660 genes.</span>
</code></pre></div><h3 id="merge-samples">Merge samples</h3>
<p>Before being able to merge the transcript count matrices, we need to check whether the gene names are the same in each of them. This is important because if they are, then we can just glue the matrices together.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-r" data-lang="r"><span style="color:#900;font-weight:bold">checkGeneNames</span>(transcripts<span style="color:#000;font-weight:bold">$</span>raw)
<span style="color:#998;font-style:italic"># TRUE</span>
</code></pre></div><p>Since all three samples used here were generated with the same software, the gene names are the same in each of them and so we can proceed with merging them.</p>
<p>Now, we merge the transcript counts from every sample by gene name.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-r" data-lang="r">transcripts<span style="color:#000;font-weight:bold">$</span>raw<span style="color:#000;font-weight:bold">$</span>merged <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">do.call</span>(cbind, transcripts<span style="color:#000;font-weight:bold">$</span>raw)

<span style="color:#900;font-weight:bold">dim</span>(transcripts<span style="color:#000;font-weight:bold">$</span>raw<span style="color:#000;font-weight:bold">$</span>merged)
<span style="color:#998;font-style:italic"># 33660  6000</span>
</code></pre></div><p><strong>NOTE:</strong> If the gene names are not the same, there are two strategies. You can convert the transcript count matrices to data frame format and then merge them using the <code>full_join()</code> function. Depending on the size of the data set you are working with, this might result in memory issues. Alternatively, you add missing genes filled with 0 counts to the matrices that are missing the gene. Before merging, you must then make sure that the genes are in the same order.</p>
<p>Below you can find an outline of the first procedure:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-r" data-lang="r"><span style="color:#900;font-weight:bold">for </span>( i in sample_names ) {
  gene_names <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">rownames</span>(transcripts<span style="color:#000;font-weight:bold">$</span>raw[[i]])
  transcripts<span style="color:#000;font-weight:bold">$</span>raw[[i]] <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">as.data.frame</span>(<span style="color:#900;font-weight:bold">as.matrix</span>(transcripts<span style="color:#000;font-weight:bold">$</span>raw[[i]]))
  transcripts<span style="color:#000;font-weight:bold">$</span>raw[[i]] <span style="color:#000;font-weight:bold">&lt;-</span> transcripts<span style="color:#000;font-weight:bold">$</span>raw[[i]] <span style="color:#000;font-weight:bold">%&gt;%</span>
    <span style="color:#900;font-weight:bold">mutate</span>(gene <span style="color:#000;font-weight:bold">=</span> gene_names) <span style="color:#000;font-weight:bold">%&gt;%</span>
    <span style="color:#900;font-weight:bold">select</span>(gene, <span style="color:#900;font-weight:bold">everything</span>())
}

transcripts<span style="color:#000;font-weight:bold">$</span>raw<span style="color:#000;font-weight:bold">$</span>merged <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">full_join</span>(transcripts<span style="color:#000;font-weight:bold">$</span>raw<span style="color:#000;font-weight:bold">$</span>A, transcripts<span style="color:#000;font-weight:bold">$</span>raw<span style="color:#000;font-weight:bold">$</span>B, by <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;</span><span style="color:#d14">gene&#34;</span>) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">full_join</span>(., transcripts<span style="color:#000;font-weight:bold">$</span>raw<span style="color:#000;font-weight:bold">$</span>E, by <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;</span><span style="color:#d14">gene&#34;</span>)

transcripts<span style="color:#000;font-weight:bold">$</span>raw<span style="color:#000;font-weight:bold">$</span>merged[ <span style="color:#900;font-weight:bold">is.na</span>(transcripts<span style="color:#000;font-weight:bold">$</span>raw<span style="color:#000;font-weight:bold">$</span>merged) ] <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#099">0</span>
</code></pre></div><h2 id="quality-control">Quality control</h2>
<p>Before we start the analysis, we will remove low-quality cells, duplicates, as well as weakly expressed genes from the merged transcript count matrix.</p>
<h3 id="filter-cells">Filter cells</h3>
<p>We start with the cells.</p>
<h4 id="prepare-data">Prepare data</h4>
<p>First, we collect the transcript count, expressed genes per cell, and percentage of mitochondrial transcripts per cell.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-r" data-lang="r">cells <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">tibble</span>(
  cell <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">colnames</span>(transcripts<span style="color:#000;font-weight:bold">$</span>raw<span style="color:#000;font-weight:bold">$</span>merged),
  sample <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">colnames</span>(transcripts<span style="color:#000;font-weight:bold">$</span>raw<span style="color:#000;font-weight:bold">$</span>merged) <span style="color:#000;font-weight:bold">%&gt;%</span>
    <span style="color:#900;font-weight:bold">strsplit</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">-&#39;</span>) <span style="color:#000;font-weight:bold">%&gt;%</span>
    <span style="color:#900;font-weight:bold">vapply</span>(FUN.VALUE <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">character</span>(<span style="color:#099">1</span>), `[`, <span style="color:#099">2</span>) <span style="color:#000;font-weight:bold">%&gt;%</span>
    <span style="color:#900;font-weight:bold">factor</span>(levels <span style="color:#000;font-weight:bold">=</span> sample_names),
  nCount <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">colSums</span>(transcripts<span style="color:#000;font-weight:bold">$</span>raw<span style="color:#000;font-weight:bold">$</span>merged),
  nFeature <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">colSums</span>(transcripts<span style="color:#000;font-weight:bold">$</span>raw<span style="color:#000;font-weight:bold">$</span>merged <span style="color:#000;font-weight:bold">!=</span> <span style="color:#099">0</span>)
)

<span style="color:#900;font-weight:bold">DataFrame</span>(cells)
<span style="color:#998;font-style:italic"># DataFrame with 6000 rows and 4 columns</span>
<span style="color:#998;font-style:italic">#                    cell   sample    nCount  nFeature</span>
<span style="color:#998;font-style:italic">#             &lt;character&gt; &lt;factor&gt; &lt;numeric&gt; &lt;integer&gt;</span>
<span style="color:#998;font-style:italic"># 1    AGTAGTCAGCTAAACA-A        A     11915       557</span>
<span style="color:#998;font-style:italic"># 2    GCAAACTGTGTGCCTG-A        A      4745      1018</span>
<span style="color:#998;font-style:italic"># 3    TTGGCAAAGGCAAAGA-A        A      4205      1027</span>
<span style="color:#998;font-style:italic"># 4    CTACACCTCAACGAAA-A        A     11593       633</span>
<span style="color:#998;font-style:italic"># 5    AGCCTAACAAGGTTCT-A        A      4756      1298</span>
<span style="color:#998;font-style:italic"># ...                 ...      ...       ...       ...</span>
<span style="color:#998;font-style:italic"># 5996 CCACCTAGTTAAAGAC-E        E      4941      1442</span>
<span style="color:#998;font-style:italic"># 5997 AGGGAGTTCCTGTAGA-E        E      2405       699</span>
<span style="color:#998;font-style:italic"># 5998 CATTCGCAGGTACTCT-E        E      2262       888</span>
<span style="color:#998;font-style:italic"># 5999 TGATTTCAGGCTCAGA-E        E      2150       733</span>
<span style="color:#998;font-style:italic"># 6000 CAGCTGGGTTATCGGT-E        E     21167      4030</span>

mitochondrial_genes_here <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">read_tsv</span>(
    <span style="color:#900;font-weight:bold">system.file</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">extdata/genes_mt_hg_name.tsv.gz&#39;</span>, package <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">cerebroApp&#39;</span>),
    col_names <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">FALSE</span>
  ) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">filter</span>(X1 <span style="color:#000;font-weight:bold">%in%</span> <span style="color:#900;font-weight:bold">rownames</span>(transcripts<span style="color:#000;font-weight:bold">$</span>raw<span style="color:#000;font-weight:bold">$</span>merged)) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">pull</span>(X1)

cells<span style="color:#000;font-weight:bold">$</span>percent_MT <span style="color:#000;font-weight:bold">&lt;-</span> Matrix<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">colSums</span>(transcripts<span style="color:#000;font-weight:bold">$</span>raw<span style="color:#000;font-weight:bold">$</span>merged[mitochondrial_genes_here,]) <span style="color:#000;font-weight:bold">/</span> Matrix<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">colSums</span>(transcripts<span style="color:#000;font-weight:bold">$</span>raw<span style="color:#000;font-weight:bold">$</span>merged)

<span style="color:#900;font-weight:bold">DataFrame</span>(cells)
<span style="color:#998;font-style:italic"># DataFrame with 6000 rows and 5 columns</span>
<span style="color:#998;font-style:italic">#                    cell   sample    nCount  nFeature percent_MT</span>
<span style="color:#998;font-style:italic">#             &lt;character&gt; &lt;factor&gt; &lt;numeric&gt; &lt;integer&gt;  &lt;numeric&gt;</span>
<span style="color:#998;font-style:italic"># 1    AGTAGTCAGCTAAACA-A        A     11915       557 0.00260176</span>
<span style="color:#998;font-style:italic"># 2    GCAAACTGTGTGCCTG-A        A      4745      1018 0.02971549</span>
<span style="color:#998;font-style:italic"># 3    TTGGCAAAGGCAAAGA-A        A      4205      1027 0.02354340</span>
<span style="color:#998;font-style:italic"># 4    CTACACCTCAACGAAA-A        A     11593       633 0.00517554</span>
<span style="color:#998;font-style:italic"># 5    AGCCTAACAAGGTTCT-A        A      4756      1298 0.06391926</span>
<span style="color:#998;font-style:italic"># ...                 ...      ...       ...       ...        ...</span>
<span style="color:#998;font-style:italic"># 5996 CCACCTAGTTAAAGAC-E        E      4941      1442  0.0333940</span>
<span style="color:#998;font-style:italic"># 5997 AGGGAGTTCCTGTAGA-E        E      2405       699  0.0191268</span>
<span style="color:#998;font-style:italic"># 5998 CATTCGCAGGTACTCT-E        E      2262       888  0.0539346</span>
<span style="color:#998;font-style:italic"># 5999 TGATTTCAGGCTCAGA-E        E      2150       733  0.0232558</span>
<span style="color:#998;font-style:italic"># 6000 CAGCTGGGTTATCGGT-E        E     21167      4030  0.0313223</span>
</code></pre></div><p>We use our <code>averagenCountnFeature()</code> function to get an idea of the metrics per sample.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-r" data-lang="r"><span style="color:#900;font-weight:bold">averagenCountnFeature</span>(cells) <span style="color:#000;font-weight:bold">%&gt;%</span> knitr<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">kable</span>()
</code></pre></div><table>
<thead>
<tr>
<th align="left">sample</th>
<th align="right">mean(nCount)</th>
<th align="right">median(nCount)</th>
<th align="right">mean(nFeature)</th>
<th align="right">median(nFeature)</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">A</td>
<td align="right">9477.411</td>
<td align="right">6277.5</td>
<td align="right">1646.2530</td>
<td align="right">1307.5</td>
</tr>
<tr>
<td align="left">B</td>
<td align="right">5164.258</td>
<td align="right">3048.5</td>
<td align="right">1082.4145</td>
<td align="right">789.0</td>
</tr>
<tr>
<td align="left">E</td>
<td align="right">4362.592</td>
<td align="right">3477.0</td>
<td align="right">647.6505</td>
<td align="right">583.0</td>
</tr>
</tbody>
</table>
<h4 id="doublets">Doublets</h4>
<p>To identify doublets, we will use the <a href="https://bioconductor.org/packages/release/bioc/html/scDblFinder.html"><code>scDblFinder</code></a> package.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-r" data-lang="r">sce <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">SingleCellExperiment</span>(assays <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">list</span>(counts <span style="color:#000;font-weight:bold">=</span> transcripts<span style="color:#000;font-weight:bold">$</span>raw<span style="color:#000;font-weight:bold">$</span>merged))
sce <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">scDblFinder</span>(sce)

cells<span style="color:#000;font-weight:bold">$</span>multiplet_class <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">colData</span>(sce)<span style="color:#000;font-weight:bold">$</span>scDblFinder.class
</code></pre></div><p>How many doublets do we find in each sample?</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-r" data-lang="r">p <span style="color:#000;font-weight:bold">&lt;-</span> cells <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">filter</span>(multiplet_class <span style="color:#000;font-weight:bold">!=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">singlet&#39;</span>) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">group_by</span>(sample) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">summarize</span>(count <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">n</span>()) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">ggplot</span>(<span style="color:#900;font-weight:bold">aes</span>(x <span style="color:#000;font-weight:bold">=</span> sample, y <span style="color:#000;font-weight:bold">=</span> count, fill <span style="color:#000;font-weight:bold">=</span> sample)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_col</span>(color <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">black&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme_bw</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_fill_manual</span>(values <span style="color:#000;font-weight:bold">=</span> custom_colors<span style="color:#000;font-weight:bold">$</span>discrete) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_x_discrete</span>(limits <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">rev</span>(<span style="color:#900;font-weight:bold">levels</span>(cells<span style="color:#000;font-weight:bold">$</span>sample))) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_y_continuous</span>(name <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Number of doublets&#39;</span>, labels <span style="color:#000;font-weight:bold">=</span> scales<span style="color:#000;font-weight:bold">::</span>comma) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme</span>(
    axis.title.y <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    panel.grid.major.y <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    panel.grid.minor.y <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    legend.position <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">none&#39;</span>
  ) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">coord_flip</span>()

<span style="color:#900;font-weight:bold">ggsave</span>(
  <span style="color:#d14">&#39;</span><span style="color:#d14">plots/qc_number_of_doublets_by_sample.png&#39;</span>,
  p, height <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">3</span>, width <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">6</span>
)
</code></pre></div>
<figure >
  
    <a href="/images/projects/scrnaseq_workflow/qc_number_of_doublets_by_sample.png" target="_blank">
      <img src="/images/projects/scrnaseq_workflow/qc_number_of_doublets_by_sample.jpg"  style="width: 100%; max-width: 1000px" />
    </a>
  
  
</figure>


<p>Below we see the distribution of <code>nCount</code> and <code>nFeature</code> by the multiplet class.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-r" data-lang="r">p1 <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">ggplot</span>(cells, <span style="color:#900;font-weight:bold">aes</span>(x <span style="color:#000;font-weight:bold">=</span> multiplet_class, y <span style="color:#000;font-weight:bold">=</span> nCount, fill <span style="color:#000;font-weight:bold">=</span> multiplet_class)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_violin</span>(draw_quantiles <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">c</span>(<span style="color:#099">0.5</span>), scale <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">area&#39;</span>, trim <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">FALSE</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme_bw</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_fill_manual</span>(values <span style="color:#000;font-weight:bold">=</span> custom_colors<span style="color:#000;font-weight:bold">$</span>discrete) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_x_discrete</span>(limits <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">rev</span>(<span style="color:#900;font-weight:bold">levels</span>(cells<span style="color:#000;font-weight:bold">$</span>multiplet_class))) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_y_continuous</span>(labels <span style="color:#000;font-weight:bold">=</span> scales<span style="color:#000;font-weight:bold">::</span>comma) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">labs</span>(title <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Number of transcripts&#39;</span>, subtitle <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">linear scale&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme</span>(
    axis.title <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    panel.grid.major.y <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    panel.grid.minor.y <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    legend.position <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">none&#39;</span>
  ) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">coord_flip</span>()
p2 <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">ggplot</span>(cells, <span style="color:#900;font-weight:bold">aes</span>(x <span style="color:#000;font-weight:bold">=</span> multiplet_class, y <span style="color:#000;font-weight:bold">=</span> nCount, fill <span style="color:#000;font-weight:bold">=</span> multiplet_class)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_violin</span>(draw_quantiles <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">c</span>(<span style="color:#099">0.5</span>), scale <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">area&#39;</span>, trim <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">FALSE</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme_bw</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_fill_manual</span>(values <span style="color:#000;font-weight:bold">=</span> custom_colors<span style="color:#000;font-weight:bold">$</span>discrete) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_x_discrete</span>(limits <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">rev</span>(<span style="color:#900;font-weight:bold">levels</span>(cells<span style="color:#000;font-weight:bold">$</span>multiplet_class))) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_y_log10</span>(labels <span style="color:#000;font-weight:bold">=</span> scales<span style="color:#000;font-weight:bold">::</span>comma) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">labs</span>(title <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Number of transcripts&#39;</span>, subtitle <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">log-scale&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme</span>(
    axis.title <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    panel.grid.major.y <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    panel.grid.minor.y <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    legend.position <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">none&#39;</span>
  ) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">coord_flip</span>()
p3 <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">ggplot</span>(cells, <span style="color:#900;font-weight:bold">aes</span>(x <span style="color:#000;font-weight:bold">=</span> multiplet_class, y <span style="color:#000;font-weight:bold">=</span> nFeature, fill <span style="color:#000;font-weight:bold">=</span> multiplet_class)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_violin</span>(draw_quantiles <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">c</span>(<span style="color:#099">0.5</span>), scale <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">area&#39;</span>, trim <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">FALSE</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme_bw</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_fill_manual</span>(values <span style="color:#000;font-weight:bold">=</span> custom_colors<span style="color:#000;font-weight:bold">$</span>discrete) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_x_discrete</span>(limits <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">rev</span>(<span style="color:#900;font-weight:bold">levels</span>(cells<span style="color:#000;font-weight:bold">$</span>multiplet_class))) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_y_continuous</span>(labels <span style="color:#000;font-weight:bold">=</span> scales<span style="color:#000;font-weight:bold">::</span>comma) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">labs</span>(title <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Number of expressed genes&#39;</span>, subtitle <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">linear scale&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme</span>(
    axis.title <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    panel.grid.major.y <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    panel.grid.minor.y <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    legend.position <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">none&#39;</span>
  ) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">coord_flip</span>()
p4 <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">ggplot</span>(cells, <span style="color:#900;font-weight:bold">aes</span>(x <span style="color:#000;font-weight:bold">=</span> multiplet_class, y <span style="color:#000;font-weight:bold">=</span> nFeature, fill <span style="color:#000;font-weight:bold">=</span> multiplet_class)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_violin</span>(draw_quantiles <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">c</span>(<span style="color:#099">0.5</span>), scale <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">area&#39;</span>, trim <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">FALSE</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme_bw</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_fill_manual</span>(values <span style="color:#000;font-weight:bold">=</span> custom_colors<span style="color:#000;font-weight:bold">$</span>discrete) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_x_discrete</span>(limits <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">rev</span>(<span style="color:#900;font-weight:bold">levels</span>(cells<span style="color:#000;font-weight:bold">$</span>multiplet_class))) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_y_log10</span>(labels <span style="color:#000;font-weight:bold">=</span> scales<span style="color:#000;font-weight:bold">::</span>comma) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">labs</span>(title <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Number of expressed genes&#39;</span>, subtitle <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">log-scale&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme</span>(
    axis.title <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    panel.grid.major.y <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    panel.grid.minor.y <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    legend.position <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">none&#39;</span>
  ) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">coord_flip</span>()

<span style="color:#900;font-weight:bold">ggsave</span>(
  <span style="color:#d14">&#39;</span><span style="color:#d14">plots/qc_nCount_nFeature_by_multiplet_class.png&#39;</span>,
  p1 <span style="color:#000;font-weight:bold">+</span> p3 <span style="color:#000;font-weight:bold">+</span>
  p2 <span style="color:#000;font-weight:bold">+</span> p4 <span style="color:#000;font-weight:bold">+</span> <span style="color:#900;font-weight:bold">plot_layout</span>(ncol <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">2</span>),
  height <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">7</span>, width <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">10</span>
)
</code></pre></div>
<figure >
  
    <a href="/images/projects/scrnaseq_workflow/qc_nCount_nFeature_by_multiplet_class.png" target="_blank">
      <img src="/images/projects/scrnaseq_workflow/qc_nCount_nFeature_by_multiplet_class.jpg"  style="width: 100%; max-width: 1000px" />
    </a>
  
  
</figure>


<p>Now, we remove the doublets.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-r" data-lang="r">cells <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">filter</span>(cells, multiplet_class <span style="color:#000;font-weight:bold">==</span> <span style="color:#d14">&#39;</span><span style="color:#d14">singlet&#39;</span>)
</code></pre></div><h4 id="before-filtering">Before filtering</h4>
<p>Before removing any cell, let's look at the distribution of transcript count, expressed genes per cell, and percentage of mitochondrial transcripts per cell.
These distributions can be represented in different ways.
Which of them looks best depends on taste and dataset.</p>


<div class="tabs">
  <input type="radio" name="qc_1" id="qc_1_1" checked="checked">
  <label for="qc_1_1">Option 1</label>
  <div class="tab">


<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-r" data-lang="r">p1 <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">ggplot</span>(cells, <span style="color:#900;font-weight:bold">aes</span>(x <span style="color:#000;font-weight:bold">=</span> sample, y <span style="color:#000;font-weight:bold">=</span> nCount, fill <span style="color:#000;font-weight:bold">=</span> sample)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_violin</span>(draw_quantiles <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">c</span>(<span style="color:#099">0.5</span>), scale <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">area&#39;</span>, trim <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">FALSE</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme_bw</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_fill_manual</span>(values <span style="color:#000;font-weight:bold">=</span> custom_colors<span style="color:#000;font-weight:bold">$</span>discrete) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_x_discrete</span>(limits <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">rev</span>(<span style="color:#900;font-weight:bold">levels</span>(cells<span style="color:#000;font-weight:bold">$</span>sample))) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_y_continuous</span>(labels <span style="color:#000;font-weight:bold">=</span> scales<span style="color:#000;font-weight:bold">::</span>comma) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">labs</span>(title <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Number of transcripts&#39;</span>, subtitle <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">linear scale&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme</span>(
    axis.title <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    panel.grid.major.y <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    panel.grid.minor.y <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    legend.position <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">none&#39;</span>
  ) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">coord_flip</span>()

p2 <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">ggplot</span>(cells, <span style="color:#900;font-weight:bold">aes</span>(x <span style="color:#000;font-weight:bold">=</span> sample, y <span style="color:#000;font-weight:bold">=</span> nCount, fill <span style="color:#000;font-weight:bold">=</span> sample)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_violin</span>(draw_quantiles <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">c</span>(<span style="color:#099">0.5</span>), scale <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">area&#39;</span>, trim <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">FALSE</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme_bw</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_fill_manual</span>(values <span style="color:#000;font-weight:bold">=</span> custom_colors<span style="color:#000;font-weight:bold">$</span>discrete) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_x_discrete</span>(limits <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">rev</span>(<span style="color:#900;font-weight:bold">levels</span>(cells<span style="color:#000;font-weight:bold">$</span>sample))) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_y_log10</span>(labels <span style="color:#000;font-weight:bold">=</span> scales<span style="color:#000;font-weight:bold">::</span>comma) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">labs</span>(title <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Number of transcripts&#39;</span>, subtitle <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">log-scale&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme</span>(
    axis.title <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    panel.grid.major.y <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    panel.grid.minor.y <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    legend.position <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">none&#39;</span>
  ) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">coord_flip</span>()

p3 <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">ggplot</span>(cells, <span style="color:#900;font-weight:bold">aes</span>(x <span style="color:#000;font-weight:bold">=</span> sample, y <span style="color:#000;font-weight:bold">=</span> nFeature, fill <span style="color:#000;font-weight:bold">=</span> sample)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_violin</span>(draw_quantiles <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">c</span>(<span style="color:#099">0.5</span>), scale <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">area&#39;</span>, trim <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">FALSE</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme_bw</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_fill_manual</span>(values <span style="color:#000;font-weight:bold">=</span> custom_colors<span style="color:#000;font-weight:bold">$</span>discrete) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_x_discrete</span>(limits <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">rev</span>(<span style="color:#900;font-weight:bold">levels</span>(cells<span style="color:#000;font-weight:bold">$</span>sample))) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_y_continuous</span>(labels <span style="color:#000;font-weight:bold">=</span> scales<span style="color:#000;font-weight:bold">::</span>comma) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">labs</span>(title <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Number of expressed genes&#39;</span>, subtitle <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">linear scale&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme</span>(
    axis.title <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    panel.grid.major.y <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    panel.grid.minor.y <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    legend.position <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">none&#39;</span>
  ) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">coord_flip</span>()

p4 <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">ggplot</span>(cells, <span style="color:#900;font-weight:bold">aes</span>(x <span style="color:#000;font-weight:bold">=</span> sample, y <span style="color:#000;font-weight:bold">=</span> nFeature, fill <span style="color:#000;font-weight:bold">=</span> sample)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_violin</span>(draw_quantiles <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">c</span>(<span style="color:#099">0.5</span>), scale <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">area&#39;</span>, trim <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">FALSE</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme_bw</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_fill_manual</span>(values <span style="color:#000;font-weight:bold">=</span> custom_colors<span style="color:#000;font-weight:bold">$</span>discrete) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_x_discrete</span>(limits <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">rev</span>(<span style="color:#900;font-weight:bold">levels</span>(cells<span style="color:#000;font-weight:bold">$</span>sample))) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_y_log10</span>(labels <span style="color:#000;font-weight:bold">=</span> scales<span style="color:#000;font-weight:bold">::</span>comma) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">labs</span>(title <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Number of expressed genes&#39;</span>, subtitle <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">log-scale&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme</span>(
    axis.title <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    panel.grid.major.y <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    panel.grid.minor.y <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    legend.position <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">none&#39;</span>
  ) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">coord_flip</span>()

p5 <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">ggplot</span>(cells, <span style="color:#900;font-weight:bold">aes</span>(x <span style="color:#000;font-weight:bold">=</span> sample, y <span style="color:#000;font-weight:bold">=</span> percent_MT, fill <span style="color:#000;font-weight:bold">=</span> sample)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_violin</span>(draw_quantiles <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">c</span>(<span style="color:#099">0.5</span>), scale <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">area&#39;</span>, trim <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">FALSE</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme_bw</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_fill_manual</span>(values <span style="color:#000;font-weight:bold">=</span> custom_colors<span style="color:#000;font-weight:bold">$</span>discrete) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_x_discrete</span>(limits <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">rev</span>(<span style="color:#900;font-weight:bold">levels</span>(cells<span style="color:#000;font-weight:bold">$</span>sample))) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_y_continuous</span>(labels <span style="color:#000;font-weight:bold">=</span> scales<span style="color:#000;font-weight:bold">::</span>percent) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">labs</span>(title <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Percent MT transcripts&#39;</span>, subtitle <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">linear scale&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme</span>(
    axis.title <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    panel.grid.major.y <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    panel.grid.minor.y <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    legend.position <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">none&#39;</span>
  ) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">coord_flip</span>()

<span style="color:#900;font-weight:bold">ggsave</span>(
  <span style="color:#d14">&#39;</span><span style="color:#d14">plots/qc_histogram_nCount_nFeature_percentMT_before_filtering_1.png&#39;</span>,
  p1 <span style="color:#000;font-weight:bold">+</span> p3 <span style="color:#000;font-weight:bold">+</span> p5 <span style="color:#000;font-weight:bold">+</span>
  p2 <span style="color:#000;font-weight:bold">+</span> p4 <span style="color:#000;font-weight:bold">+</span> <span style="color:#900;font-weight:bold">plot_layout</span>(ncol <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">3</span>),
  height <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">7</span>, width <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">10</span>
)
</code></pre></div>
<figure >
  
    <a href="/images/projects/scrnaseq_workflow/qc_histogram_nCount_nFeature_percentMT_before_filtering_1.png" target="_blank">
      <img src="/images/projects/scrnaseq_workflow/qc_histogram_nCount_nFeature_percentMT_before_filtering_1.jpg"  style="width: 100%; max-width: 1000px" />
    </a>
  
  
</figure>




  </div>
  <input type="radio" name="qc_1" id="qc_1_2">
  <label for="qc_1_2">Option 2</label>
  <div class="tab">


<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-r" data-lang="r">p1 <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">ggplot</span>(cells, <span style="color:#900;font-weight:bold">aes</span>(x <span style="color:#000;font-weight:bold">=</span> sample, y <span style="color:#000;font-weight:bold">=</span> nCount, fill <span style="color:#000;font-weight:bold">=</span> sample)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_violin</span>(draw_quantiles <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">c</span>(<span style="color:#099">0.5</span>), scale <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">area&#39;</span>, trim <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">FALSE</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme_bw</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_fill_manual</span>(values <span style="color:#000;font-weight:bold">=</span> custom_colors<span style="color:#000;font-weight:bold">$</span>discrete) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_y_continuous</span>(labels <span style="color:#000;font-weight:bold">=</span> scales<span style="color:#000;font-weight:bold">::</span>comma) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">labs</span>(title <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Number of transcripts&#39;</span>, subtitle <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">linear scale&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme</span>(
    axis.title <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    panel.grid.major.x <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    panel.grid.minor.x <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    legend.position <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">none&#39;</span>
  )

p2 <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">ggplot</span>(cells, <span style="color:#900;font-weight:bold">aes</span>(x <span style="color:#000;font-weight:bold">=</span> sample, y <span style="color:#000;font-weight:bold">=</span> nCount, fill <span style="color:#000;font-weight:bold">=</span> sample)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_violin</span>(draw_quantiles <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">c</span>(<span style="color:#099">0.5</span>), scale <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">area&#39;</span>, trim <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">FALSE</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme_bw</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_fill_manual</span>(values <span style="color:#000;font-weight:bold">=</span> custom_colors<span style="color:#000;font-weight:bold">$</span>discrete) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_y_log10</span>(labels <span style="color:#000;font-weight:bold">=</span> scales<span style="color:#000;font-weight:bold">::</span>comma) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">labs</span>(title <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Number of transcripts&#39;</span>, subtitle <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">log-scale&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme</span>(
    axis.title <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    panel.grid.major.x <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    panel.grid.minor.x <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    legend.position <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">none&#39;</span>
  )

p3 <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">ggplot</span>(cells, <span style="color:#900;font-weight:bold">aes</span>(x <span style="color:#000;font-weight:bold">=</span> sample, y <span style="color:#000;font-weight:bold">=</span> nFeature, fill <span style="color:#000;font-weight:bold">=</span> sample)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_violin</span>(draw_quantiles <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">c</span>(<span style="color:#099">0.5</span>), scale <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">area&#39;</span>, trim <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">FALSE</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme_bw</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_fill_manual</span>(values <span style="color:#000;font-weight:bold">=</span> custom_colors<span style="color:#000;font-weight:bold">$</span>discrete) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_y_continuous</span>(labels <span style="color:#000;font-weight:bold">=</span> scales<span style="color:#000;font-weight:bold">::</span>comma) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">labs</span>(title <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Number of expressed genes&#39;</span>, subtitle <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">linear scale&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme</span>(
    axis.title <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    panel.grid.major.x <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    panel.grid.minor.x <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    legend.position <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">none&#39;</span>
  )

p4 <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">ggplot</span>(cells, <span style="color:#900;font-weight:bold">aes</span>(x <span style="color:#000;font-weight:bold">=</span> sample, y <span style="color:#000;font-weight:bold">=</span> nFeature, fill <span style="color:#000;font-weight:bold">=</span> sample)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_violin</span>(draw_quantiles <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">c</span>(<span style="color:#099">0.5</span>), scale <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">area&#39;</span>, trim <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">FALSE</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme_bw</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_fill_manual</span>(values <span style="color:#000;font-weight:bold">=</span> custom_colors<span style="color:#000;font-weight:bold">$</span>discrete) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_y_log10</span>(labels <span style="color:#000;font-weight:bold">=</span> scales<span style="color:#000;font-weight:bold">::</span>comma) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">labs</span>(title <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Number of expressed genes&#39;</span>, subtitle <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">log-scale&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme</span>(
    axis.title <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    panel.grid.major.x <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    panel.grid.minor.x <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    legend.position <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">none&#39;</span>
  )

p5 <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">ggplot</span>(cells, <span style="color:#900;font-weight:bold">aes</span>(x <span style="color:#000;font-weight:bold">=</span> sample, y <span style="color:#000;font-weight:bold">=</span> percent_MT, fill <span style="color:#000;font-weight:bold">=</span> sample)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_violin</span>(draw_quantiles <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">c</span>(<span style="color:#099">0.5</span>), scale <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">area&#39;</span>, trim <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">FALSE</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme_bw</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_fill_manual</span>(values <span style="color:#000;font-weight:bold">=</span> custom_colors<span style="color:#000;font-weight:bold">$</span>discrete) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_y_continuous</span>(labels <span style="color:#000;font-weight:bold">=</span> scales<span style="color:#000;font-weight:bold">::</span>percent) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">labs</span>(title <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Percent MT transcripts&#39;</span>, subtitle <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">linear scale&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme</span>(
    axis.title <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    panel.grid.major.x <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    panel.grid.minor.x <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    legend.position <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">none&#39;</span>
  )

<span style="color:#900;font-weight:bold">ggsave</span>(
  <span style="color:#d14">&#39;</span><span style="color:#d14">plots/qc_histogram_nCount_nFeature_percentMT_before_filtering_2.png&#39;</span>,
  p1 <span style="color:#000;font-weight:bold">+</span> p3 <span style="color:#000;font-weight:bold">+</span> p5 <span style="color:#000;font-weight:bold">+</span>
  p2 <span style="color:#000;font-weight:bold">+</span> p4 <span style="color:#000;font-weight:bold">+</span> <span style="color:#900;font-weight:bold">plot_layout</span>(ncol <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">3</span>),
  height <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">7</span>, width <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">10</span>
)
</code></pre></div>
<figure >
  
    <a href="/images/projects/scrnaseq_workflow/qc_histogram_nCount_nFeature_percentMT_before_filtering_2.png" target="_blank">
      <img src="/images/projects/scrnaseq_workflow/qc_histogram_nCount_nFeature_percentMT_before_filtering_2.jpg"  style="width: 100%; max-width: 1000px" />
    </a>
  
  
</figure>




  </div>
  <input type="radio" name="qc_1" id="qc_1_3">
  <label for="qc_1_3">Option 3</label>
  <div class="tab">


<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-r" data-lang="r">p1 <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">ggplot</span>(cells, <span style="color:#900;font-weight:bold">aes</span>(nCount, fill <span style="color:#000;font-weight:bold">=</span> sample)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_histogram</span>(bins <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">200</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme_bw</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_fill_manual</span>(values <span style="color:#000;font-weight:bold">=</span> custom_colors<span style="color:#000;font-weight:bold">$</span>discrete) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_x_continuous</span>(labels <span style="color:#000;font-weight:bold">=</span> scales<span style="color:#000;font-weight:bold">::</span>comma) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">labs</span>(title <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Number of transcripts&#39;</span>, subtitle <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">linear scale&#39;</span>, y <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Number of cells&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme</span>(legend.position <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">none&#39;</span>, axis.title.x <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>())

p2 <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">ggplot</span>(cells, <span style="color:#900;font-weight:bold">aes</span>(nCount, fill <span style="color:#000;font-weight:bold">=</span> sample)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_histogram</span>(bins <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">200</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme_bw</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_fill_manual</span>(values <span style="color:#000;font-weight:bold">=</span> custom_colors<span style="color:#000;font-weight:bold">$</span>discrete) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_x_log10</span>(labels <span style="color:#000;font-weight:bold">=</span> scales<span style="color:#000;font-weight:bold">::</span>comma) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">labs</span>(title <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Number of transcripts&#39;</span>, subtitle <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">log-scale&#39;</span>, y <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Number of cells&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme</span>(legend.position <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">none&#39;</span>, axis.title.x <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>())

p3 <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">ggplot</span>(cells, <span style="color:#900;font-weight:bold">aes</span>(nFeature, fill <span style="color:#000;font-weight:bold">=</span> sample)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_histogram</span>(bins <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">200</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme_bw</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_fill_manual</span>(values <span style="color:#000;font-weight:bold">=</span> custom_colors<span style="color:#000;font-weight:bold">$</span>discrete) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_x_continuous</span>(labels <span style="color:#000;font-weight:bold">=</span> scales<span style="color:#000;font-weight:bold">::</span>comma) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">labs</span>(title <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Number of expressed genes&#39;</span>, subtitle <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">linear scale&#39;</span>, y <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Number of cells&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme</span>(legend.position <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">none&#39;</span>,axis.title.x <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>())

p4 <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">ggplot</span>(cells, <span style="color:#900;font-weight:bold">aes</span>(nFeature, fill <span style="color:#000;font-weight:bold">=</span> sample)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_histogram</span>(bins <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">200</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme_bw</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_fill_manual</span>(values <span style="color:#000;font-weight:bold">=</span> custom_colors<span style="color:#000;font-weight:bold">$</span>discrete) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_x_log10</span>(labels <span style="color:#000;font-weight:bold">=</span> scales<span style="color:#000;font-weight:bold">::</span>comma) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">labs</span>(title <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Number of expressed genes&#39;</span>, subtitle <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">log-scale&#39;</span>, y <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Number of cells&#39;</span>, fill <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Sample&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme</span>(legend.position <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">none&#39;</span>, axis.title.x <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>())

p5 <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">ggplot</span>(cells, <span style="color:#900;font-weight:bold">aes</span>(percent_MT, fill <span style="color:#000;font-weight:bold">=</span> sample)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_histogram</span>(bins <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">200</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme_bw</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_x_continuous</span>(labels <span style="color:#000;font-weight:bold">=</span> scales<span style="color:#000;font-weight:bold">::</span>percent) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_fill_manual</span>(name <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Sample&#39;</span>, values <span style="color:#000;font-weight:bold">=</span> custom_colors<span style="color:#000;font-weight:bold">$</span>discrete) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">labs</span>(title <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Percent MT transcripts&#39;</span>, subtitle <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">linear scale&#39;</span>, y <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Number of cells&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme</span>(legend.position <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">right&#39;</span>, axis.title.x <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(), legend.text <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_text</span>(size <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">8</span>))

<span style="color:#900;font-weight:bold">ggsave</span>(
  <span style="color:#d14">&#39;</span><span style="color:#d14">plots/qc_histogram_nCount_nFeature_percentMT_before_filtering_3.png&#39;</span>,
  p1 <span style="color:#000;font-weight:bold">+</span> p3 <span style="color:#000;font-weight:bold">+</span> p5 <span style="color:#000;font-weight:bold">+</span>
  p2 <span style="color:#000;font-weight:bold">+</span> p4 <span style="color:#000;font-weight:bold">+</span> <span style="color:#900;font-weight:bold">plot_layout</span>(ncol <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">3</span>),
  height <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">7</span>, width <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">10</span>
)
</code></pre></div>
<figure >
  
    <a href="/images/projects/scrnaseq_workflow/qc_histogram_nCount_nFeature_percentMT_before_filtering_3.png" target="_blank">
      <img src="/images/projects/scrnaseq_workflow/qc_histogram_nCount_nFeature_percentMT_before_filtering_3.jpg"  style="width: 100%; max-width: 1000px" />
    </a>
  
  
</figure>




  </div>
  <input type="radio" name="qc_1" id="qc_1_4">
  <label for="qc_1_4">Option 4</label>
  <div class="tab">


<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-r" data-lang="r">p1 <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">ggplot</span>(cells, <span style="color:#900;font-weight:bold">aes</span>(x <span style="color:#000;font-weight:bold">=</span> nCount, y <span style="color:#000;font-weight:bold">=</span> sample, fill <span style="color:#000;font-weight:bold">=</span> sample)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_density_ridges</span>(rel_min_height <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0.01</span>, scale <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0.9</span>, alpha <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0.8</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme_ridges</span>(center <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">TRUE</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_fill_manual</span>(values <span style="color:#000;font-weight:bold">=</span> custom_colors<span style="color:#000;font-weight:bold">$</span>discrete) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_x_continuous</span>(labels <span style="color:#000;font-weight:bold">=</span> scales<span style="color:#000;font-weight:bold">::</span>comma) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_y_discrete</span>(expand <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">c</span>(<span style="color:#099">0.01</span>, <span style="color:#099">0</span>)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">labs</span>(title <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Number of transcripts&#39;</span>, subtitle <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">linear scale&#39;</span>, y <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Density&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme</span>(legend.position <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">none&#39;</span>, axis.title.x <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>())

p2 <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">ggplot</span>(cells, <span style="color:#900;font-weight:bold">aes</span>(x <span style="color:#000;font-weight:bold">=</span> nCount, y <span style="color:#000;font-weight:bold">=</span> sample, fill <span style="color:#000;font-weight:bold">=</span> sample)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_density_ridges</span>(rel_min_height <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0.01</span>, scale <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0.9</span>, alpha <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0.8</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme_ridges</span>(center <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">TRUE</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_fill_manual</span>(values <span style="color:#000;font-weight:bold">=</span> custom_colors<span style="color:#000;font-weight:bold">$</span>discrete) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_x_log10</span>(labels <span style="color:#000;font-weight:bold">=</span> scales<span style="color:#000;font-weight:bold">::</span>comma) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_y_discrete</span>(expand <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">c</span>(<span style="color:#099">0.01</span>, <span style="color:#099">0</span>)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">labs</span>(title <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Number of transcripts&#39;</span>, subtitle <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">log-scale&#39;</span>, y <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Density&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme</span>(legend.position <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">none&#39;</span>, axis.title.x <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>())

p3 <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">ggplot</span>(cells, <span style="color:#900;font-weight:bold">aes</span>(x <span style="color:#000;font-weight:bold">=</span> nFeature, y <span style="color:#000;font-weight:bold">=</span> sample, fill <span style="color:#000;font-weight:bold">=</span> sample)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_density_ridges</span>(rel_min_height <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0.01</span>, scale <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0.9</span>, alpha <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0.8</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme_ridges</span>(center <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">TRUE</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_fill_manual</span>(values <span style="color:#000;font-weight:bold">=</span> custom_colors<span style="color:#000;font-weight:bold">$</span>discrete) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_x_continuous</span>(labels <span style="color:#000;font-weight:bold">=</span> scales<span style="color:#000;font-weight:bold">::</span>comma) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_y_discrete</span>(expand <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">c</span>(<span style="color:#099">0.01</span>, <span style="color:#099">0</span>)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">labs</span>(title <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Number of expressed genes&#39;</span>, subtitle <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">linear scale&#39;</span>, y <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Density&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme</span>(legend.position <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">none&#39;</span>, axis.title.x <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>())

p4 <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">ggplot</span>(cells, <span style="color:#900;font-weight:bold">aes</span>(x <span style="color:#000;font-weight:bold">=</span> nFeature, y <span style="color:#000;font-weight:bold">=</span> sample, fill <span style="color:#000;font-weight:bold">=</span> sample)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_density_ridges</span>(rel_min_height <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0.01</span>, scale <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0.9</span>, alpha <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0.8</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme_ridges</span>(center <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">TRUE</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_fill_manual</span>(values <span style="color:#000;font-weight:bold">=</span> custom_colors<span style="color:#000;font-weight:bold">$</span>discrete) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_x_log10</span>(labels <span style="color:#000;font-weight:bold">=</span> scales<span style="color:#000;font-weight:bold">::</span>comma) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_y_discrete</span>(expand <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">c</span>(<span style="color:#099">0.01</span>, <span style="color:#099">0</span>)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">labs</span>(title <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Number of expressed genes&#39;</span>, subtitle <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">log-scale&#39;</span>, y <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Density&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme</span>(legend.position <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">none&#39;</span>, axis.title.x <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>())

p5 <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">ggplot</span>(cells, <span style="color:#900;font-weight:bold">aes</span>(x <span style="color:#000;font-weight:bold">=</span> percent_MT, y <span style="color:#000;font-weight:bold">=</span> sample, fill <span style="color:#000;font-weight:bold">=</span> sample)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_density_ridges</span>(rel_min_height <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0.01</span>, scale <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0.9</span>, alpha <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0.8</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme_ridges</span>(center <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">TRUE</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_x_continuous</span>(labels <span style="color:#000;font-weight:bold">=</span> scales<span style="color:#000;font-weight:bold">::</span>percent) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_fill_manual</span>(values <span style="color:#000;font-weight:bold">=</span> custom_colors<span style="color:#000;font-weight:bold">$</span>discrete) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_y_discrete</span>(expand <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">c</span>(<span style="color:#099">0.01</span>, <span style="color:#099">0</span>)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">labs</span>(title <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Percent MT transcripts&#39;</span>, subtitle <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">linear scale&#39;</span>, y <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Density&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme</span>(
    legend.position <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">none&#39;</span>,
    axis.title.x <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    axis.text.x <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_text</span>(angle <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">45</span>, hjust <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">1</span>, vjust <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">1</span>)
  )

<span style="color:#900;font-weight:bold">ggsave</span>(
  <span style="color:#d14">&#39;</span><span style="color:#d14">plots/qc_histogram_nCount_nFeature_percentMT_before_filtering_4.png&#39;</span>,
  p1 <span style="color:#000;font-weight:bold">+</span> p3 <span style="color:#000;font-weight:bold">+</span> p5 <span style="color:#000;font-weight:bold">+</span>
  p2 <span style="color:#000;font-weight:bold">+</span> p4 <span style="color:#000;font-weight:bold">+</span> <span style="color:#900;font-weight:bold">plot_layout</span>(ncol <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">3</span>),
  height <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">7</span>, width <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">10</span>
)
</code></pre></div>
<figure >
  
    <a href="/images/projects/scrnaseq_workflow/qc_histogram_nCount_nFeature_percentMT_before_filtering_4.png" target="_blank">
      <img src="/images/projects/scrnaseq_workflow/qc_histogram_nCount_nFeature_percentMT_before_filtering_4.jpg"  style="width: 100%; max-width: 1000px" />
    </a>
  
  
</figure>




  </div>
</div>


<p>Another interesting relationship is the number of expressed genes over the number of transcripts per cell.
This usually results in a curve as the one shown below.
Sometimes there are a number of cells with a particular pattern, i.e. many expressed genes for the number of transcripts they have, which could be dying cells.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-r" data-lang="r">p <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">ggplot</span>(cells, <span style="color:#900;font-weight:bold">aes</span>(nCount, nFeature, color <span style="color:#000;font-weight:bold">=</span> percent_MT)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_point</span>(size <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0.5</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_x_continuous</span>(name <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Number of transcripts&#39;</span>, labels <span style="color:#000;font-weight:bold">=</span> scales<span style="color:#000;font-weight:bold">::</span>comma) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_y_continuous</span>(name <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Number of expressed genes&#39;</span>, labels <span style="color:#000;font-weight:bold">=</span> scales<span style="color:#000;font-weight:bold">::</span>comma) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme_bw</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_color_viridis</span>(
    name <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Percent MT\ntranscripts&#39;</span>,
    limits <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">c</span>(<span style="color:#099">0</span>,<span style="color:#099">1</span>),
    labels <span style="color:#000;font-weight:bold">=</span> scales<span style="color:#000;font-weight:bold">::</span>percent,
    guide <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">guide_colorbar</span>(frame.colour <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">black&#39;</span>, ticks.colour <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">black&#39;</span>)
  )

<span style="color:#900;font-weight:bold">ggsave</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">plots/qc_nFeature_over_nCount_before_filtering.png&#39;</span>, p, height <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">4</span>, width <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">6</span>)
</code></pre></div>
<figure >
  
    <a href="/images/projects/scrnaseq_workflow/qc_nFeature_over_nCount_before_filtering.png" target="_blank">
      <img src="/images/projects/scrnaseq_workflow/qc_nFeature_over_nCount_before_filtering.jpg"  style="width: 100%; max-width: 1000px" />
    </a>
  
  
</figure>


<h4 id="define-thresholds">Define thresholds</h4>
<p>Now, we want to define lower and upper boundaries for the metrics we looked at.
There are different ways to do that.
One way is to go by eye, another to calculate median and MAD (median absolute deviation).
If you decide to go with option 2, it is generally advised to stay within 3-5 MADs around the median [2].
Here, we will be generous and accept anything below median plus 5 times the MAD.
We don't need a lower boundary because the matrices have apparently been pre-filtered with acceptable lower boundaries for the number of transcripts and expressed genes per cell.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-r" data-lang="r">median_nCount <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">median</span>(cells<span style="color:#000;font-weight:bold">$</span>nCount)
<span style="color:#998;font-style:italic"># 4255</span>
mad_nCount <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">mad</span>(cells<span style="color:#000;font-weight:bold">$</span>nCount)
<span style="color:#998;font-style:italic"># 2630.874</span>

median_nFeature <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">median</span>(cells<span style="color:#000;font-weight:bold">$</span>nFeature)
<span style="color:#998;font-style:italic"># 803</span>
mad_nFeature <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">mad</span>(cells<span style="color:#000;font-weight:bold">$</span>nFeature)
<span style="color:#998;font-style:italic"># 544.1142</span>

median_percent_MT <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">median</span>(cells<span style="color:#000;font-weight:bold">$</span>percent_MT)
<span style="color:#998;font-style:italic"># 0.02760973</span>
mad_percent_MT <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">mad</span>(cells<span style="color:#000;font-weight:bold">$</span>percent_MT)
<span style="color:#998;font-style:italic"># 0.02103674</span>

thresholds_nCount <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">c</span>(<span style="color:#099">0</span>, median_nCount <span style="color:#000;font-weight:bold">+</span> <span style="color:#099">5</span><span style="color:#000;font-weight:bold">*</span>mad_nCount)
<span style="color:#998;font-style:italic"># 0.00 17409.37</span>
thresholds_nFeature <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">c</span>(<span style="color:#099">0</span>, median_nFeature <span style="color:#000;font-weight:bold">+</span> <span style="color:#099">5</span><span style="color:#000;font-weight:bold">*</span>mad_nFeature)
<span style="color:#998;font-style:italic"># 0.000 3523.571</span>
thresholds_percent_MT <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">c</span>(<span style="color:#099">0</span>, median_percent_MT <span style="color:#000;font-weight:bold">+</span> <span style="color:#099">5</span><span style="color:#000;font-weight:bold">*</span>mad_percent_MT)
<span style="color:#998;font-style:italic"># 0.0000000 0.1327934</span>
</code></pre></div><p>Median and thresholds are shown in the plots below.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-r" data-lang="r">p1 <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">ggplot</span>(cells, <span style="color:#900;font-weight:bold">aes</span>(x <span style="color:#000;font-weight:bold">=</span> sample, y <span style="color:#000;font-weight:bold">=</span> nCount, fill <span style="color:#000;font-weight:bold">=</span> sample)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_violin</span>(draw_quantiles <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">c</span>(<span style="color:#099">0.5</span>), scale <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">area&#39;</span>, trim <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">FALSE</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_hline</span>(yintercept <span style="color:#000;font-weight:bold">=</span> median_nCount, color <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">black&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_hline</span>(yintercept <span style="color:#000;font-weight:bold">=</span> thresholds_nCount, color <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">red&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme_bw</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_fill_manual</span>(values <span style="color:#000;font-weight:bold">=</span> custom_colors<span style="color:#000;font-weight:bold">$</span>discrete) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_x_discrete</span>(limits <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">rev</span>(<span style="color:#900;font-weight:bold">levels</span>(cells<span style="color:#000;font-weight:bold">$</span>sample))) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_y_continuous</span>(labels <span style="color:#000;font-weight:bold">=</span> scales<span style="color:#000;font-weight:bold">::</span>comma) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">labs</span>(title <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Number of transcripts&#39;</span>, subtitle <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">linear scale&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme</span>(
    axis.title <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    panel.grid.major.y <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    panel.grid.minor.y <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    legend.position <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">none&#39;</span>
  ) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">coord_flip</span>()

p2 <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">ggplot</span>(cells, <span style="color:#900;font-weight:bold">aes</span>(x <span style="color:#000;font-weight:bold">=</span> sample, y <span style="color:#000;font-weight:bold">=</span> nCount, fill <span style="color:#000;font-weight:bold">=</span> sample)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_violin</span>(draw_quantiles <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">c</span>(<span style="color:#099">0.5</span>), scale <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">area&#39;</span>, trim <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">FALSE</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_hline</span>(yintercept <span style="color:#000;font-weight:bold">=</span> median_nCount, color <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">black&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_hline</span>(yintercept <span style="color:#000;font-weight:bold">=</span> thresholds_nCount, color <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">red&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme_bw</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_fill_manual</span>(values <span style="color:#000;font-weight:bold">=</span> custom_colors<span style="color:#000;font-weight:bold">$</span>discrete) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_x_discrete</span>(limits <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">rev</span>(<span style="color:#900;font-weight:bold">levels</span>(cells<span style="color:#000;font-weight:bold">$</span>sample))) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_y_log10</span>(labels <span style="color:#000;font-weight:bold">=</span> scales<span style="color:#000;font-weight:bold">::</span>comma) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">labs</span>(title <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Number of transcripts&#39;</span>, subtitle <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">log-scale&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme</span>(
    axis.title <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    panel.grid.major.y <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    panel.grid.minor.y <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    legend.position <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">none&#39;</span>
  ) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">coord_flip</span>()

p3 <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">ggplot</span>(cells, <span style="color:#900;font-weight:bold">aes</span>(x <span style="color:#000;font-weight:bold">=</span> sample, y <span style="color:#000;font-weight:bold">=</span> nFeature, fill <span style="color:#000;font-weight:bold">=</span> sample)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_violin</span>(draw_quantiles <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">c</span>(<span style="color:#099">0.5</span>), scale <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">area&#39;</span>, trim <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">FALSE</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_hline</span>(yintercept <span style="color:#000;font-weight:bold">=</span> median_nFeature, color <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">black&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_hline</span>(yintercept <span style="color:#000;font-weight:bold">=</span> thresholds_nFeature, color <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">red&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme_bw</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_fill_manual</span>(values <span style="color:#000;font-weight:bold">=</span> custom_colors<span style="color:#000;font-weight:bold">$</span>discrete) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_x_discrete</span>(limits <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">rev</span>(<span style="color:#900;font-weight:bold">levels</span>(cells<span style="color:#000;font-weight:bold">$</span>sample))) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_y_continuous</span>(labels <span style="color:#000;font-weight:bold">=</span> scales<span style="color:#000;font-weight:bold">::</span>comma) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">labs</span>(title <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Number of expressed genes&#39;</span>, subtitle <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">linear scale&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme</span>(
    axis.title <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    panel.grid.major.y <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    panel.grid.minor.y <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    legend.position <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">none&#39;</span>
  ) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">coord_flip</span>()

p4 <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">ggplot</span>(cells, <span style="color:#900;font-weight:bold">aes</span>(x <span style="color:#000;font-weight:bold">=</span> sample, y <span style="color:#000;font-weight:bold">=</span> nFeature, fill <span style="color:#000;font-weight:bold">=</span> sample)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_violin</span>(draw_quantiles <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">c</span>(<span style="color:#099">0.5</span>), scale <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">area&#39;</span>, trim <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">FALSE</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_hline</span>(yintercept <span style="color:#000;font-weight:bold">=</span> median_nFeature, color <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">black&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_hline</span>(yintercept <span style="color:#000;font-weight:bold">=</span> thresholds_nFeature, color <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">red&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme_bw</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_fill_manual</span>(values <span style="color:#000;font-weight:bold">=</span> custom_colors<span style="color:#000;font-weight:bold">$</span>discrete) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_x_discrete</span>(limits <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">rev</span>(<span style="color:#900;font-weight:bold">levels</span>(cells<span style="color:#000;font-weight:bold">$</span>sample))) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_y_log10</span>(labels <span style="color:#000;font-weight:bold">=</span> scales<span style="color:#000;font-weight:bold">::</span>comma) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">labs</span>(title <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Number of expressed genes&#39;</span>, subtitle <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">log-scale&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme</span>(
    axis.title <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    panel.grid.major.y <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    panel.grid.minor.y <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    legend.position <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">none&#39;</span>
  ) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">coord_flip</span>()

p5 <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">ggplot</span>(cells, <span style="color:#900;font-weight:bold">aes</span>(x <span style="color:#000;font-weight:bold">=</span> sample, y <span style="color:#000;font-weight:bold">=</span> percent_MT, fill <span style="color:#000;font-weight:bold">=</span> sample)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_violin</span>(draw_quantiles <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">c</span>(<span style="color:#099">0.5</span>), scale <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">area&#39;</span>, trim <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">FALSE</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_hline</span>(yintercept <span style="color:#000;font-weight:bold">=</span> median_percent_MT, color <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">black&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_hline</span>(yintercept <span style="color:#000;font-weight:bold">=</span> thresholds_percent_MT, color <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">red&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme_bw</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_fill_manual</span>(values <span style="color:#000;font-weight:bold">=</span> custom_colors<span style="color:#000;font-weight:bold">$</span>discrete) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_x_discrete</span>(limits <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">rev</span>(<span style="color:#900;font-weight:bold">levels</span>(cells<span style="color:#000;font-weight:bold">$</span>sample))) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_y_continuous</span>(labels <span style="color:#000;font-weight:bold">=</span> scales<span style="color:#000;font-weight:bold">::</span>percent) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">labs</span>(title <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Percent MT transcripts&#39;</span>, subtitle <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">linear scale&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme</span>(
    axis.title <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    panel.grid.major.y <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    panel.grid.minor.y <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    legend.position <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">none&#39;</span>
  ) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">coord_flip</span>()

<span style="color:#900;font-weight:bold">ggsave</span>(
  <span style="color:#d14">&#39;</span><span style="color:#d14">plots/qc_histogram_nCount_nFeature_percentMT_thresholds.png&#39;</span>,
  p1 <span style="color:#000;font-weight:bold">+</span> p3 <span style="color:#000;font-weight:bold">+</span> p5 <span style="color:#000;font-weight:bold">+</span>
  p2 <span style="color:#000;font-weight:bold">+</span> p4 <span style="color:#000;font-weight:bold">+</span> <span style="color:#900;font-weight:bold">plot_layout</span>(ncol <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">3</span>),
  height <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">7</span>, width <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">10</span>
)
</code></pre></div>
<figure >
  
    <a href="/images/projects/scrnaseq_workflow/qc_histogram_nCount_nFeature_percentMT_thresholds.png" target="_blank">
      <img src="/images/projects/scrnaseq_workflow/qc_histogram_nCount_nFeature_percentMT_thresholds.jpg"  style="width: 100%; max-width: 1000px" />
    </a>
  
  
</figure>


<p>Same thresholds in the other representation.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-r" data-lang="r">p <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">ggplot</span>(cells, <span style="color:#900;font-weight:bold">aes</span>(nCount, nFeature, color <span style="color:#000;font-weight:bold">=</span> percent_MT)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_point</span>(size <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0.5</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_hline</span>(yintercept <span style="color:#000;font-weight:bold">=</span> thresholds_nFeature, color <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">red&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_vline</span>(xintercept <span style="color:#000;font-weight:bold">=</span> thresholds_nCount, color <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">red&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_x_continuous</span>(name <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Number of transcripts&#39;</span>, labels <span style="color:#000;font-weight:bold">=</span> scales<span style="color:#000;font-weight:bold">::</span>comma) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_y_continuous</span>(name <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Number of expressed genes&#39;</span>, labels <span style="color:#000;font-weight:bold">=</span> scales<span style="color:#000;font-weight:bold">::</span>comma) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme_bw</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_color_viridis</span>(
    name <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Percent MT\ntranscripts&#39;</span>,
    limits <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">c</span>(<span style="color:#099">0</span>,<span style="color:#099">1</span>),
    labels <span style="color:#000;font-weight:bold">=</span> scales<span style="color:#000;font-weight:bold">::</span>percent,
    guide <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">guide_colorbar</span>(frame.colour <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">black&#39;</span>, ticks.colour <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">black&#39;</span>)
  )

<span style="color:#900;font-weight:bold">ggsave</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">plots/qc_nFeature_over_nCount_thresholds.png&#39;</span>, p, height <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">4</span>, width <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">6</span>)
</code></pre></div>
<figure >
  
    <a href="/images/projects/scrnaseq_workflow/qc_nFeature_over_nCount_thresholds.png" target="_blank">
      <img src="/images/projects/scrnaseq_workflow/qc_nFeature_over_nCount_thresholds.jpg"  style="width: 100%; max-width: 1000px" />
    </a>
  
  
</figure>


<h4 id="after-filtering">After filtering</h4>
<p>Now we identify cells which meet the thresholds we identified.
Note that the violin plots extending beyond the indicated cut-offs does not mean that the filtering didn't work.
The reason they do that is because the distribution is smoothened and I switched off trimming in the <code>geom_violin()</code> call.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-r" data-lang="r">cells_filtered <span style="color:#000;font-weight:bold">&lt;-</span> cells <span style="color:#000;font-weight:bold">%&gt;%</span>
  dplyr<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">filter</span>(
    nCount <span style="color:#000;font-weight:bold">&gt;=</span> thresholds_nCount[1],
    nCount <span style="color:#000;font-weight:bold">&lt;=</span> thresholds_nCount[2],
    nFeature <span style="color:#000;font-weight:bold">&gt;=</span> thresholds_nFeature[1],
    nFeature <span style="color:#000;font-weight:bold">&lt;=</span> thresholds_nFeature[2],
    percent_MT <span style="color:#000;font-weight:bold">&gt;=</span> thresholds_percent_MT[1],
    percent_MT <span style="color:#000;font-weight:bold">&lt;=</span> thresholds_percent_MT[2]
  )

<span style="color:#900;font-weight:bold">DataFrame</span>(cells_filtered)
<span style="color:#998;font-style:italic"># DataFrame with 5395 rows and 6 columns</span>
<span style="color:#998;font-style:italic">#                    cell   sample    nCount  nFeature percent_MT multiplet_class</span>
<span style="color:#998;font-style:italic">#             &lt;character&gt; &lt;factor&gt; &lt;numeric&gt; &lt;integer&gt;  &lt;numeric&gt;     &lt;character&gt;</span>
<span style="color:#998;font-style:italic"># 1    AGTAGTCAGCTAAACA-A        A     11915       557 0.00260176         singlet</span>
<span style="color:#998;font-style:italic"># 2    TTGGCAAAGGCAAAGA-A        A      4205      1027 0.02354340         singlet</span>
<span style="color:#998;font-style:italic"># 3    CTACACCTCAACGAAA-A        A     11593       633 0.00517554         singlet</span>
<span style="color:#998;font-style:italic"># 4    TCAGATGTCAGCGACC-A        A      4056      1226 0.06854043         singlet</span>
<span style="color:#998;font-style:italic"># 5    ACGAGCCAGAACTGTA-A        A      4580      1256 0.03340611         singlet</span>
<span style="color:#998;font-style:italic"># ...                 ...      ...       ...       ...        ...             ...</span>
<span style="color:#998;font-style:italic"># 5391 AGTCTTTTCGAGAACG-E        E      2397       876 0.06090947         singlet</span>
<span style="color:#998;font-style:italic"># 5392 GTAGGCCCAAGGACAC-E        E      3064       149 0.00163185         singlet</span>
<span style="color:#998;font-style:italic"># 5393 AGGGAGTTCCTGTAGA-E        E      2405       699 0.01912682         singlet</span>
<span style="color:#998;font-style:italic"># 5394 CATTCGCAGGTACTCT-E        E      2262       888 0.05393457         singlet</span>
<span style="color:#998;font-style:italic"># 5395 TGATTTCAGGCTCAGA-E        E      2150       733 0.02325581         singlet</span>
</code></pre></div><div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-r" data-lang="r">p1 <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">ggplot</span>(cells_filtered, <span style="color:#900;font-weight:bold">aes</span>(x <span style="color:#000;font-weight:bold">=</span> sample, y <span style="color:#000;font-weight:bold">=</span> nCount, fill <span style="color:#000;font-weight:bold">=</span> sample)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_violin</span>(draw_quantiles <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">c</span>(<span style="color:#099">0.5</span>), scale <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">area&#39;</span>, trim <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">FALSE</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_hline</span>(yintercept <span style="color:#000;font-weight:bold">=</span> median_nCount, color <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">black&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_hline</span>(yintercept <span style="color:#000;font-weight:bold">=</span> thresholds_nCount, color <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">red&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme_bw</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_fill_manual</span>(values <span style="color:#000;font-weight:bold">=</span> custom_colors<span style="color:#000;font-weight:bold">$</span>discrete) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_x_discrete</span>(limits <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">rev</span>(<span style="color:#900;font-weight:bold">levels</span>(cells_filtered<span style="color:#000;font-weight:bold">$</span>sample))) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_y_continuous</span>(labels <span style="color:#000;font-weight:bold">=</span> scales<span style="color:#000;font-weight:bold">::</span>comma) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">labs</span>(title <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Number of transcripts&#39;</span>, subtitle <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">linear scale&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme</span>(
    axis.title <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    panel.grid.major.y <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    panel.grid.minor.y <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    legend.position <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">none&#39;</span>
  ) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">coord_flip</span>()

p2 <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">ggplot</span>(cells_filtered, <span style="color:#900;font-weight:bold">aes</span>(x <span style="color:#000;font-weight:bold">=</span> sample, y <span style="color:#000;font-weight:bold">=</span> nCount, fill <span style="color:#000;font-weight:bold">=</span> sample)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_violin</span>(draw_quantiles <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">c</span>(<span style="color:#099">0.5</span>), scale <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">area&#39;</span>, trim <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">FALSE</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_hline</span>(yintercept <span style="color:#000;font-weight:bold">=</span> median_nCount, color <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">black&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_hline</span>(yintercept <span style="color:#000;font-weight:bold">=</span> thresholds_nCount, color <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">red&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme_bw</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_fill_manual</span>(values <span style="color:#000;font-weight:bold">=</span> custom_colors<span style="color:#000;font-weight:bold">$</span>discrete) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_x_discrete</span>(limits <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">rev</span>(<span style="color:#900;font-weight:bold">levels</span>(cells_filtered<span style="color:#000;font-weight:bold">$</span>sample))) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_y_log10</span>(labels <span style="color:#000;font-weight:bold">=</span> scales<span style="color:#000;font-weight:bold">::</span>comma) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">labs</span>(title <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Number of transcripts&#39;</span>, subtitle <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">log-scale&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme</span>(
    axis.title <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    panel.grid.major.y <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    panel.grid.minor.y <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    legend.position <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">none&#39;</span>
  ) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">coord_flip</span>()

p3 <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">ggplot</span>(cells_filtered, <span style="color:#900;font-weight:bold">aes</span>(x <span style="color:#000;font-weight:bold">=</span> sample, y <span style="color:#000;font-weight:bold">=</span> nFeature, fill <span style="color:#000;font-weight:bold">=</span> sample)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_violin</span>(draw_quantiles <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">c</span>(<span style="color:#099">0.5</span>), scale <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">area&#39;</span>, trim <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">FALSE</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_hline</span>(yintercept <span style="color:#000;font-weight:bold">=</span> median_nFeature, color <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">black&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_hline</span>(yintercept <span style="color:#000;font-weight:bold">=</span> thresholds_nFeature, color <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">red&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme_bw</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_fill_manual</span>(values <span style="color:#000;font-weight:bold">=</span> custom_colors<span style="color:#000;font-weight:bold">$</span>discrete) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_x_discrete</span>(limits <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">rev</span>(<span style="color:#900;font-weight:bold">levels</span>(cells_filtered<span style="color:#000;font-weight:bold">$</span>sample))) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_y_continuous</span>(labels <span style="color:#000;font-weight:bold">=</span> scales<span style="color:#000;font-weight:bold">::</span>comma) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">labs</span>(title <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Number of expressed genes&#39;</span>, subtitle <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">linear scale&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme</span>(
    axis.title <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    panel.grid.major.y <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    panel.grid.minor.y <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    legend.position <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">none&#39;</span>
  ) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">coord_flip</span>()

p4 <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">ggplot</span>(cells_filtered, <span style="color:#900;font-weight:bold">aes</span>(x <span style="color:#000;font-weight:bold">=</span> sample, y <span style="color:#000;font-weight:bold">=</span> nFeature, fill <span style="color:#000;font-weight:bold">=</span> sample)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_violin</span>(draw_quantiles <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">c</span>(<span style="color:#099">0.5</span>), scale <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">area&#39;</span>, trim <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">FALSE</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_hline</span>(yintercept <span style="color:#000;font-weight:bold">=</span> median_nFeature, color <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">black&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_hline</span>(yintercept <span style="color:#000;font-weight:bold">=</span> thresholds_nFeature, color <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">red&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme_bw</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_fill_manual</span>(values <span style="color:#000;font-weight:bold">=</span> custom_colors<span style="color:#000;font-weight:bold">$</span>discrete) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_x_discrete</span>(limits <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">rev</span>(<span style="color:#900;font-weight:bold">levels</span>(cells_filtered<span style="color:#000;font-weight:bold">$</span>sample))) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_y_log10</span>(labels <span style="color:#000;font-weight:bold">=</span> scales<span style="color:#000;font-weight:bold">::</span>comma) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">labs</span>(title <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Number of expressed genes&#39;</span>, subtitle <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">log-scale&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme</span>(
    axis.title <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    panel.grid.major.y <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    panel.grid.minor.y <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    legend.position <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">none&#39;</span>
  ) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">coord_flip</span>()

p5 <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">ggplot</span>(cells_filtered, <span style="color:#900;font-weight:bold">aes</span>(x <span style="color:#000;font-weight:bold">=</span> sample, y <span style="color:#000;font-weight:bold">=</span> percent_MT, fill <span style="color:#000;font-weight:bold">=</span> sample)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_violin</span>(draw_quantiles <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">c</span>(<span style="color:#099">0.5</span>), scale <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">area&#39;</span>, trim <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">FALSE</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_hline</span>(yintercept <span style="color:#000;font-weight:bold">=</span> median_percent_MT, color <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">black&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_hline</span>(yintercept <span style="color:#000;font-weight:bold">=</span> thresholds_percent_MT, color <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">red&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme_bw</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_fill_manual</span>(values <span style="color:#000;font-weight:bold">=</span> custom_colors<span style="color:#000;font-weight:bold">$</span>discrete) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_x_discrete</span>(limits <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">rev</span>(<span style="color:#900;font-weight:bold">levels</span>(cells_filtered<span style="color:#000;font-weight:bold">$</span>sample))) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_y_continuous</span>(labels <span style="color:#000;font-weight:bold">=</span> scales<span style="color:#000;font-weight:bold">::</span>percent) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">labs</span>(title <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Percent MT transcripts&#39;</span>, subtitle <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">linear scale&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme</span>(
    axis.title <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    panel.grid.major.y <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    panel.grid.minor.y <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    legend.position <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">none&#39;</span>
  ) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">coord_flip</span>()

<span style="color:#900;font-weight:bold">ggsave</span>(
  <span style="color:#d14">&#39;</span><span style="color:#d14">plots/qc_histogram_nCount_nFeature_percentMT_filtered.png&#39;</span>,
  p1 <span style="color:#000;font-weight:bold">+</span> p3 <span style="color:#000;font-weight:bold">+</span> p5 <span style="color:#000;font-weight:bold">+</span>
  p2 <span style="color:#000;font-weight:bold">+</span> p4 <span style="color:#000;font-weight:bold">+</span> <span style="color:#900;font-weight:bold">plot_layout</span>(ncol <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">3</span>),
  height <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">7</span>, width <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">10</span>
)
</code></pre></div>
<figure >
  
    <a href="/images/projects/scrnaseq_workflow/qc_histogram_nCount_nFeature_percentMT_filtered.png" target="_blank">
      <img src="/images/projects/scrnaseq_workflow/qc_histogram_nCount_nFeature_percentMT_filtered.jpg"  style="width: 100%; max-width: 1000px" />
    </a>
  
  
</figure>


<p>And again, another representation that now clearly highlights the lower boundaries that have been used to filter the cells in the samples.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-r" data-lang="r">p <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">ggplot</span>(cells_filtered, <span style="color:#900;font-weight:bold">aes</span>(nCount, nFeature, color <span style="color:#000;font-weight:bold">=</span> percent_MT)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_point</span>(size <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0.5</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_hline</span>(yintercept <span style="color:#000;font-weight:bold">=</span> thresholds_nFeature, color <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">red&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_vline</span>(xintercept <span style="color:#000;font-weight:bold">=</span> thresholds_nCount, color <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">red&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_x_continuous</span>(name <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Number of transcripts&#39;</span>, labels <span style="color:#000;font-weight:bold">=</span> scales<span style="color:#000;font-weight:bold">::</span>comma) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_y_continuous</span>(name <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Number of expressed genes&#39;</span>, labels <span style="color:#000;font-weight:bold">=</span> scales<span style="color:#000;font-weight:bold">::</span>comma) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme_bw</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_color_viridis</span>(
    name <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Percent MT\ntranscripts&#39;</span>,
    limits <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">c</span>(<span style="color:#099">0</span>,<span style="color:#099">1</span>),
    labels <span style="color:#000;font-weight:bold">=</span> scales<span style="color:#000;font-weight:bold">::</span>percent,
    guide <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">guide_colorbar</span>(frame.colour <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">black&#39;</span>, ticks.colour <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">black&#39;</span>)
  )

<span style="color:#900;font-weight:bold">ggsave</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">plots/qc_nFeature_over_nCount_filtered.png&#39;</span>, p, height <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">4</span>, width <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">6</span>)
</code></pre></div>
<figure >
  
    <a href="/images/projects/scrnaseq_workflow/qc_nFeature_over_nCount_filtered.png" target="_blank">
      <img src="/images/projects/scrnaseq_workflow/qc_nFeature_over_nCount_filtered.jpg"  style="width: 100%; max-width: 1000px" />
    </a>
  
  
</figure>


<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-r" data-lang="r">cells_to_keep <span style="color:#000;font-weight:bold">&lt;-</span> cells_filtered<span style="color:#000;font-weight:bold">$</span>cell
<span style="color:#900;font-weight:bold">length</span>(cells_to_keep)
<span style="color:#998;font-style:italic"># 5395</span>
</code></pre></div><p>Out of the 6,000 cells we loaded from the three samples, we have 5,395 cells left after filtering.</p>
<h3 id="filter-genes">Filter genes</h3>
<p>As mentioned earlier, we will also remove genes which are expressed in fewer than 5 cells.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-r" data-lang="r">genes <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">tibble</span>(
  gene <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">rownames</span>(transcripts<span style="color:#000;font-weight:bold">$</span>raw<span style="color:#000;font-weight:bold">$</span>merged),
  count <span style="color:#000;font-weight:bold">=</span> Matrix<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">rowSums</span>(transcripts<span style="color:#000;font-weight:bold">$</span>raw<span style="color:#000;font-weight:bold">$</span>merged),
  cells <span style="color:#000;font-weight:bold">=</span> Matrix<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">rowSums</span>(transcripts<span style="color:#000;font-weight:bold">$</span>raw<span style="color:#000;font-weight:bold">$</span>merged <span style="color:#000;font-weight:bold">!=</span> <span style="color:#099">0</span>)
)

genes_to_keep <span style="color:#000;font-weight:bold">&lt;-</span> genes <span style="color:#000;font-weight:bold">%&gt;%</span> dplyr<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">filter</span>(cells <span style="color:#000;font-weight:bold">&gt;=</span> <span style="color:#099">5</span>) <span style="color:#000;font-weight:bold">%&gt;%</span> <span style="color:#900;font-weight:bold">pull</span>(gene)
<span style="color:#900;font-weight:bold">length</span>(genes_to_keep)
<span style="color:#998;font-style:italic"># 16406</span>
</code></pre></div><p>Applying this filter reduces the number of genes from ~33,000 to 16,406 genes.</p>
<h3 id="generate-filtered-transcript-matrix">Generate filtered transcript matrix</h3>
<p>Here, we generate the new, filtered transcript count matrix.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-r" data-lang="r">transcripts<span style="color:#000;font-weight:bold">$</span>raw<span style="color:#000;font-weight:bold">$</span>filtered <span style="color:#000;font-weight:bold">&lt;-</span> transcripts<span style="color:#000;font-weight:bold">$</span>raw<span style="color:#000;font-weight:bold">$</span>merged[genes_to_keep,cells_to_keep]

cells_per_sample_after_filtering <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">tibble</span>(
  sample <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">character</span>(),
  before <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">numeric</span>(),
  after <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">numeric</span>()
)

<span style="color:#900;font-weight:bold">for </span>( i in sample_names ) {
  tmp <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">tibble</span>(
    sample <span style="color:#000;font-weight:bold">=</span> i,
    before <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">grep</span>(<span style="color:#900;font-weight:bold">colnames</span>(transcripts<span style="color:#000;font-weight:bold">$</span>raw<span style="color:#000;font-weight:bold">$</span>merged), pattern <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">paste0</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">-&#39;</span>, i, <span style="color:#d14">&#39;</span><span style="color:#d14">$&#39;</span>)) <span style="color:#000;font-weight:bold">%&gt;%</span> <span style="color:#900;font-weight:bold">length</span>(),
    after <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">grep</span>(<span style="color:#900;font-weight:bold">colnames</span>(transcripts<span style="color:#000;font-weight:bold">$</span>raw<span style="color:#000;font-weight:bold">$</span>filtered), pattern <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">paste0</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">-&#39;</span>, i, <span style="color:#d14">&#39;</span><span style="color:#d14">$&#39;</span>)) <span style="color:#000;font-weight:bold">%&gt;%</span> <span style="color:#900;font-weight:bold">length</span>()
  )
  cells_per_sample_after_filtering <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">bind_rows</span>(cells_per_sample_after_filtering, tmp)
}

knitr<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">kable</span>(cells_per_sample_after_filtering)
</code></pre></div><p>In the table below we see how many cells we had in every sample before and after filtering:</p>
<table>
<thead>
<tr>
<th align="left">sample</th>
<th align="right">before</th>
<th align="right">after</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">A</td>
<td align="right">2000</td>
<td align="right">1696</td>
</tr>
<tr>
<td align="left">B</td>
<td align="right">2000</td>
<td align="right">1818</td>
</tr>
<tr>
<td align="left">E</td>
<td align="right">2000</td>
<td align="right">1881</td>
</tr>
</tbody>
</table>
<h2 id="create-seurat-object">Create Seurat object</h2>
<p>Having the transcript count matrix ready, we can now initialize our Seurat object.
Right after, we store the sample assignment for every cell in the meta data.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-r" data-lang="r">seurat <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">CreateSeuratObject</span>(
  counts <span style="color:#000;font-weight:bold">=</span> transcripts<span style="color:#000;font-weight:bold">$</span>raw<span style="color:#000;font-weight:bold">$</span>filtered,
  min.cells <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>,
  min.features <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>
)

seurat<span style="color:#000;font-weight:bold">@</span>meta.data<span style="color:#000;font-weight:bold">$</span>sample <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">Cells</span>(seurat) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">strsplit</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">-&#39;</span>) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">vapply</span>(FUN.VALUE <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">character</span>(<span style="color:#099">1</span>), `[`, <span style="color:#099">2</span>) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">factor</span>(levels <span style="color:#000;font-weight:bold">=</span> sample_names)
</code></pre></div><p>Just to be sure, let's look at the distribution of number of transcripts and expressed genes per cell by sample once more.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-r" data-lang="r">temp_labels <span style="color:#000;font-weight:bold">&lt;-</span> seurat<span style="color:#000;font-weight:bold">@</span>meta.data <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">group_by</span>(sample) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">tally</span>()

p1 <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">ggplot</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_half_violin</span>(
    data <span style="color:#000;font-weight:bold">=</span> seurat<span style="color:#000;font-weight:bold">@</span>meta.data, <span style="color:#900;font-weight:bold">aes</span>(sample, nCount_RNA, fill <span style="color:#000;font-weight:bold">=</span> sample),
    side <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">l&#39;</span>, show.legend <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">FALSE</span>, trim <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">FALSE</span>
  ) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_half_boxplot</span>(
    data <span style="color:#000;font-weight:bold">=</span> seurat<span style="color:#000;font-weight:bold">@</span>meta.data, <span style="color:#900;font-weight:bold">aes</span>(sample, nCount_RNA, fill <span style="color:#000;font-weight:bold">=</span> sample),
    side <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">r&#39;</span>, outlier.color <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">NA</span>, width <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0.4</span>, show.legend <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">FALSE</span>
  ) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_text</span>(
    data <span style="color:#000;font-weight:bold">=</span> temp_labels,
    <span style="color:#900;font-weight:bold">aes</span>(x <span style="color:#000;font-weight:bold">=</span> sample, y <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">Inf</span>, label <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">paste0</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">n = &#39;</span>, <span style="color:#900;font-weight:bold">format</span>(n, big.mark <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">,&#39;</span>, trim <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">TRUE</span>)), vjust <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">-1</span>),
    color <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">black&#39;</span>, size <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">2.8</span>
  ) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_color_manual</span>(values <span style="color:#000;font-weight:bold">=</span> custom_colors<span style="color:#000;font-weight:bold">$</span>discrete) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_fill_manual</span>(values <span style="color:#000;font-weight:bold">=</span> custom_colors<span style="color:#000;font-weight:bold">$</span>discrete) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_y_continuous</span>(labels <span style="color:#000;font-weight:bold">=</span> scales<span style="color:#000;font-weight:bold">::</span>comma, expand <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">c</span>(<span style="color:#099">0.08</span>,<span style="color:#099">0</span>)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme_bw</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">labs</span>(x <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">&#39;</span>, y <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Number of transcripts&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme</span>(
    panel.grid.major.x <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    axis.title.x <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>()
  )

p2 <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">ggplot</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_half_violin</span>(
    data <span style="color:#000;font-weight:bold">=</span> seurat<span style="color:#000;font-weight:bold">@</span>meta.data, <span style="color:#900;font-weight:bold">aes</span>(sample, nFeature_RNA, fill <span style="color:#000;font-weight:bold">=</span> sample),
    side <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">l&#39;</span>, show.legend <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">FALSE</span>, trim <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">FALSE</span>
  ) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_half_boxplot</span>(
    data <span style="color:#000;font-weight:bold">=</span> seurat<span style="color:#000;font-weight:bold">@</span>meta.data, <span style="color:#900;font-weight:bold">aes</span>(sample, nFeature_RNA, fill <span style="color:#000;font-weight:bold">=</span> sample),
    side <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">r&#39;</span>, outlier.color <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">NA</span>, width <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0.4</span>, show.legend <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">FALSE</span>
  ) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_text</span>(
    data <span style="color:#000;font-weight:bold">=</span> temp_labels,
    <span style="color:#900;font-weight:bold">aes</span>(x <span style="color:#000;font-weight:bold">=</span> sample, y <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">Inf</span>, label <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">paste0</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">n = &#39;</span>, <span style="color:#900;font-weight:bold">format</span>(n, big.mark <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">,&#39;</span>, trim <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">TRUE</span>)), vjust <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">-1</span>),
    color <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">black&#39;</span>, size <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">2.8</span>
  ) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_color_manual</span>(values <span style="color:#000;font-weight:bold">=</span> custom_colors<span style="color:#000;font-weight:bold">$</span>discrete) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_fill_manual</span>(values <span style="color:#000;font-weight:bold">=</span> custom_colors<span style="color:#000;font-weight:bold">$</span>discrete) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_y_continuous</span>(
    name <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Number of expressed genes&#39;</span>,
    labels <span style="color:#000;font-weight:bold">=</span> scales<span style="color:#000;font-weight:bold">::</span>comma, expand <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">c</span>(<span style="color:#099">0.08</span>,<span style="color:#099">0</span>)
  ) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme_bw</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme</span>(
    panel.grid.major.x <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    axis.title.x <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>()
  )

<span style="color:#900;font-weight:bold">ggsave</span>(
  <span style="color:#d14">&#39;</span><span style="color:#d14">plots/nCount_nFeature_by_sample.png&#39;</span>,
  p1 <span style="color:#000;font-weight:bold">+</span> p2 <span style="color:#000;font-weight:bold">+</span> <span style="color:#900;font-weight:bold">plot_layout</span>(ncol <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">2</span>), height <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">4</span>, width <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">10</span>
)
</code></pre></div>
<figure >
  
    <a href="/images/projects/scrnaseq_workflow/nCount_nFeature_by_sample.png" target="_blank">
      <img src="/images/projects/scrnaseq_workflow/nCount_nFeature_by_sample.jpg"  style="width: 100%; max-width: 1000px" />
    </a>
  
  
</figure>


<h2 id="normalize-expression-data">Normalize expression data</h2>
<p>Next, we normalize the raw transcript counts (so that every cell has the same number of transcripts) and apply a log-scale.
This can be done in different ways with different tools.
The <code>SCTransform()</code> and <code>NormalizeData()</code> methods from the <a href="https://satijalab.org/seurat/">Seurat</a> package and the <code>logNormCounts()</code> function from <a href="https://bioconductor.org/packages/release/bioc/html/scran.html"><code>scran</code></a> seem to work well.</p>


<div class="tabs">
  <input type="radio" name="normalization" id="sctransform" checked="checked">
  <label for="sctransform">sctransform</label>
  <div class="tab">


<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-r" data-lang="r">seurat <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">SCTransform</span>(seurat, assay <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">RNA&#39;</span>)
</code></pre></div>

  </div>
  <input type="radio" name="normalization" id="scran">
  <label for="scran">scran</label>
  <div class="tab">


<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-r" data-lang="r">sce <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">SingleCellExperiment</span>(<span style="color:#900;font-weight:bold">list</span>(counts <span style="color:#000;font-weight:bold">=</span> seurat<span style="color:#000;font-weight:bold">@</span>assays<span style="color:#000;font-weight:bold">$</span>RNA<span style="color:#000;font-weight:bold">@</span>counts))
sce <span style="color:#000;font-weight:bold">&lt;-</span> scater<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">logNormCounts</span>(sce)

seurat<span style="color:#000;font-weight:bold">@</span>assays<span style="color:#000;font-weight:bold">$</span>RNA<span style="color:#000;font-weight:bold">@</span>data <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">as</span>(<span style="color:#900;font-weight:bold">logcounts</span>(sce), <span style="color:#d14">&#39;</span><span style="color:#d14">dgCMatrix&#39;</span>)
</code></pre></div>

  </div>
  <input type="radio" name="normalization" id="seurat">
  <label for="seurat">Seurat</label>
  <div class="tab">


<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-r" data-lang="r">seurat <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">NormalizeData</span>(
  seurat,
  assay <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">RNA&#39;</span>,
  normalization.method <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">LogNormalize&#39;</span>,
  scale.factor <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">median</span>(seurat<span style="color:#000;font-weight:bold">@</span>meta.data<span style="color:#000;font-weight:bold">$</span>nCount_RNA)
)
</code></pre></div>

  </div>
</div>


<h2 id="optional-data-integration">(Optional) Data integration</h2>
<p>In some cases, e.g. when there are evident batch effects due to different preparation techniques, it might make sense to integrate data sets.
Again, many methods exist to perform this task.
The data integration procedure built into the <a href="https://satijalab.org/seurat/">Seurat</a> package has proven to work well [3] and I've personally had good experience with it.
For the samples analyzed here, we don't need it though and will skip this part.</p>


<div class="tabs">
  <input type="radio" name="data_integration" id="sct" checked="checked">
  <label for="sct">SCT</label>
  <div class="tab">


<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-r" data-lang="r">seurat_list <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">SplitObject</span>(seurat, split.by <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">sample&#39;</span>)

seurat_list <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">lapply</span>(
  X <span style="color:#000;font-weight:bold">=</span> seurat_list,
  FUN <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">function</span>(x) {
    x <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">SCTransform</span>(x)
  }
)

seurat_features <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">SelectIntegrationFeatures</span>(
  seurat_list,
  nfeatures <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">3000</span>
)

seurat_list <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">PrepSCTIntegration</span>(
  seurat_list,
  anchor.features <span style="color:#000;font-weight:bold">=</span> seurat_features
)

seurat_anchors <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">FindIntegrationAnchors</span>(
  object.list <span style="color:#000;font-weight:bold">=</span> seurat_list,
  anchor.features <span style="color:#000;font-weight:bold">=</span> seurat_features,
  normalization.method <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">SCT&#39;</span>,
  reference <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">which</span>(<span style="color:#900;font-weight:bold">grepl</span>(<span style="color:#900;font-weight:bold">names</span>(seurat_list), pattern <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">AML&#39;</span>) <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">FALSE</span>)
)

seurat <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">IntegrateData</span>(
  anchorset <span style="color:#000;font-weight:bold">=</span> seurat_anchors,
  normalization.method <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">SCT&#39;</span>
)

seurat<span style="color:#000;font-weight:bold">@</span>meta.data<span style="color:#000;font-weight:bold">$</span>sample <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">Cells</span>(seurat) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">strsplit</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">-&#39;</span>) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">vapply</span>(FUN.VALUE <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">character</span>(<span style="color:#099">1</span>), `[`, <span style="color:#099">2</span>)
seurat<span style="color:#000;font-weight:bold">@</span>meta.data<span style="color:#000;font-weight:bold">$</span>sample <span style="color:#000;font-weight:bold">&lt;-</span> seurat<span style="color:#000;font-weight:bold">@</span>meta.data<span style="color:#000;font-weight:bold">$</span>sample <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">factor</span>(levels <span style="color:#000;font-weight:bold">=</span> sample_names<span style="color:#900;font-weight:bold">[which</span>(sample_names <span style="color:#000;font-weight:bold">%in%</span> .)])
</code></pre></div>

  </div>
  <input type="radio" name="data_integration" id="sct_pca">
  <label for="sct_pca">SCT + PCA</label>
  <div class="tab">


<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-r" data-lang="r">seurat_list <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">SplitObject</span>(seurat, split.by <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">sample&#39;</span>)

seurat_list <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">lapply</span>(
  X <span style="color:#000;font-weight:bold">=</span> seurat_list,
  FUN <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">function</span>(x) {
    x <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">SCTransform</span>(x)
  }
)

seurat_features <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">SelectIntegrationFeatures</span>(
  seurat_list,
  nfeatures <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">3000</span>
)

seurat_list <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">PrepSCTIntegration</span>(
  seurat_list,
  anchor.features <span style="color:#000;font-weight:bold">=</span> seurat_features
)

seurat_list <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">lapply</span>(
  X <span style="color:#000;font-weight:bold">=</span> seurat_list,
  FUN <span style="color:#000;font-weight:bold">=</span> RunPCA,
  verbose <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">FALSE</span>,
  features <span style="color:#000;font-weight:bold">=</span> seurat_features
)

seurat_anchors <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">FindIntegrationAnchors</span>(
  object.list <span style="color:#000;font-weight:bold">=</span> seurat_list,
  anchor.features <span style="color:#000;font-weight:bold">=</span> seurat_features,
  normalization.method <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">SCT&#39;</span>,
  reduction <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">rpca&#39;</span>,
  reference <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">which</span>(<span style="color:#900;font-weight:bold">grepl</span>(<span style="color:#900;font-weight:bold">names</span>(seurat_list), pattern <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">AML&#39;</span>) <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">FALSE</span>)
)

seurat <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">IntegrateData</span>(
  anchorset <span style="color:#000;font-weight:bold">=</span> seurat_anchors,
  normalization.method <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">SCT&#39;</span>
)

seurat<span style="color:#000;font-weight:bold">@</span>meta.data<span style="color:#000;font-weight:bold">$</span>sample <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">Cells</span>(seurat) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">strsplit</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">-&#39;</span>) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">vapply</span>(FUN.VALUE <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">character</span>(<span style="color:#099">1</span>), `[`, <span style="color:#099">2</span>)
seurat<span style="color:#000;font-weight:bold">@</span>meta.data<span style="color:#000;font-weight:bold">$</span>sample <span style="color:#000;font-weight:bold">&lt;-</span> seurat<span style="color:#000;font-weight:bold">@</span>meta.data<span style="color:#000;font-weight:bold">$</span>sample <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">factor</span>(levels <span style="color:#000;font-weight:bold">=</span> sample_names<span style="color:#900;font-weight:bold">[which</span>(sample_names <span style="color:#000;font-weight:bold">%in%</span> .)])
</code></pre></div>

  </div>
</div>


<h2 id="principal-component-analysis">Principal component analysis</h2>
<p>Principal component analysis (PCA) is frequently used as a first step to reduce the dimensionality of the data set.
Here, we calculate the first 50 principal components.
Then, we must choose how many to continue the analysis with.
In a recent paper by Germain <em>et al.</em> [2], it is suggested to use the <code>maxLikGlobalDimEst()</code> function from the <a href="https://cran.r-project.org/web/packages/intrinsicDimension/index.html"><code>intrinsicDimension</code></a> package to test the dimensionality of the data set.
For this, one must also choose a value for the parameter <code>k</code>.
In my experience, values in the range of <code>10-20</code> give reasonable and not too different results.
In the plot of the PCA results shown below, I highlight the output value of <code>maxLikGlobalDimEst()</code> (blue line), which here is close to <code>10</code>.
In my opinion, that is an underestimation so I will proceed with the first 15 PCs (red line).
Also, it is generally better to be generous with PCs as compared to using too few.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-r" data-lang="r">seurat <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">RunPCA</span>(seurat, assay <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">SCT&#39;</span>, npcs <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">50</span>)

intrinsicDimension<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">maxLikGlobalDimEst</span>(seurat<span style="color:#000;font-weight:bold">@</span>reductions<span style="color:#000;font-weight:bold">$</span>pca<span style="color:#000;font-weight:bold">@</span>cell.embeddings, k <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">10</span>)
<span style="color:#998;font-style:italic"># 10.44694</span>

p <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">tibble</span>(
    PC <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">1</span><span style="color:#000;font-weight:bold">:</span><span style="color:#099">50</span>,
    stdev <span style="color:#000;font-weight:bold">=</span> seurat<span style="color:#000;font-weight:bold">@</span>reductions<span style="color:#000;font-weight:bold">$</span>pca<span style="color:#000;font-weight:bold">@</span>stdev
  ) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">ggplot</span>(<span style="color:#900;font-weight:bold">aes</span>(PC, stdev)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_point</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_vline</span>(xintercept <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">10</span>, color <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">blue&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_vline</span>(xintercept <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">15</span>, color <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">red&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme_bw</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">labs</span>(x <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Principal components&#39;</span>, y <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Standard deviation&#39;</span>)

<span style="color:#900;font-weight:bold">ggsave</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">plots/principal_components.png&#39;</span>, p, height <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">4</span>, width <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">5</span>)
</code></pre></div>
<figure >
  
    <a href="/images/projects/scrnaseq_workflow/principal_components.png" target="_blank">
      <img src="/images/projects/scrnaseq_workflow/principal_components.jpg"  style="width: 100%; max-width: 1000px" />
    </a>
  
  
</figure>


<h2 id="clustering">Clustering</h2>
<p>Time to identify clusters of cells with relatively homogeneous transcription profiles.</p>
<h3 id="define-cluster">Define cluster</h3>
<p>We use the <code>FindNeighbors()</code> and <code>FindClusters()</code> functions built into <a href="https://satijalab.org/seurat/">Seurat</a> to cluster the cells in our data set.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-r" data-lang="r">seurat <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">FindNeighbors</span>(seurat, reduction <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">pca&#39;</span>, dims <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">1</span><span style="color:#000;font-weight:bold">:</span><span style="color:#099">15</span>)
seurat <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">FindClusters</span>(seurat, resolution <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0.8</span>)
</code></pre></div><h3 id="number-of-transcripts-and-expressed-genes">Number of transcripts and expressed genes</h3>
<p>As we did for the samples, we check the average number of transcripts and expressed genes for every cluster.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-r" data-lang="r">temp_labels <span style="color:#000;font-weight:bold">&lt;-</span> seurat<span style="color:#000;font-weight:bold">@</span>meta.data <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">group_by</span>(seurat_clusters) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">tally</span>()

p1 <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">ggplot</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_half_violin</span>(
    data <span style="color:#000;font-weight:bold">=</span> seurat<span style="color:#000;font-weight:bold">@</span>meta.data, <span style="color:#900;font-weight:bold">aes</span>(seurat_clusters, nCount_RNA, fill <span style="color:#000;font-weight:bold">=</span> seurat_clusters),
    side <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">l&#39;</span>, show.legend <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">FALSE</span>, trim <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">FALSE</span>
  ) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_half_boxplot</span>(
    data <span style="color:#000;font-weight:bold">=</span> seurat<span style="color:#000;font-weight:bold">@</span>meta.data, <span style="color:#900;font-weight:bold">aes</span>(seurat_clusters, nCount_RNA, fill <span style="color:#000;font-weight:bold">=</span> seurat_clusters),
    side <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">r&#39;</span>, outlier.color <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">NA</span>, width <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0.4</span>, show.legend <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">FALSE</span>
  ) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_text</span>(
    data <span style="color:#000;font-weight:bold">=</span> temp_labels,
    <span style="color:#900;font-weight:bold">aes</span>(x <span style="color:#000;font-weight:bold">=</span> seurat_clusters, y <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">Inf</span>, label <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">paste0</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">n = &#39;</span>, <span style="color:#900;font-weight:bold">format</span>(n, big.mark <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">,&#39;</span>, trim <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">TRUE</span>)), vjust <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">-1</span>),
    color <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">black&#39;</span>, size <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">2.8</span>
  ) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_color_manual</span>(values <span style="color:#000;font-weight:bold">=</span> custom_colors<span style="color:#000;font-weight:bold">$</span>discrete) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_fill_manual</span>(values <span style="color:#000;font-weight:bold">=</span> custom_colors<span style="color:#000;font-weight:bold">$</span>discrete) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_y_continuous</span>(name <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Number of transcripts&#39;</span>, labels <span style="color:#000;font-weight:bold">=</span> scales<span style="color:#000;font-weight:bold">::</span>comma, expand <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">c</span>(<span style="color:#099">0.08</span>, <span style="color:#099">0</span>)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme_bw</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme</span>(
    panel.grid.major.x <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    axis.title.x <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>()
  )

p2 <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">ggplot</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_half_violin</span>(
    data <span style="color:#000;font-weight:bold">=</span> seurat<span style="color:#000;font-weight:bold">@</span>meta.data, <span style="color:#900;font-weight:bold">aes</span>(seurat_clusters, nFeature_RNA, fill <span style="color:#000;font-weight:bold">=</span> seurat_clusters),
    side <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">l&#39;</span>, show.legend <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">FALSE</span>, trim <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">FALSE</span>
  ) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_half_boxplot</span>(
    data <span style="color:#000;font-weight:bold">=</span> seurat<span style="color:#000;font-weight:bold">@</span>meta.data, <span style="color:#900;font-weight:bold">aes</span>(seurat_clusters, nFeature_RNA, fill <span style="color:#000;font-weight:bold">=</span> seurat_clusters),
    side <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">r&#39;</span>, outlier.color <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">NA</span>, width <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0.4</span>, show.legend <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">FALSE</span>
  ) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_text</span>(
    data <span style="color:#000;font-weight:bold">=</span> temp_labels,
    <span style="color:#900;font-weight:bold">aes</span>(x <span style="color:#000;font-weight:bold">=</span> seurat_clusters, y <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">Inf</span>, label <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">paste0</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">n = &#39;</span>, <span style="color:#900;font-weight:bold">format</span>(n, big.mark <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">,&#39;</span>, trim <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">TRUE</span>)), vjust <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">-1</span>),
    color <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">black&#39;</span>, size <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">2.8</span>
  ) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_color_manual</span>(values <span style="color:#000;font-weight:bold">=</span> custom_colors<span style="color:#000;font-weight:bold">$</span>discrete) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_fill_manual</span>(values <span style="color:#000;font-weight:bold">=</span> custom_colors<span style="color:#000;font-weight:bold">$</span>discrete) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_y_continuous</span>(name <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Number of expressed genes&#39;</span>, labels <span style="color:#000;font-weight:bold">=</span> scales<span style="color:#000;font-weight:bold">::</span>comma, expand <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">c</span>(<span style="color:#099">0.08</span>, <span style="color:#099">0</span>)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme_bw</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme</span>(
    panel.grid.major.x <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    axis.title.x <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>()
  )

<span style="color:#900;font-weight:bold">ggsave</span>(
  <span style="color:#d14">&#39;</span><span style="color:#d14">plots/nCount_nFeature_by_cluster.png&#39;</span>,
  p1 <span style="color:#000;font-weight:bold">+</span> p2 <span style="color:#000;font-weight:bold">+</span> <span style="color:#900;font-weight:bold">plot_layout</span>(ncol <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">1</span>),
  height <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">7</span>, width <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">14</span>
)
</code></pre></div>
<figure >
  
    <a href="/images/projects/scrnaseq_workflow/nCount_nFeature_by_cluster.png" target="_blank">
      <img src="/images/projects/scrnaseq_workflow/nCount_nFeature_by_cluster.jpg"  style="width: 100%; max-width: 1000px" />
    </a>
  
  
</figure>


<h3 id="cluster-stability">Cluster stability</h3>
<p>We use the <code>bootstrapCluster()</code> function from the <code>scran</code> package as described <a href="https://bioconductor.org/packages/devel/bioc/vignettes/scran/inst/doc/scran.html">here</a>.
We represent the co-assignment probabilities as a heatmap.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-r" data-lang="r">sce <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">as.SingleCellExperiment</span>(seurat)
<span style="color:#900;font-weight:bold">reducedDim</span>(sce, <span style="color:#d14">&#39;</span><span style="color:#d14">PCA_sub&#39;</span>) <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">reducedDim</span>(sce, <span style="color:#d14">&#39;</span><span style="color:#d14">PCA&#39;</span>)[,<span style="color:#099">1</span><span style="color:#000;font-weight:bold">:</span><span style="color:#099">15</span>, drop <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">FALSE</span>]

ass_prob <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">bootstrapCluster</span>(sce, FUN <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">function</span>(x) {
    g <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">buildSNNGraph</span>(x, use.dimred <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">PCA_sub&#39;</span>)
    igraph<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">cluster_walktrap</span>(g)<span style="color:#000;font-weight:bold">$</span>membership
  },
  clusters <span style="color:#000;font-weight:bold">=</span> sce<span style="color:#000;font-weight:bold">$</span>seurat_clusters
)

p <span style="color:#000;font-weight:bold">&lt;-</span> ass_prob <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">as_tibble</span>() <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">rownames_to_column</span>(var <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">cluster_1&#39;</span>) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">pivot_longer</span>(
    cols <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">2</span><span style="color:#000;font-weight:bold">:</span><span style="color:#900;font-weight:bold">ncol</span>(.),
    names_to <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">cluster_2&#39;</span>,
    values_to <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">probability&#39;</span>
  ) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">mutate</span>(
    cluster_1 <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">as.character</span>(<span style="color:#900;font-weight:bold">as.numeric</span>(cluster_1) <span style="color:#000;font-weight:bold">-</span> <span style="color:#099">1</span>),
    cluster_1 <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">factor</span>(cluster_1, levels <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">rev</span>(<span style="color:#900;font-weight:bold">unique</span>(cluster_1))),
    cluster_2 <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">factor</span>(cluster_2, levels <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">unique</span>(cluster_2))
  ) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">ggplot</span>(<span style="color:#900;font-weight:bold">aes</span>(cluster_2, cluster_1, fill <span style="color:#000;font-weight:bold">=</span> probability)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_tile</span>(color <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">white&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_text</span>(<span style="color:#900;font-weight:bold">aes</span>(label <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">round</span>(probability, digits <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">2</span>)), size <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">2.5</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_x_discrete</span>(name <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Cluster&#39;</span>, position <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">top&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_y_discrete</span>(name <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Cluster&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_fill_gradient</span>(
    name <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Probability&#39;</span>, low <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">white&#39;</span>, high <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">#c0392b&#39;</span>, na.value <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">#bdc3c7&#39;</span>,
    limits <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">c</span>(<span style="color:#099">0</span>,<span style="color:#099">1</span>),
    guide <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">guide_colorbar</span>(
      frame.colour <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">black&#39;</span>, ticks.colour <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">black&#39;</span>, title.position <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">left&#39;</span>,
      title.theme <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_text</span>(hjust <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">1</span>, angle <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">90</span>),
      barwidth <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0.75</span>, barheight <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">10</span>
    )
  ) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">coord_fixed</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme_bw</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme</span>(
    legend.position <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">right&#39;</span>,
    panel.grid.major <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>()
  )

<span style="color:#900;font-weight:bold">ggsave</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">plots/cluster_stability.png&#39;</span>, p, height <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">6</span>, width <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">7</span>)
</code></pre></div>
<figure >
  
    <a href="/images/projects/scrnaseq_workflow/cluster_stability.png" target="_blank">
      <img src="/images/projects/scrnaseq_workflow/cluster_stability.jpg"  style="width: 100%; max-width: 1000px" />
    </a>
  
  
</figure>


<h3 id="silhouette-plot">Silhouette plot</h3>
<ul>
<li>General info about a silhouette plot: <a href="https://scikit-learn.org/stable/auto_examples/cluster/plot_kmeans_silhouette_analysis.html">link</a></li>
<li>Code to calculate silhouette score (from Seurat people): <a href="https://github.com/satijalab/Integration2019/blob/master/analysis_code/integration/integration_metrics.R#L36">link</a></li>
</ul>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-r" data-lang="r"><span style="color:#900;font-weight:bold">library</span>(cluster)

distance_matrix <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">dist</span>(<span style="color:#900;font-weight:bold">Embeddings</span>(seurat[[<span style="color:#d14">&#39;</span><span style="color:#d14">pca&#39;</span>]])[, <span style="color:#099">1</span><span style="color:#000;font-weight:bold">:</span><span style="color:#099">15</span>])
clusters <span style="color:#000;font-weight:bold">&lt;-</span> seurat<span style="color:#000;font-weight:bold">@</span>meta.data<span style="color:#000;font-weight:bold">$</span>seurat_clusters
silhouette <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">silhouette</span>(<span style="color:#900;font-weight:bold">as.numeric</span>(clusters), dist <span style="color:#000;font-weight:bold">=</span> distance_matrix)
seurat<span style="color:#000;font-weight:bold">@</span>meta.data<span style="color:#000;font-weight:bold">$</span>silhouette_score <span style="color:#000;font-weight:bold">&lt;-</span> silhouette[,<span style="color:#099">3</span>]

mean_silhouette_score <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">mean</span>(seurat<span style="color:#000;font-weight:bold">@</span>meta.data<span style="color:#000;font-weight:bold">$</span>silhouette_score)

p <span style="color:#000;font-weight:bold">&lt;-</span> seurat<span style="color:#000;font-weight:bold">@</span>meta.data <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">mutate</span>(barcode <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">rownames</span>(.)) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">arrange</span>(seurat_clusters,<span style="color:#000;font-weight:bold">-</span>silhouette_score) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">mutate</span>(barcode <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">factor</span>(barcode, levels <span style="color:#000;font-weight:bold">=</span> barcode)) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">ggplot</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_col</span>(<span style="color:#900;font-weight:bold">aes</span>(barcode, silhouette_score, fill <span style="color:#000;font-weight:bold">=</span> seurat_clusters), show.legend <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">FALSE</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_hline</span>(yintercept <span style="color:#000;font-weight:bold">=</span> mean_silhouette_score, color <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">red&#39;</span>, linetype <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">dashed&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_x_discrete</span>(name <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Cells&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_y_continuous</span>(name <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Silhouette score&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_fill_manual</span>(values <span style="color:#000;font-weight:bold">=</span> custom_colors<span style="color:#000;font-weight:bold">$</span>discrete) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme_bw</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme</span>(
    axis.title.x <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    axis.text.x <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    axis.ticks.x <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    panel.grid.major <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    panel.grid.minor <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>()
  )
<span style="color:#900;font-weight:bold">ggsave</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">plots/silhouette_plot.png&#39;</span>, p, height <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">4</span>, width <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">8</span>)
</code></pre></div>
<figure >
  
    <a href="/images/projects/scrnaseq_workflow/silhouette_plot.png" target="_blank">
      <img src="/images/projects/scrnaseq_workflow/silhouette_plot.jpg"  style="width: 100%; max-width: 1000px" />
    </a>
  
  
</figure>


<h3 id="cluster-similarity">Cluster similarity</h3>
<p>Here, we use the <code>clusterModularity()</code> function from the <code>scran</code> package as described <a href="https://bioconductor.org/packages/devel/bioc/vignettes/scran/inst/doc/scran.html">here</a>.
The heatmap below shows the difference between the observed and expected edge weights between each cluster pair.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-r" data-lang="r">sce <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">as.SingleCellExperiment</span>(seurat)

<span style="color:#900;font-weight:bold">reducedDim</span>(sce, <span style="color:#d14">&#39;</span><span style="color:#d14">PCA_sub&#39;</span>) <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">reducedDim</span>(sce, <span style="color:#d14">&#39;</span><span style="color:#d14">PCA&#39;</span>)[,<span style="color:#099">1</span><span style="color:#000;font-weight:bold">:</span><span style="color:#099">15</span>, drop <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">FALSE</span>]

g <span style="color:#000;font-weight:bold">&lt;-</span> scran<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">buildSNNGraph</span>(sce, use.dimred <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">PCA_sub&#39;</span>)

ratio <span style="color:#000;font-weight:bold">&lt;-</span> scran<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">clusterModularity</span>(g, seurat<span style="color:#000;font-weight:bold">@</span>meta.data<span style="color:#000;font-weight:bold">$</span>seurat_clusters, as.ratio <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">TRUE</span>)

ratio_to_plot <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">log10</span>(ratio<span style="color:#099">+1</span>)

p <span style="color:#000;font-weight:bold">&lt;-</span> ratio_to_plot <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">as_tibble</span>() <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">rownames_to_column</span>(var <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">cluster_1&#39;</span>) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">pivot_longer</span>(
    cols <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">2</span><span style="color:#000;font-weight:bold">:</span><span style="color:#900;font-weight:bold">ncol</span>(.),
    names_to <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">cluster_2&#39;</span>,
    values_to <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">probability&#39;</span>
  ) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">mutate</span>(
    cluster_1 <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">as.character</span>(<span style="color:#900;font-weight:bold">as.numeric</span>(cluster_1) <span style="color:#000;font-weight:bold">-</span> <span style="color:#099">1</span>),
    cluster_1 <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">factor</span>(cluster_1, levels <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">rev</span>(<span style="color:#900;font-weight:bold">unique</span>(cluster_1))),
    cluster_2 <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">factor</span>(cluster_2, levels <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">unique</span>(cluster_2))
  ) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">ggplot</span>(<span style="color:#900;font-weight:bold">aes</span>(cluster_2, cluster_1, fill <span style="color:#000;font-weight:bold">=</span> probability)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_tile</span>(color <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">white&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_text</span>(<span style="color:#900;font-weight:bold">aes</span>(label <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">round</span>(probability, digits <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">2</span>)), size <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">2.5</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_x_discrete</span>(name <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Cluster&#39;</span>, position <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">top&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_y_discrete</span>(name <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Cluster&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_fill_gradient</span>(
    name <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">log10(ratio)&#39;</span>, low <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">white&#39;</span>, high <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">#c0392b&#39;</span>, na.value <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">#bdc3c7&#39;</span>,
    guide <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">guide_colorbar</span>(
      frame.colour <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">black&#39;</span>, ticks.colour <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">black&#39;</span>, title.position <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">left&#39;</span>,
      title.theme <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_text</span>(hjust <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">1</span>, angle <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">90</span>),
      barwidth <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0.75</span>, barheight <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">10</span>
    )
  ) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">coord_fixed</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme_bw</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme</span>(
    legend.position <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">right&#39;</span>,
    panel.grid.major <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>()
  )

<span style="color:#900;font-weight:bold">ggsave</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">plots/cluster_similarity.png&#39;</span>, p, height <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">6</span>, width <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">7</span>)
</code></pre></div>
<figure >
  
    <a href="/images/projects/scrnaseq_workflow/cluster_similarity.png" target="_blank">
      <img src="/images/projects/scrnaseq_workflow/cluster_similarity.jpg"  style="width: 100%; max-width: 1000px" />
    </a>
  
  
</figure>


<h3 id="cluster-tree">Cluster tree</h3>
<p>The relationship (similarity) between clusters can be represented in a cluster tree.
I find this useful to identify which clusters might be candidates for merging.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-r" data-lang="r">seurat <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">BuildClusterTree</span>(
  seurat,
  dims <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">1</span><span style="color:#000;font-weight:bold">:</span><span style="color:#099">15</span>,
  reorder <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">FALSE</span>,
  reorder.numeric <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">FALSE</span>
)

tree <span style="color:#000;font-weight:bold">&lt;-</span> seurat<span style="color:#000;font-weight:bold">@</span>tools<span style="color:#000;font-weight:bold">$</span>BuildClusterTree
tree<span style="color:#000;font-weight:bold">$</span>tip.label <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">paste0</span>(<span style="color:#d14">&#34;</span><span style="color:#d14">Cluster &#34;</span>, tree<span style="color:#000;font-weight:bold">$</span>tip.label)

p <span style="color:#000;font-weight:bold">&lt;-</span> ggtree<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">ggtree</span>(tree, <span style="color:#900;font-weight:bold">aes</span>(x, y)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_y_reverse</span>() <span style="color:#000;font-weight:bold">+</span>
  ggtree<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">geom_tree</span>() <span style="color:#000;font-weight:bold">+</span>
  ggtree<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">theme_tree</span>() <span style="color:#000;font-weight:bold">+</span>
  ggtree<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">geom_tiplab</span>(offset <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">1</span>) <span style="color:#000;font-weight:bold">+</span>
  ggtree<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">geom_tippoint</span>(color <span style="color:#000;font-weight:bold">=</span> custom_colors<span style="color:#000;font-weight:bold">$</span>discrete[1<span style="color:#000;font-weight:bold">:</span><span style="color:#900;font-weight:bold">length</span>(tree<span style="color:#000;font-weight:bold">$</span>tip.label)], shape <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">16</span>, size <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">5</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">coord_cartesian</span>(clip <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">off&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme</span>(plot.margin <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">unit</span>(<span style="color:#900;font-weight:bold">c</span>(<span style="color:#099">0</span>,<span style="color:#099">2.5</span>,<span style="color:#099">0</span>,<span style="color:#099">0</span>), <span style="color:#d14">&#39;</span><span style="color:#d14">cm&#39;</span>))

<span style="color:#900;font-weight:bold">ggsave</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">plots/cluster_tree.png&#39;</span>, p, height <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">4</span>, width <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">6</span>)
</code></pre></div>
<figure >
  
    <a href="/images/projects/scrnaseq_workflow/cluster_tree.png" target="_blank">
      <img src="/images/projects/scrnaseq_workflow/cluster_tree.jpg"  style="width: 100%; max-width: 1000px" />
    </a>
  
  
</figure>


<h3 id="composition-of-samples-and-clusters">Composition of samples and clusters</h3>
<p>Having two major groupings for our cells (sample and cluster), we can now check the composition of each with respect to the other, i.e. how are samples composed by clusters and how are cluster composed by samples?
This gives us an idea whether some clusters are specific to one sample.</p>
<p>Samples:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-r" data-lang="r">table_samples_by_clusters <span style="color:#000;font-weight:bold">&lt;-</span> seurat<span style="color:#000;font-weight:bold">@</span>meta.data <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">group_by</span>(sample, seurat_clusters) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">summarize</span>(count <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">n</span>()) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">spread</span>(seurat_clusters, count, fill <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">ungroup</span>() <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">mutate</span>(total_cell_count <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">rowSums</span>(<span style="color:#900;font-weight:bold">.[c</span>(<span style="color:#099">2</span><span style="color:#000;font-weight:bold">:</span><span style="color:#900;font-weight:bold">ncol</span>(.))])) <span style="color:#000;font-weight:bold">%&gt;%</span>
  dplyr<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">select</span>(<span style="color:#900;font-weight:bold">c</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">sample&#39;</span>, <span style="color:#d14">&#39;</span><span style="color:#d14">total_cell_count&#39;</span>, <span style="color:#900;font-weight:bold">everything</span>())) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">arrange</span>(<span style="color:#900;font-weight:bold">factor</span>(sample, levels <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">levels</span>(seurat<span style="color:#000;font-weight:bold">@</span>meta.data<span style="color:#000;font-weight:bold">$</span>sample)))

knitr<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">kable</span>(table_samples_by_clusters)
<span style="color:#998;font-style:italic"># |sample | total_cell_count|   0|   1|   2|   3|   4|   5|   6|   7|   8|   9| 10| 11|  12| 13| 14| 15| 16| 17| 18|</span>
<span style="color:#998;font-style:italic"># |:------|----------------:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|--:|--:|---:|--:|--:|--:|--:|--:|--:|</span>
<span style="color:#998;font-style:italic"># |A      |             1696| 301| 137| 121| 223|  78|  70|  36| 100| 141| 120| 36| 30| 100| 53| 15| 49| 44| 36|  6|</span>
<span style="color:#998;font-style:italic"># |B      |             1818| 512| 297|  85| 151|  50|  31|  84|  94|  36|  41| 77| 52|  41| 70| 84| 43| 36| 31|  3|</span>
<span style="color:#998;font-style:italic"># |E      |             1881| 325| 182| 297|  55| 225| 233| 170|  35|  37|  34| 80| 99|  11| 27| 19| 18| 10|  9| 15|</span>
</code></pre></div><p>Clusters:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-r" data-lang="r">table_clusters_by_samples <span style="color:#000;font-weight:bold">&lt;-</span> seurat<span style="color:#000;font-weight:bold">@</span>meta.data <span style="color:#000;font-weight:bold">%&gt;%</span>
  dplyr<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">rename</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">cluster&#39;</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">seurat_clusters&#39;</span>) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">group_by</span>(cluster, sample) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">summarize</span>(count <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">n</span>()) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">spread</span>(sample, count, fill <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">ungroup</span>() <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">mutate</span>(total_cell_count <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">rowSums</span>(<span style="color:#900;font-weight:bold">.[c</span>(<span style="color:#099">2</span><span style="color:#000;font-weight:bold">:</span><span style="color:#900;font-weight:bold">ncol</span>(.))])) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">select</span>(<span style="color:#900;font-weight:bold">c</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">cluster&#39;</span>, <span style="color:#d14">&#39;</span><span style="color:#d14">total_cell_count&#39;</span>, <span style="color:#900;font-weight:bold">everything</span>())) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">arrange</span>(<span style="color:#900;font-weight:bold">factor</span>(cluster, levels <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">levels</span>(seurat<span style="color:#000;font-weight:bold">@</span>meta.data<span style="color:#000;font-weight:bold">$</span>seurat_clusters)))

knitr<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">kable</span>(table_clusters_by_samples)
<span style="color:#998;font-style:italic"># |cluster | total_cell_count|   A|   B|   E|</span>
<span style="color:#998;font-style:italic"># |:-------|----------------:|---:|---:|---:|</span>
<span style="color:#998;font-style:italic"># |0       |             1138| 301| 512| 325|</span>
<span style="color:#998;font-style:italic"># |1       |              616| 137| 297| 182|</span>
<span style="color:#998;font-style:italic"># |2       |              503| 121|  85| 297|</span>
<span style="color:#998;font-style:italic"># |3       |              429| 223| 151|  55|</span>
<span style="color:#998;font-style:italic"># |4       |              353|  78|  50| 225|</span>
<span style="color:#998;font-style:italic"># |5       |              334|  70|  31| 233|</span>
<span style="color:#998;font-style:italic"># |6       |              290|  36|  84| 170|</span>
<span style="color:#998;font-style:italic"># |7       |              229| 100|  94|  35|</span>
<span style="color:#998;font-style:italic"># |8       |              214| 141|  36|  37|</span>
<span style="color:#998;font-style:italic"># |9       |              195| 120|  41|  34|</span>
<span style="color:#998;font-style:italic"># |10      |              193|  36|  77|  80|</span>
<span style="color:#998;font-style:italic"># |11      |              181|  30|  52|  99|</span>
<span style="color:#998;font-style:italic"># |12      |              152| 100|  41|  11|</span>
<span style="color:#998;font-style:italic"># |13      |              150|  53|  70|  27|</span>
<span style="color:#998;font-style:italic"># |14      |              118|  15|  84|  19|</span>
<span style="color:#998;font-style:italic"># |15      |              110|  49|  43|  18|</span>
<span style="color:#998;font-style:italic"># |16      |               90|  44|  36|  10|</span>
<span style="color:#998;font-style:italic"># |17      |               76|  36|  31|   9|</span>
<span style="color:#998;font-style:italic"># |18      |               24|   6|   3|  15|</span>
</code></pre></div>

<div class="tabs">
  <input type="radio" name="composition_samples_clusters_1" id="composition_samples_clusters_1_1" checked="checked">
  <label for="composition_samples_clusters_1_1">Number of cells</label>
  <div class="tab">


<p>Shown below is the composition of samples/clusters by actual number of cells.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-r" data-lang="r">temp_labels <span style="color:#000;font-weight:bold">&lt;-</span> seurat<span style="color:#000;font-weight:bold">@</span>meta.data <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">group_by</span>(sample) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">tally</span>()

p1 <span style="color:#000;font-weight:bold">&lt;-</span> table_samples_by_clusters <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">select</span>(<span style="color:#000;font-weight:bold">-</span><span style="color:#900;font-weight:bold">c</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">total_cell_count&#39;</span>)) <span style="color:#000;font-weight:bold">%&gt;%</span>
  reshape2<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">melt</span>(id.vars <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">sample&#39;</span>) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">mutate</span>(sample <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">factor</span>(sample, levels <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">levels</span>(seurat<span style="color:#000;font-weight:bold">@</span>meta.data<span style="color:#000;font-weight:bold">$</span>sample))) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">ggplot</span>(<span style="color:#900;font-weight:bold">aes</span>(sample, value)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_bar</span>(<span style="color:#900;font-weight:bold">aes</span>(fill <span style="color:#000;font-weight:bold">=</span> variable), position <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">stack&#39;</span>, stat <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">identity&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_text</span>(
    data <span style="color:#000;font-weight:bold">=</span> temp_labels,
    <span style="color:#900;font-weight:bold">aes</span>(x <span style="color:#000;font-weight:bold">=</span> sample, y <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">Inf</span>, label <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">paste0</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">n = &#39;</span>, <span style="color:#900;font-weight:bold">format</span>(n, big.mark <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">,&#39;</span>, trim <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">TRUE</span>)), vjust <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">-1</span>),
    color <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">black&#39;</span>, size <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">2.8</span>
  ) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_fill_manual</span>(name <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Cluster&#39;</span>, values <span style="color:#000;font-weight:bold">=</span> custom_colors<span style="color:#000;font-weight:bold">$</span>discrete) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_y_continuous</span>(name <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Number of cells&#39;</span>, labels <span style="color:#000;font-weight:bold">=</span> scales<span style="color:#000;font-weight:bold">::</span>comma, expand <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">c</span>(<span style="color:#099">0.01</span>, <span style="color:#099">0</span>)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">coord_cartesian</span>(clip <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">off&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme_bw</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme</span>(
    legend.position <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">left&#39;</span>,
    plot.title <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_text</span>(hjust <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0.5</span>),
    text <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_text</span>(size <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">16</span>),
    panel.grid.major <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    panel.grid.minor <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    axis.title.x <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    axis.text.x <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_text</span>(angle <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">45</span>, hjust <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">1</span>, vjust <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">1</span>),
    plot.margin <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">margin</span>(t <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">20</span>, r <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>, b <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>, l <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>, unit <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">pt&#39;</span>)
  )

temp_labels <span style="color:#000;font-weight:bold">&lt;-</span> seurat<span style="color:#000;font-weight:bold">@</span>meta.data <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">group_by</span>(seurat_clusters) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">tally</span>() <span style="color:#000;font-weight:bold">%&gt;%</span>
  dplyr<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">rename</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">cluster&#39;</span> <span style="color:#000;font-weight:bold">=</span> seurat_clusters)

p2 <span style="color:#000;font-weight:bold">&lt;-</span> table_clusters_by_samples <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">select</span>(<span style="color:#000;font-weight:bold">-</span><span style="color:#900;font-weight:bold">c</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">total_cell_count&#39;</span>)) <span style="color:#000;font-weight:bold">%&gt;%</span>
  reshape2<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">melt</span>(id.vars <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">cluster&#39;</span>) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">mutate</span>(cluster <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">factor</span>(cluster, levels <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">levels</span>(seurat<span style="color:#000;font-weight:bold">@</span>meta.data<span style="color:#000;font-weight:bold">$</span>seurat_clusters))) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">ggplot</span>(<span style="color:#900;font-weight:bold">aes</span>(cluster, value)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_bar</span>(<span style="color:#900;font-weight:bold">aes</span>(fill <span style="color:#000;font-weight:bold">=</span> variable), position <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">stack&#39;</span>, stat <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">identity&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_text</span>(
    data <span style="color:#000;font-weight:bold">=</span> temp_labels,
    <span style="color:#900;font-weight:bold">aes</span>(x <span style="color:#000;font-weight:bold">=</span> cluster, y <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">Inf</span>, label <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">paste0</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">n = &#39;</span>, <span style="color:#900;font-weight:bold">format</span>(n, big.mark <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">,&#39;</span>, trim <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">TRUE</span>)), vjust <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">-1</span>),
    color <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">black&#39;</span>, size <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">2.8</span>
  ) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_fill_manual</span>(name <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Sample&#39;</span>, values <span style="color:#000;font-weight:bold">=</span> custom_colors<span style="color:#000;font-weight:bold">$</span>discrete) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_y_continuous</span>(labels <span style="color:#000;font-weight:bold">=</span> scales<span style="color:#000;font-weight:bold">::</span>comma, expand <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">c</span>(<span style="color:#099">0.01</span>, <span style="color:#099">0</span>)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">coord_cartesian</span>(clip <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">off&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme_bw</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme</span>(
    legend.position <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">right&#39;</span>,
    plot.title <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_text</span>(hjust <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0.5</span>),
    text <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_text</span>(size <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">16</span>),
    panel.grid.major <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    panel.grid.minor <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    axis.title <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    plot.margin <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">margin</span>(t <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">20</span>, r <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>, b <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>, l <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">10</span>, unit <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">pt&#39;</span>)
  )

<span style="color:#900;font-weight:bold">ggsave</span>(
  <span style="color:#d14">&#39;</span><span style="color:#d14">plots/composition_samples_clusters_by_number.png&#39;</span>,
  p1 <span style="color:#000;font-weight:bold">+</span> p2 <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">plot_layout</span>(ncol <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">2</span>, widths <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">c</span>(
    seurat<span style="color:#000;font-weight:bold">@</span>meta.data<span style="color:#000;font-weight:bold">$</span>sample <span style="color:#000;font-weight:bold">%&gt;%</span> <span style="color:#900;font-weight:bold">unique</span>() <span style="color:#000;font-weight:bold">%&gt;%</span> <span style="color:#900;font-weight:bold">length</span>(),
    seurat<span style="color:#000;font-weight:bold">@</span>meta.data<span style="color:#000;font-weight:bold">$</span>seurat_clusters <span style="color:#000;font-weight:bold">%&gt;%</span> <span style="color:#900;font-weight:bold">unique</span>() <span style="color:#000;font-weight:bold">%&gt;%</span> <span style="color:#900;font-weight:bold">length</span>()
  )),
  width <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">18</span>, height <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">8</span>
)
</code></pre></div>
<figure >
  
    <a href="/images/projects/scrnaseq_workflow/composition_samples_clusters_by_number.png" target="_blank">
      <img src="/images/projects/scrnaseq_workflow/composition_samples_clusters_by_number.jpg"  style="width: 100%; max-width: 1000px" />
    </a>
  
  
</figure>




  </div>
  <input type="radio" name="composition_samples_clusters_1" id="composition_samples_clusters_1_2">
  <label for="composition_samples_clusters_1_2">Percent of cells</label>
  <div class="tab">


<p>Shown below is the composition of samples/clusters by percent of cells.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-r" data-lang="r">temp_labels <span style="color:#000;font-weight:bold">&lt;-</span> seurat<span style="color:#000;font-weight:bold">@</span>meta.data <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">group_by</span>(sample) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">tally</span>()

p1 <span style="color:#000;font-weight:bold">&lt;-</span> table_samples_by_clusters <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">select</span>(<span style="color:#000;font-weight:bold">-</span><span style="color:#900;font-weight:bold">c</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">total_cell_count&#39;</span>)) <span style="color:#000;font-weight:bold">%&gt;%</span>
  reshape2<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">melt</span>(id.vars <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">sample&#39;</span>) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">mutate</span>(sample <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">factor</span>(sample, levels <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">levels</span>(seurat<span style="color:#000;font-weight:bold">@</span>meta.data<span style="color:#000;font-weight:bold">$</span>sample))) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">ggplot</span>(<span style="color:#900;font-weight:bold">aes</span>(sample, value)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_bar</span>(<span style="color:#900;font-weight:bold">aes</span>(fill <span style="color:#000;font-weight:bold">=</span> variable), position <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">fill&#39;</span>, stat <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">identity&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_text</span>(
    data <span style="color:#000;font-weight:bold">=</span> temp_labels,
    <span style="color:#900;font-weight:bold">aes</span>(x <span style="color:#000;font-weight:bold">=</span> sample, y <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">Inf</span>, label <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">paste0</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">n = &#39;</span>, <span style="color:#900;font-weight:bold">format</span>(n, big.mark <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">,&#39;</span>, trim <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">TRUE</span>)), vjust <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">-1</span>),
    color <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">black&#39;</span>, size <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">2.8</span>
  ) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_fill_manual</span>(name <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Cluster&#39;</span>, values <span style="color:#000;font-weight:bold">=</span> custom_colors<span style="color:#000;font-weight:bold">$</span>discrete) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_y_continuous</span>(name <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Percentage [%]&#39;</span>, labels <span style="color:#000;font-weight:bold">=</span> scales<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">percent_format</span>(), expand <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">c</span>(<span style="color:#099">0.01</span>,<span style="color:#099">0</span>)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">coord_cartesian</span>(clip <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">off&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme_bw</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme</span>(
    legend.position <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">left&#39;</span>,
    plot.title <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_text</span>(hjust <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0.5</span>),
    text <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_text</span>(size <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">16</span>),
    panel.grid.major <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    panel.grid.minor <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    axis.title.x <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    axis.text.x <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_text</span>(angle <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">45</span>, hjust <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">1</span>, vjust <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">1</span>),
    plot.margin <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">margin</span>(t <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">20</span>, r <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>, b <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>, l <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>, unit <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">pt&#39;</span>)
  )

temp_labels <span style="color:#000;font-weight:bold">&lt;-</span> seurat<span style="color:#000;font-weight:bold">@</span>meta.data <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">group_by</span>(seurat_clusters) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">tally</span>() <span style="color:#000;font-weight:bold">%&gt;%</span>
  dplyr<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">rename</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">cluster&#39;</span> <span style="color:#000;font-weight:bold">=</span> seurat_clusters)

p2 <span style="color:#000;font-weight:bold">&lt;-</span> table_clusters_by_samples <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">select</span>(<span style="color:#000;font-weight:bold">-</span><span style="color:#900;font-weight:bold">c</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">total_cell_count&#39;</span>)) <span style="color:#000;font-weight:bold">%&gt;%</span>
  reshape2<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">melt</span>(id.vars <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">cluster&#39;</span>) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">mutate</span>(cluster <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">factor</span>(cluster, levels <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">levels</span>(seurat<span style="color:#000;font-weight:bold">@</span>meta.data<span style="color:#000;font-weight:bold">$</span>seurat_clusters))) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">ggplot</span>(<span style="color:#900;font-weight:bold">aes</span>(cluster, value)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_bar</span>(<span style="color:#900;font-weight:bold">aes</span>(fill <span style="color:#000;font-weight:bold">=</span> variable), position <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">fill&#39;</span>, stat <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">identity&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_text</span>(
    data <span style="color:#000;font-weight:bold">=</span> temp_labels, <span style="color:#900;font-weight:bold">aes</span>(x <span style="color:#000;font-weight:bold">=</span> cluster, y <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">Inf</span>, label <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">paste0</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">n = &#39;</span>, <span style="color:#900;font-weight:bold">format</span>(n, big.mark <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">,&#39;</span>, trim <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">TRUE</span>)), vjust <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">-1</span>),
    color <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">black&#39;</span>, size <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">2.8</span>
  ) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_fill_manual</span>(name <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Sample&#39;</span>, values <span style="color:#000;font-weight:bold">=</span> custom_colors<span style="color:#000;font-weight:bold">$</span>discrete) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_y_continuous</span>(name <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Percentage [%]&#39;</span>, labels <span style="color:#000;font-weight:bold">=</span> scales<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">percent_format</span>(), expand <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">c</span>(<span style="color:#099">0.01</span>,<span style="color:#099">0</span>)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">coord_cartesian</span>(clip <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">off&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme_bw</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme</span>(
    legend.position <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">right&#39;</span>,
    plot.title <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_text</span>(hjust <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0.5</span>),
    text <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_text</span>(size <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">16</span>),
    panel.grid.major <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    panel.grid.minor <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    axis.title <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    plot.margin <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">margin</span>(t <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">20</span>, r <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>, b <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>, l <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">10</span>, unit <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">pt&#39;</span>)
  )

<span style="color:#900;font-weight:bold">ggsave</span>(
  <span style="color:#d14">&#39;</span><span style="color:#d14">plots/composition_samples_clusters_by_percent.png&#39;</span>,
  p1 <span style="color:#000;font-weight:bold">+</span> p2 <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">plot_layout</span>(ncol <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">2</span>, widths <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">c</span>(
    seurat<span style="color:#000;font-weight:bold">@</span>meta.data<span style="color:#000;font-weight:bold">$</span>sample <span style="color:#000;font-weight:bold">%&gt;%</span> <span style="color:#900;font-weight:bold">unique</span>() <span style="color:#000;font-weight:bold">%&gt;%</span> <span style="color:#900;font-weight:bold">length</span>(),
    seurat<span style="color:#000;font-weight:bold">@</span>meta.data<span style="color:#000;font-weight:bold">$</span>seurat_clusters <span style="color:#000;font-weight:bold">%&gt;%</span> <span style="color:#900;font-weight:bold">unique</span>() <span style="color:#000;font-weight:bold">%&gt;%</span> <span style="color:#900;font-weight:bold">length</span>()
  )),
  width <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">18</span>, height <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">8</span>
)
</code></pre></div>
<figure >
  
    <a href="/images/projects/scrnaseq_workflow/composition_samples_clusters_by_percent.png" target="_blank">
      <img src="/images/projects/scrnaseq_workflow/composition_samples_clusters_by_percent.jpg"  style="width: 100%; max-width: 1000px" />
    </a>
  
  
</figure>




  </div>
</div>


<h2 id="cell-cycle-analysis">Cell cycle analysis</h2>
<p>Using the <code>CellCycleScoring()</code> function of <a href="https://satijalab.org/seurat/">Seurat</a>, we can assign a cell cycle phase (G1, S, G2M) to every cell.</p>
<h3 id="infer-cell-cycle-status">Infer cell cycle status</h3>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-r" data-lang="r">seurat <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">CellCycleScoring</span>(
  seurat,
  assay <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">SCT&#39;</span>,
  s.features <span style="color:#000;font-weight:bold">=</span> cc.genes<span style="color:#000;font-weight:bold">$</span>s.genes,
  g2m.features <span style="color:#000;font-weight:bold">=</span> cc.genes<span style="color:#000;font-weight:bold">$</span>g2m.genes
)

seurat<span style="color:#000;font-weight:bold">@</span>meta.data<span style="color:#000;font-weight:bold">$</span>cell_cycle_seurat <span style="color:#000;font-weight:bold">&lt;-</span> seurat<span style="color:#000;font-weight:bold">@</span>meta.data<span style="color:#000;font-weight:bold">$</span>Phase
seurat<span style="color:#000;font-weight:bold">@</span>meta.data<span style="color:#000;font-weight:bold">$</span>Phase <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#000;font-weight:bold">NULL</span>
seurat<span style="color:#000;font-weight:bold">@</span>meta.data<span style="color:#000;font-weight:bold">$</span>cell_cycle_seurat <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">factor</span>(
  seurat<span style="color:#000;font-weight:bold">@</span>meta.data<span style="color:#000;font-weight:bold">$</span>cell_cycle_seurat, levels <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">c</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">G1&#39;</span>, <span style="color:#d14">&#39;</span><span style="color:#d14">S&#39;</span>, <span style="color:#d14">&#39;</span><span style="color:#d14">G2M&#39;</span>)
)
</code></pre></div><h3 id="composition-of-samples-and-clusters-by-cell-cycle">Composition of samples and clusters by cell cycle</h3>
<p>Now check the cell cycle phase distribution for every sample and cluster.</p>
<p>Samples:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-r" data-lang="r">table_samples_by_cell_cycle <span style="color:#000;font-weight:bold">&lt;-</span> seurat<span style="color:#000;font-weight:bold">@</span>meta.data <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">group_by</span>(sample, cell_cycle_seurat) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">summarize</span>(count <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">n</span>()) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">spread</span>(cell_cycle_seurat, count, fill <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">ungroup</span>() <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">mutate</span>(total_cell_count <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">rowSums</span>(<span style="color:#900;font-weight:bold">.[c</span>(<span style="color:#099">2</span><span style="color:#000;font-weight:bold">:</span><span style="color:#900;font-weight:bold">ncol</span>(.))])) <span style="color:#000;font-weight:bold">%&gt;%</span>
  dplyr<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">select</span>(<span style="color:#900;font-weight:bold">c</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">sample&#39;</span>, <span style="color:#d14">&#39;</span><span style="color:#d14">total_cell_count&#39;</span>, <span style="color:#900;font-weight:bold">everything</span>())) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">arrange</span>(<span style="color:#900;font-weight:bold">factor</span>(sample, levels <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">levels</span>(seurat<span style="color:#000;font-weight:bold">@</span>meta.data<span style="color:#000;font-weight:bold">$</span>cell_cycle_seurat)))

knitr<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">kable</span>(table_samples_by_cell_cycle)
<span style="color:#998;font-style:italic"># |sample | total_cell_count|   G1|   S| G2M|</span>
<span style="color:#998;font-style:italic"># |:------|----------------:|----:|---:|---:|</span>
<span style="color:#998;font-style:italic"># |A      |             1696| 1159| 334| 203|</span>
<span style="color:#998;font-style:italic"># |B      |             1818| 1001| 413| 404|</span>
<span style="color:#998;font-style:italic"># |E      |             1881| 1303| 278| 300|</span>
</code></pre></div><p>Clusters:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-r" data-lang="r">table_clusters_by_cell_cycle <span style="color:#000;font-weight:bold">&lt;-</span> seurat<span style="color:#000;font-weight:bold">@</span>meta.data <span style="color:#000;font-weight:bold">%&gt;%</span>
  dplyr<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">rename</span>(cluster <span style="color:#000;font-weight:bold">=</span> seurat_clusters) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">group_by</span>(cluster, cell_cycle_seurat) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">summarize</span>(count <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">n</span>()) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">spread</span>(cell_cycle_seurat, count, fill <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">ungroup</span>() <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">mutate</span>(total_cell_count <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">rowSums</span>(<span style="color:#900;font-weight:bold">.[c</span>(<span style="color:#099">2</span><span style="color:#000;font-weight:bold">:</span><span style="color:#900;font-weight:bold">ncol</span>(.))])) <span style="color:#000;font-weight:bold">%&gt;%</span>
  dplyr<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">select</span>(<span style="color:#900;font-weight:bold">c</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">cluster&#39;</span>, <span style="color:#d14">&#39;</span><span style="color:#d14">total_cell_count&#39;</span>, <span style="color:#900;font-weight:bold">everything</span>())) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">arrange</span>(<span style="color:#900;font-weight:bold">factor</span>(cluster, levels <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">levels</span>(seurat<span style="color:#000;font-weight:bold">@</span>meta.data<span style="color:#000;font-weight:bold">$</span>cell_cycle_seurat)))

knitr<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">kable</span>(table_clusters_by_cell_cycle)
<span style="color:#998;font-style:italic"># |cluster | total_cell_count|  G1|   S| G2M|</span>
<span style="color:#998;font-style:italic"># |:-------|----------------:|---:|---:|---:|</span>
<span style="color:#998;font-style:italic"># |0       |             1138| 814| 201| 123|</span>
<span style="color:#998;font-style:italic"># |1       |              616| 417| 105|  94|</span>
<span style="color:#998;font-style:italic"># |2       |              503| 322|  97|  84|</span>
<span style="color:#998;font-style:italic"># |3       |              429| 381|   6|  42|</span>
<span style="color:#998;font-style:italic"># |4       |              353| 232|  70|  51|</span>
<span style="color:#998;font-style:italic"># |5       |              334| 253|  28|  53|</span>
<span style="color:#998;font-style:italic"># |6       |              290| 179|  46|  65|</span>
<span style="color:#998;font-style:italic"># |7       |              229| 146|  71|  12|</span>
<span style="color:#998;font-style:italic"># |8       |              214| 171|  20|  23|</span>
<span style="color:#998;font-style:italic"># |9       |              195| 133|  38|  24|</span>
<span style="color:#998;font-style:italic"># |10      |              193|   0|  47| 146|</span>
<span style="color:#998;font-style:italic"># |11      |              181| 130|  29|  22|</span>
<span style="color:#998;font-style:italic"># |12      |              152|  34|  76|  42|</span>
<span style="color:#998;font-style:italic"># |13      |              150|  21|  74|  55|</span>
<span style="color:#998;font-style:italic"># |14      |              118|   0|  76|  42|</span>
<span style="color:#998;font-style:italic"># |15      |              110|  62|  29|  19|</span>
<span style="color:#998;font-style:italic"># |16      |               90|  84|   2|   4|</span>
<span style="color:#998;font-style:italic"># |17      |               76|  61|   9|   6|</span>
<span style="color:#998;font-style:italic"># |18      |               24|  23|   1|   0|</span>
</code></pre></div>

<div class="tabs">
  <input type="radio" name="composition_samples_clusters_cell_cycle_1" id="composition_samples_clusters_cell_cycle_1_1" checked="checked">
  <label for="composition_samples_clusters_cell_cycle_1_1">Number of cells</label>
  <div class="tab">


<p>Shown below is the composition of samples/clusters by actual number of cells.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-r" data-lang="r">temp_labels <span style="color:#000;font-weight:bold">&lt;-</span> seurat<span style="color:#000;font-weight:bold">@</span>meta.data <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">group_by</span>(sample) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">tally</span>()

p1 <span style="color:#000;font-weight:bold">&lt;-</span> table_samples_by_cell_cycle <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">select</span>(<span style="color:#000;font-weight:bold">-</span><span style="color:#900;font-weight:bold">c</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">total_cell_count&#39;</span>)) <span style="color:#000;font-weight:bold">%&gt;%</span>
  reshape2<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">melt</span>(id.vars <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">sample&#39;</span>) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">mutate</span>(sample <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">factor</span>(sample, levels <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">levels</span>(seurat<span style="color:#000;font-weight:bold">@</span>meta.data<span style="color:#000;font-weight:bold">$</span>sample))) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">ggplot</span>(<span style="color:#900;font-weight:bold">aes</span>(sample, value)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_bar</span>(<span style="color:#900;font-weight:bold">aes</span>(fill <span style="color:#000;font-weight:bold">=</span> variable), position <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">stack&#39;</span>, stat <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">identity&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_text</span>(
    data <span style="color:#000;font-weight:bold">=</span> temp_labels,
    <span style="color:#900;font-weight:bold">aes</span>(x <span style="color:#000;font-weight:bold">=</span> sample, y <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">Inf</span>, label <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">paste0</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">n = &#39;</span>, <span style="color:#900;font-weight:bold">format</span>(n, big.mark <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">,&#39;</span>, trim <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">TRUE</span>)), vjust <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">-1</span>),
    color <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">black&#39;</span>, size <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">2.8</span>
  ) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_fill_manual</span>(name <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Cell cycle&#39;</span>, values <span style="color:#000;font-weight:bold">=</span> custom_colors<span style="color:#000;font-weight:bold">$</span>cell_cycle) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_y_continuous</span>(name <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Number of cells&#39;</span>, labels <span style="color:#000;font-weight:bold">=</span> scales<span style="color:#000;font-weight:bold">::</span>comma, expand <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">c</span>(<span style="color:#099">0.01</span>,<span style="color:#099">0</span>)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">coord_cartesian</span>(clip <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">off&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme_bw</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme</span>(
    legend.position <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">none&#39;</span>,
    plot.title <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_text</span>(hjust <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0.5</span>),
    text <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_text</span>(size <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">16</span>),
    panel.grid.major <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    panel.grid.minor <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    axis.title.x <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    axis.text.x <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_text</span>(angle <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">45</span>, hjust <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">1</span>, vjust <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">1</span>),
    plot.margin <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">margin</span>(t <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">20</span>, r <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>, b <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>, l <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>, unit <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">pt&#39;</span>)
  )

temp_labels <span style="color:#000;font-weight:bold">&lt;-</span> seurat<span style="color:#000;font-weight:bold">@</span>meta.data <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">group_by</span>(seurat_clusters) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">tally</span>() <span style="color:#000;font-weight:bold">%&gt;%</span>
  dplyr<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">rename</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">cluster&#39;</span> <span style="color:#000;font-weight:bold">=</span> seurat_clusters)

p2 <span style="color:#000;font-weight:bold">&lt;-</span> table_clusters_by_cell_cycle <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">select</span>(<span style="color:#000;font-weight:bold">-</span><span style="color:#900;font-weight:bold">c</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">total_cell_count&#39;</span>)) <span style="color:#000;font-weight:bold">%&gt;%</span>
  reshape2<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">melt</span>(id.vars <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">cluster&#39;</span>) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">mutate</span>(cluster <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">factor</span>(cluster, levels <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">levels</span>(seurat<span style="color:#000;font-weight:bold">@</span>meta.data<span style="color:#000;font-weight:bold">$</span>seurat_clusters))) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">ggplot</span>(<span style="color:#900;font-weight:bold">aes</span>(cluster, value)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_bar</span>(<span style="color:#900;font-weight:bold">aes</span>(fill <span style="color:#000;font-weight:bold">=</span> variable), position <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">stack&#39;</span>, stat <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">identity&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_text</span>(
    data <span style="color:#000;font-weight:bold">=</span> temp_labels,
    <span style="color:#900;font-weight:bold">aes</span>(x <span style="color:#000;font-weight:bold">=</span> cluster, y <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">Inf</span>, label <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">paste0</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">n = &#39;</span>, <span style="color:#900;font-weight:bold">format</span>(n, big.mark <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">,&#39;</span>, trim <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">TRUE</span>)), vjust <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">-1</span>),
    color <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">black&#39;</span>, size <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">2.8</span>
  ) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_fill_manual</span>(name <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Cell cycle&#39;</span>, values <span style="color:#000;font-weight:bold">=</span> custom_colors<span style="color:#000;font-weight:bold">$</span>cell_cycle) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_y_continuous</span>(name <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Number of cells&#39;</span>, labels <span style="color:#000;font-weight:bold">=</span> scales<span style="color:#000;font-weight:bold">::</span>comma, expand <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">c</span>(<span style="color:#099">0.01</span>,<span style="color:#099">0</span>)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">coord_cartesian</span>(clip <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">off&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme_bw</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme</span>(
    legend.position <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">right&#39;</span>,
    plot.title <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_text</span>(hjust <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0.5</span>),
    text <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_text</span>(size <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">16</span>),
    panel.grid.major <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    panel.grid.minor <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    axis.title <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    plot.margin <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">margin</span>(t <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">20</span>, r <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>, b <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>, l <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">10</span>, unit <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">pt&#39;</span>)
  )

<span style="color:#900;font-weight:bold">ggsave</span>(
  <span style="color:#d14">&#39;</span><span style="color:#d14">plots/composition_samples_clusters_by_cell_cycle_by_number.png&#39;</span>,
  p1 <span style="color:#000;font-weight:bold">+</span> p2 <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">plot_layout</span>(ncol <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">2</span>, widths <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">c</span>(
    seurat<span style="color:#000;font-weight:bold">@</span>meta.data<span style="color:#000;font-weight:bold">$</span>sample <span style="color:#000;font-weight:bold">%&gt;%</span> <span style="color:#900;font-weight:bold">unique</span>() <span style="color:#000;font-weight:bold">%&gt;%</span> <span style="color:#900;font-weight:bold">length</span>(),
    seurat<span style="color:#000;font-weight:bold">@</span>meta.data<span style="color:#000;font-weight:bold">$</span>seurat_clusters <span style="color:#000;font-weight:bold">%&gt;%</span> <span style="color:#900;font-weight:bold">unique</span>() <span style="color:#000;font-weight:bold">%&gt;%</span> <span style="color:#900;font-weight:bold">length</span>()
  )),
  width <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">18</span>, height <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">8</span>
)
</code></pre></div>
<figure >
  
    <a href="/images/projects/scrnaseq_workflow/composition_samples_clusters_by_cell_cycle_by_number.png" target="_blank">
      <img src="/images/projects/scrnaseq_workflow/composition_samples_clusters_by_cell_cycle_by_number.jpg"  style="width: 100%; max-width: 1000px" />
    </a>
  
  
</figure>




  </div>
  <input type="radio" name="composition_samples_clusters_cell_cycle_1" id="composition_samples_clusters_cell_cycle_1_2">
  <label for="composition_samples_clusters_cell_cycle_1_2">Percent of cells</label>
  <div class="tab">


<p>Shown below is the composition of samples/clusters by percent of cells.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-r" data-lang="r">temp_labels <span style="color:#000;font-weight:bold">&lt;-</span> seurat<span style="color:#000;font-weight:bold">@</span>meta.data <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">group_by</span>(sample) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">tally</span>()

p1 <span style="color:#000;font-weight:bold">&lt;-</span> table_samples_by_cell_cycle <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">select</span>(<span style="color:#000;font-weight:bold">-</span><span style="color:#900;font-weight:bold">c</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">total_cell_count&#39;</span>)) <span style="color:#000;font-weight:bold">%&gt;%</span>
  reshape2<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">melt</span>(id.vars <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">sample&#39;</span>) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">mutate</span>(sample <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">factor</span>(sample, levels <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">levels</span>(seurat<span style="color:#000;font-weight:bold">@</span>meta.data<span style="color:#000;font-weight:bold">$</span>sample))) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">ggplot</span>(<span style="color:#900;font-weight:bold">aes</span>(sample, value)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_bar</span>(<span style="color:#900;font-weight:bold">aes</span>(fill <span style="color:#000;font-weight:bold">=</span> variable), position <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">fill&#39;</span>, stat <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">identity&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_text</span>(
    data <span style="color:#000;font-weight:bold">=</span> temp_labels,
    <span style="color:#900;font-weight:bold">aes</span>(x <span style="color:#000;font-weight:bold">=</span> sample, y <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">Inf</span>, label <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">paste0</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">n = &#39;</span>, <span style="color:#900;font-weight:bold">format</span>(n, big.mark <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">,&#39;</span>, trim <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">TRUE</span>)), vjust <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">-1</span>),
    color <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">black&#39;</span>, size <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">2.8</span>
  ) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_fill_manual</span>(name <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Cell cycle&#39;</span>, values <span style="color:#000;font-weight:bold">=</span> custom_colors<span style="color:#000;font-weight:bold">$</span>cell_cycle) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_y_continuous</span>(name <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Percentage [%]&#39;</span>, labels <span style="color:#000;font-weight:bold">=</span> scales<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">percent_format</span>(), expand <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">c</span>(<span style="color:#099">0.01</span>,<span style="color:#099">0</span>)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">coord_cartesian</span>(clip <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">off&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme_bw</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme</span>(
    legend.position <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">none&#39;</span>,
    plot.title <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_text</span>(hjust <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0.5</span>),
    text <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_text</span>(size <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">16</span>),
    panel.grid.major <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    panel.grid.minor <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    axis.title.x <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    axis.text.x <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_text</span>(angle <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">45</span>, hjust <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">1</span>, vjust <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">1</span>),
    plot.margin <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">margin</span>(t <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">20</span>, r <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>, b <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>, l <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>, unit <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">pt&#39;</span>)
  )

temp_labels <span style="color:#000;font-weight:bold">&lt;-</span> seurat<span style="color:#000;font-weight:bold">@</span>meta.data <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">group_by</span>(seurat_clusters) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">tally</span>() <span style="color:#000;font-weight:bold">%&gt;%</span>
  dplyr<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">rename</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">cluster&#39;</span> <span style="color:#000;font-weight:bold">=</span> seurat_clusters)

p2 <span style="color:#000;font-weight:bold">&lt;-</span> table_clusters_by_cell_cycle <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">select</span>(<span style="color:#000;font-weight:bold">-</span><span style="color:#900;font-weight:bold">c</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">total_cell_count&#39;</span>)) <span style="color:#000;font-weight:bold">%&gt;%</span>
  reshape2<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">melt</span>(id.vars <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">cluster&#39;</span>) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">mutate</span>(cluster <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">factor</span>(cluster, levels <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">levels</span>(seurat<span style="color:#000;font-weight:bold">@</span>meta.data<span style="color:#000;font-weight:bold">$</span>seurat_clusters))) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">ggplot</span>(<span style="color:#900;font-weight:bold">aes</span>(cluster, value)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_bar</span>(<span style="color:#900;font-weight:bold">aes</span>(fill <span style="color:#000;font-weight:bold">=</span> variable), position <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">fill&#39;</span>, stat <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">identity&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_text</span>(
    data <span style="color:#000;font-weight:bold">=</span> temp_labels,
    <span style="color:#900;font-weight:bold">aes</span>(x <span style="color:#000;font-weight:bold">=</span> cluster, y <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">Inf</span>, label <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">paste0</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">n = &#39;</span>, <span style="color:#900;font-weight:bold">format</span>(n, big.mark <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">,&#39;</span>, trim <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">TRUE</span>)), vjust <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">-1</span>),
    color <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">black&#39;</span>, size <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">2.8</span>
  ) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_fill_manual</span>(name <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Cell cycle&#39;</span>, values <span style="color:#000;font-weight:bold">=</span> custom_colors<span style="color:#000;font-weight:bold">$</span>cell_cycle) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_y_continuous</span>(name <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Percentage [%]&#39;</span>, labels <span style="color:#000;font-weight:bold">=</span> scales<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">percent_format</span>(), expand <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">c</span>(<span style="color:#099">0.01</span>,<span style="color:#099">0</span>)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">coord_cartesian</span>(clip <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">off&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme_bw</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme</span>(
    legend.position <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">right&#39;</span>,
    plot.title <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_text</span>(hjust <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0.5</span>),
    text <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_text</span>(size <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">16</span>),
    panel.grid.major <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    panel.grid.minor <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    axis.title <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    plot.margin <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">margin</span>(t <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">20</span>, r <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>, b <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>, l <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">10</span>, unit <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">pt&#39;</span>)
  )

<span style="color:#900;font-weight:bold">ggsave</span>(
  <span style="color:#d14">&#39;</span><span style="color:#d14">plots/composition_samples_clusters_by_cell_cycle_by_percent.png&#39;</span>,
  p1 <span style="color:#000;font-weight:bold">+</span> p2 <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">plot_layout</span>(ncol <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">2</span>, widths <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">c</span>(
    seurat<span style="color:#000;font-weight:bold">@</span>meta.data<span style="color:#000;font-weight:bold">$</span>sample <span style="color:#000;font-weight:bold">%&gt;%</span> <span style="color:#900;font-weight:bold">unique</span>() <span style="color:#000;font-weight:bold">%&gt;%</span> <span style="color:#900;font-weight:bold">length</span>(),
    seurat<span style="color:#000;font-weight:bold">@</span>meta.data<span style="color:#000;font-weight:bold">$</span>seurat_clusters <span style="color:#000;font-weight:bold">%&gt;%</span> <span style="color:#900;font-weight:bold">unique</span>() <span style="color:#000;font-weight:bold">%&gt;%</span> <span style="color:#900;font-weight:bold">length</span>()
  )),
  width <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">18</span>, height <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">8</span>
)
</code></pre></div>
<figure >
  
    <a href="/images/projects/scrnaseq_workflow/composition_samples_clusters_by_cell_cycle_by_percent.png" target="_blank">
      <img src="/images/projects/scrnaseq_workflow/composition_samples_clusters_by_cell_cycle_by_percent.jpg"  style="width: 100%; max-width: 1000px" />
    </a>
  
  
</figure>




  </div>
</div>


<h2 id="dimensional-reduction">Dimensional reduction</h2>
<p>Here, we represent the transcription profiles of all cells in the data set in a 2D or 3D projection, typically using the t-SNE or UMAP methods.</p>
<h3 id="snn-graph">SNN graph</h3>
<p>The SNN graph was calculated earlier in the <code>FindNeighbors()</code> function.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-r" data-lang="r"><span style="color:#900;font-weight:bold">library</span>(ggnetwork)

SCT_snn <span style="color:#000;font-weight:bold">&lt;-</span> seurat<span style="color:#000;font-weight:bold">@</span>graphs<span style="color:#000;font-weight:bold">$</span>SCT_snn <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">as.matrix</span>() <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">ggnetwork</span>() <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">left_join</span>(seurat<span style="color:#000;font-weight:bold">@</span>meta.data <span style="color:#000;font-weight:bold">%&gt;%</span> <span style="color:#900;font-weight:bold">mutate</span>(vertex.names <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">rownames</span>(.)), by <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">vertex.names&#39;</span>)

p1 <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">ggplot</span>(SCT_snn, <span style="color:#900;font-weight:bold">aes</span>(x <span style="color:#000;font-weight:bold">=</span> x, y <span style="color:#000;font-weight:bold">=</span> y, xend <span style="color:#000;font-weight:bold">=</span> xend, yend <span style="color:#000;font-weight:bold">=</span> yend)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_edges</span>(color <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">grey50&#39;</span>, alpha <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0.05</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_nodes</span>(<span style="color:#900;font-weight:bold">aes</span>(color <span style="color:#000;font-weight:bold">=</span> sample), size <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0.5</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_color_manual</span>(
    name <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Sample&#39;</span>, values <span style="color:#000;font-weight:bold">=</span> custom_colors<span style="color:#000;font-weight:bold">$</span>discrete,
    guide <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">guide_legend</span>(ncol <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">1</span>, override.aes <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">list</span>(size <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">2</span>))
  ) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme_blank</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme</span>(legend.position <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">left&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">annotate</span>(
    geom <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">text&#39;</span>, x <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">Inf</span>, y <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">Inf</span>,
    label <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">paste0</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">n = &#39;</span>, <span style="color:#900;font-weight:bold">format</span>(<span style="color:#900;font-weight:bold">nrow</span>(seurat<span style="color:#000;font-weight:bold">@</span>meta.data), big.mark <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">,&#39;</span>, trim <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">TRUE</span>)),
    vjust <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">-1.5</span>, hjust <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">1.25</span>, color <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">black&#39;</span>, size <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">2.5</span>
  )

p2 <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">ggplot</span>(SCT_snn, <span style="color:#900;font-weight:bold">aes</span>(x <span style="color:#000;font-weight:bold">=</span> x, y <span style="color:#000;font-weight:bold">=</span> y, xend <span style="color:#000;font-weight:bold">=</span> xend, yend <span style="color:#000;font-weight:bold">=</span> yend)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_edges</span>(color <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">grey50&#39;</span>, alpha <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0.05</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_nodes</span>(<span style="color:#900;font-weight:bold">aes</span>(color <span style="color:#000;font-weight:bold">=</span> seurat_clusters), size <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0.5</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_color_manual</span>(
    name <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Cluster&#39;</span>, values <span style="color:#000;font-weight:bold">=</span> custom_colors<span style="color:#000;font-weight:bold">$</span>discrete,
    guide <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">guide_legend</span>(ncol <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">1</span>, override.aes <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">list</span>(size <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">2</span>))
  ) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme_blank</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme</span>(legend.position <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">right&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">annotate</span>(
    geom <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">text&#39;</span>, x <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">Inf</span>, y <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">Inf</span>,
    label <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">paste0</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">n = &#39;</span>, <span style="color:#900;font-weight:bold">format</span>(<span style="color:#900;font-weight:bold">nrow</span>(seurat<span style="color:#000;font-weight:bold">@</span>meta.data), big.mark <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">,&#39;</span>, trim <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">TRUE</span>)),
    vjust <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">-1.5</span>, hjust <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">1.25</span>, color <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">black&#39;</span>, size <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">2.5</span>
  )

<span style="color:#900;font-weight:bold">ggsave</span>(
  <span style="color:#d14">&#39;</span><span style="color:#d14">plots/SNN_graph_by_sample_cluster.png&#39;</span>,
  p1 <span style="color:#000;font-weight:bold">+</span> p2 <span style="color:#000;font-weight:bold">+</span> <span style="color:#900;font-weight:bold">plot_layout</span>(ncol <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">2</span>),
  height <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">5</span>, width <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">11</span>
)
</code></pre></div>
<figure >
  
    <a href="/images/projects/scrnaseq_workflow/SNN_graph_by_sample_cluster.png" target="_blank">
      <img src="/images/projects/scrnaseq_workflow/SNN_graph_by_sample_cluster.jpg"  style="width: 100%; max-width: 1000px" />
    </a>
  
  
</figure>


<h3 id="umap">UMAP</h3>
<h4 id="calculate-umap">Calculate UMAP</h4>
<p>He we calculate the UMAP using the same 15 PCs we have also used for clustering.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-r" data-lang="r">seurat <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">RunUMAP</span>(
  seurat,
  reduction.name <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">UMAP&#39;</span>,
  reduction <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">pca&#39;</span>,
  dims <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">1</span><span style="color:#000;font-weight:bold">:</span><span style="color:#099">15</span>,
  n.components <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">2</span>,
  seed.use <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">100</span>
)
</code></pre></div><h4 id="overview">Overview</h4>
<p>After calculation of the UMAP, we plot it while coloring the cells by the number of transcripts, sample, cluster, and cell cycle.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-r" data-lang="r">plot_umap_by_nCount <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">bind_cols</span>(seurat<span style="color:#000;font-weight:bold">@</span>meta.data, <span style="color:#900;font-weight:bold">as.data.frame</span>(seurat<span style="color:#000;font-weight:bold">@</span>reductions<span style="color:#000;font-weight:bold">$</span>UMAP<span style="color:#000;font-weight:bold">@</span>cell.embeddings)) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">ggplot</span>(<span style="color:#900;font-weight:bold">aes</span>(UMAP_1, UMAP_2, color <span style="color:#000;font-weight:bold">=</span> nCount_RNA)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_point</span>(size <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0.2</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme_bw</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_color_viridis</span>(
    guide <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">guide_colorbar</span>(frame.colour <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">black&#39;</span>, ticks.colour <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">black&#39;</span>),
    labels <span style="color:#000;font-weight:bold">=</span> scales<span style="color:#000;font-weight:bold">::</span>comma,
  ) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">labs</span>(color <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Number of\ntranscripts&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme</span>(legend.position <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">left&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">coord_fixed</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">annotate</span>(
    geom <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">text&#39;</span>, x <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">Inf</span>, y <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">Inf</span>,
    label <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">paste0</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">n = &#39;</span>, <span style="color:#900;font-weight:bold">format</span>(<span style="color:#900;font-weight:bold">nrow</span>(seurat<span style="color:#000;font-weight:bold">@</span>meta.data), big.mark <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">,&#39;</span>, trim <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">TRUE</span>)),
    vjust <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">-1.5</span>, hjust <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">1.25</span>, color <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">black&#39;</span>, size <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">2.5</span>
  )

plot_umap_by_sample <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">bind_cols</span>(seurat<span style="color:#000;font-weight:bold">@</span>meta.data, <span style="color:#900;font-weight:bold">as.data.frame</span>(seurat<span style="color:#000;font-weight:bold">@</span>reductions<span style="color:#000;font-weight:bold">$</span>UMAP<span style="color:#000;font-weight:bold">@</span>cell.embeddings)) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">ggplot</span>(<span style="color:#900;font-weight:bold">aes</span>(UMAP_1, UMAP_2, color <span style="color:#000;font-weight:bold">=</span> sample)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_point</span>(size <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0.2</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme_bw</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_color_manual</span>(values <span style="color:#000;font-weight:bold">=</span> custom_colors<span style="color:#000;font-weight:bold">$</span>discrete) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">labs</span>(color <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Sample&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">guides</span>(colour <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">guide_legend</span>(override.aes <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">list</span>(size <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">2</span>))) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme</span>(legend.position <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">right&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">coord_fixed</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">annotate</span>(
    geom <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">text&#39;</span>, x <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">Inf</span>, y <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">Inf</span>,
    label <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">paste0</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">n = &#39;</span>, <span style="color:#900;font-weight:bold">format</span>(<span style="color:#900;font-weight:bold">nrow</span>(seurat<span style="color:#000;font-weight:bold">@</span>meta.data), big.mark <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">,&#39;</span>, trim <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">TRUE</span>)),
    vjust <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">-1.5</span>, hjust <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">1.25</span>, color <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">black&#39;</span>, size <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">2.5</span>
  )

plot_umap_by_cluster <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">bind_cols</span>(seurat<span style="color:#000;font-weight:bold">@</span>meta.data, <span style="color:#900;font-weight:bold">as.data.frame</span>(seurat<span style="color:#000;font-weight:bold">@</span>reductions<span style="color:#000;font-weight:bold">$</span>UMAP<span style="color:#000;font-weight:bold">@</span>cell.embeddings)) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">ggplot</span>(<span style="color:#900;font-weight:bold">aes</span>(UMAP_1, UMAP_2, color <span style="color:#000;font-weight:bold">=</span> seurat_clusters)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_point</span>(size <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0.2</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme_bw</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_color_manual</span>(
    name <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Cluster&#39;</span>, values <span style="color:#000;font-weight:bold">=</span> custom_colors<span style="color:#000;font-weight:bold">$</span>discrete,
    guide <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">guide_legend</span>(ncol <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">2</span>, override.aes <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">list</span>(size <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">2</span>))
  ) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme</span>(legend.position <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">left&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">coord_fixed</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">annotate</span>(
    geom <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">text&#39;</span>, x <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">Inf</span>, y <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">Inf</span>,
    label <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">paste0</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">n = &#39;</span>, <span style="color:#900;font-weight:bold">format</span>(<span style="color:#900;font-weight:bold">nrow</span>(seurat<span style="color:#000;font-weight:bold">@</span>meta.data), big.mark <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">,&#39;</span>, trim <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">TRUE</span>)),
    vjust <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">-1.5</span>, hjust <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">1.25</span>, color <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">black&#39;</span>, size <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">2.5</span>
  )

plot_umap_by_cell_cycle <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">bind_cols</span>(seurat<span style="color:#000;font-weight:bold">@</span>meta.data, <span style="color:#900;font-weight:bold">as.data.frame</span>(seurat<span style="color:#000;font-weight:bold">@</span>reductions<span style="color:#000;font-weight:bold">$</span>UMAP<span style="color:#000;font-weight:bold">@</span>cell.embeddings)) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">ggplot</span>(<span style="color:#900;font-weight:bold">aes</span>(UMAP_1, UMAP_2, color <span style="color:#000;font-weight:bold">=</span> cell_cycle_seurat)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_point</span>(size <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0.2</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme_bw</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_color_manual</span>(values <span style="color:#000;font-weight:bold">=</span> custom_colors<span style="color:#000;font-weight:bold">$</span>cell_cycle) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">labs</span>(color <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Cell cycle&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">guides</span>(colour <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">guide_legend</span>(override.aes <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">list</span>(size <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">2</span>))) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme</span>(legend.position <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">right&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">coord_fixed</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">annotate</span>(
    geom <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">text&#39;</span>, x <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">Inf</span>, y <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">Inf</span>,
    label <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">paste0</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">n = &#39;</span>, <span style="color:#900;font-weight:bold">format</span>(<span style="color:#900;font-weight:bold">nrow</span>(seurat<span style="color:#000;font-weight:bold">@</span>meta.data), big.mark <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">,&#39;</span>, trim <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">TRUE</span>)),
    vjust <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">-1.5</span>, hjust <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">1.25</span>, color <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">black&#39;</span>, size <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">2.5</span>
  )

<span style="color:#900;font-weight:bold">ggsave</span>(
  <span style="color:#d14">&#39;</span><span style="color:#d14">plots/UMAP.png&#39;</span>,
  plot_umap_by_nCount <span style="color:#000;font-weight:bold">+</span> plot_umap_by_sample <span style="color:#000;font-weight:bold">+</span>
  plot_umap_by_cluster <span style="color:#000;font-weight:bold">+</span> plot_umap_by_cell_cycle <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">plot_layout</span>(ncol <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">2</span>),
  height <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">6</span>,
  width <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">8.5</span>
)
</code></pre></div>
<figure >
  
    <a href="/images/projects/scrnaseq_workflow/UMAP.png" target="_blank">
      <img src="/images/projects/scrnaseq_workflow/UMAP.jpg"  style="width: 100%; max-width: 1000px" />
    </a>
  
  
</figure>


<h4 id="samples">Samples</h4>
<p>To understand how much the samples overlap, we plot the UMAP again and split the samples in different panels.
Evidently, they overlap very well.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-r" data-lang="r">temp_labels <span style="color:#000;font-weight:bold">&lt;-</span> seurat<span style="color:#000;font-weight:bold">@</span>meta.data <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">group_by</span>(sample) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">tally</span>()

p <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">bind_cols</span>(seurat<span style="color:#000;font-weight:bold">@</span>meta.data, <span style="color:#900;font-weight:bold">as.data.frame</span>(seurat<span style="color:#000;font-weight:bold">@</span>reductions<span style="color:#000;font-weight:bold">$</span>UMAP<span style="color:#000;font-weight:bold">@</span>cell.embeddings)) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">ggplot</span>(<span style="color:#900;font-weight:bold">aes</span>(UMAP_1, UMAP_2, color <span style="color:#000;font-weight:bold">=</span> sample)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_point</span>(size <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0.2</span>, show.legend <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">FALSE</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_text</span>(
    data <span style="color:#000;font-weight:bold">=</span> temp_labels,
    <span style="color:#900;font-weight:bold">aes</span>(x <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">Inf</span>, y <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">Inf</span>, label <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">paste0</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">n = &#39;</span>, <span style="color:#900;font-weight:bold">format</span>(n, big.mark <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">,&#39;</span>, trim <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">TRUE</span>)), vjust <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">-1.5</span>, hjust <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">1.25</span>),
    color <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">black&#39;</span>, size <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">2.8</span>
  ) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme_bw</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_color_manual</span>(values <span style="color:#000;font-weight:bold">=</span> custom_colors<span style="color:#000;font-weight:bold">$</span>discrete) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">coord_fixed</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme</span>(
    legend.position <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">none&#39;</span>,
    strip.text <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_text</span>(face <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">bold&#39;</span>, size <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">10</span>)
  ) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">facet_wrap</span>(<span style="color:#000;font-weight:bold">~</span>sample, ncol <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">5</span>)

<span style="color:#900;font-weight:bold">ggsave</span>(
  <span style="color:#d14">&#39;</span><span style="color:#d14">plots/UMAP_by_sample_split.png&#39;</span>,
  p,
  height <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">4</span>,
  width <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">10</span>
)
</code></pre></div>
<figure >
  
    <a href="/images/projects/scrnaseq_workflow/UMAP_by_sample_split.png" target="_blank">
      <img src="/images/projects/scrnaseq_workflow/UMAP_by_sample_split.jpg"  style="width: 100%; max-width: 1000px" />
    </a>
  
  
</figure>


<h4 id="clusters">Clusters</h4>
<p>Instead, for the clusters we simply add a label to the geometric center of each cluster.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-r" data-lang="r">UMAP_centers_cluster <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">tibble</span>(
    UMAP_1 <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">as.data.frame</span>(seurat<span style="color:#000;font-weight:bold">@</span>reductions<span style="color:#000;font-weight:bold">$</span>UMAP<span style="color:#000;font-weight:bold">@</span>cell.embeddings)<span style="color:#000;font-weight:bold">$</span>UMAP_1,
    UMAP_2 <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">as.data.frame</span>(seurat<span style="color:#000;font-weight:bold">@</span>reductions<span style="color:#000;font-weight:bold">$</span>UMAP<span style="color:#000;font-weight:bold">@</span>cell.embeddings)<span style="color:#000;font-weight:bold">$</span>UMAP_2,
    cluster <span style="color:#000;font-weight:bold">=</span> seurat<span style="color:#000;font-weight:bold">@</span>meta.data<span style="color:#000;font-weight:bold">$</span>seurat_clusters
  ) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">group_by</span>(cluster) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">summarize</span>(x <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">median</span>(UMAP_1), y <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">median</span>(UMAP_2))

p <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">bind_cols</span>(seurat<span style="color:#000;font-weight:bold">@</span>meta.data, <span style="color:#900;font-weight:bold">as.data.frame</span>(seurat<span style="color:#000;font-weight:bold">@</span>reductions<span style="color:#000;font-weight:bold">$</span>UMAP<span style="color:#000;font-weight:bold">@</span>cell.embeddings)) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">ggplot</span>(<span style="color:#900;font-weight:bold">aes</span>(UMAP_1, UMAP_2, color <span style="color:#000;font-weight:bold">=</span> seurat_clusters)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_point</span>(size <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0.2</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_label</span>(
    data <span style="color:#000;font-weight:bold">=</span> UMAP_centers_cluster,
    mapping <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">aes</span>(x, y, label <span style="color:#000;font-weight:bold">=</span> cluster),
    size <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">4.5</span>,
    fill <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">white&#39;</span>,
    color <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">black&#39;</span>,
    fontface <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">bold&#39;</span>,
    alpha <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0.5</span>,
    label.size <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>,
    show.legend <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">FALSE</span>
  ) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme_bw</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_color_manual</span>(
    name <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Cluster&#39;</span>, values <span style="color:#000;font-weight:bold">=</span> custom_colors<span style="color:#000;font-weight:bold">$</span>discrete,
    guide <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">guide_legend</span>(override.aes <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">list</span>(size <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">2</span>))
  ) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme</span>(legend.position <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">right&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">coord_fixed</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">annotate</span>(
    geom <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">text&#39;</span>, x <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">Inf</span>, y <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">Inf</span>,
    label <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">paste0</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">n = &#39;</span>, <span style="color:#900;font-weight:bold">format</span>(<span style="color:#900;font-weight:bold">nrow</span>(seurat<span style="color:#000;font-weight:bold">@</span>meta.data), big.mark <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">,&#39;</span>, trim <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">TRUE</span>)),
    vjust <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">-1.5</span>, hjust <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">1.25</span>, color <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">black&#39;</span>, size <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">2.5</span>
  )

<span style="color:#900;font-weight:bold">ggsave</span>(
  <span style="color:#d14">&#39;</span><span style="color:#d14">plots/UMAP_by_clusters.png&#39;</span>,
  p, height <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">5.5</span>, width <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">5.5</span>
)
</code></pre></div>
<figure >
  
    <a href="/images/projects/scrnaseq_workflow/UMAP_by_clusters.png" target="_blank">
      <img src="/images/projects/scrnaseq_workflow/UMAP_by_clusters.jpg"  style="width: 100%; max-width: 1000px" />
    </a>
  
  
</figure>


<h3 id="poincar-map-work-in-progress">Poincar map (work-in-progress)</h3>
<p>For now, please check my blog article <a href="http://romanhaa.github.io/blog/dynamics_of_training_a_poincare_map/">&ldquo;Animating the dynamics of training a Poincar map&rdquo;</a>.</p>
<h2 id="cell-type-annotation-with-singler">Cell type annotation with SingleR</h2>
<p>Cell inference can be performed with many tools.
Personally, I find <a href="https://bioconductor.org/packages/3.11/bioc/html/SingleR.html"><code>SingleR</code></a> very useful because it has given good results in my experiments and because it provides multiple pre-trained reference data sets.</p>
<h3 id="assign-labels">Assign labels</h3>
<p>First, we assign a label to each cell using the <code>BlueprintEncodeData()</code> data as a reference.
We then extract the labels and assignment scores and add them to the Seurat object.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-r" data-lang="r"><span style="color:#900;font-weight:bold">library</span>(SingleR)

singler_ref <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">BlueprintEncodeData</span>()

singler_results_blueprintencode_main <span style="color:#000;font-weight:bold">&lt;-</span> SingleR<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">SingleR</span>(
  test <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">GetAssayData</span>(seurat, assay <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">SCT&#39;</span>, slot <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">data&#39;</span>),
  ref <span style="color:#000;font-weight:bold">=</span> singler_ref,
  labels <span style="color:#000;font-weight:bold">=</span> singler_ref<span style="color:#000;font-weight:bold">@</span>colData<span style="color:#000;font-weight:bold">@</span>listData<span style="color:#000;font-weight:bold">$</span>label.main
)

<span style="color:#900;font-weight:bold">saveRDS</span>(singler_results_blueprintencode_main, <span style="color:#d14">&#34;</span><span style="color:#d14">data/singler_results_blueprintencode_main.rds&#34;</span>)

p <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">plotScoreHeatmap</span>(
    singler_results_blueprintencode_main,
    show.labels <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">TRUE</span>,
    annotation_col <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">data.frame</span>(
      donor <span style="color:#000;font-weight:bold">=</span> seurat<span style="color:#000;font-weight:bold">@</span>meta.data<span style="color:#000;font-weight:bold">$</span>sample,
      row.names <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">rownames</span>(singler_results_blueprintencode_main)
    )
  )

<span style="color:#900;font-weight:bold">ggsave</span>(
  <span style="color:#d14">&#39;</span><span style="color:#d14">plots/singleR_scoreHeatmap_blueprintencode_main.png&#39;</span>, p,
  height <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">11</span>, width <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">14</span>
)

seurat<span style="color:#000;font-weight:bold">@</span>meta.data<span style="color:#000;font-weight:bold">$</span>cell_type_singler_blueprintencode_main <span style="color:#000;font-weight:bold">&lt;-</span> singler_results_blueprintencode_main<span style="color:#000;font-weight:bold">@</span>listData<span style="color:#000;font-weight:bold">$</span>labels

singler_scores <span style="color:#000;font-weight:bold">&lt;-</span> singler_results_blueprintencode_main<span style="color:#000;font-weight:bold">@</span>listData<span style="color:#000;font-weight:bold">$</span>scores <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">as_tibble</span>() <span style="color:#000;font-weight:bold">%&gt;%</span>
  dplyr<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">mutate</span>(assigned_score <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">NA</span>)

<span style="color:#900;font-weight:bold">for </span>( i in <span style="color:#900;font-weight:bold">seq_len</span>(<span style="color:#900;font-weight:bold">nrow</span>(singler_scores)) ) {
  singler_scores<span style="color:#000;font-weight:bold">$</span>assigned_score[i] <span style="color:#000;font-weight:bold">&lt;-</span> singler_scores[[singler_results_blueprintencode_main<span style="color:#000;font-weight:bold">@</span>listData<span style="color:#000;font-weight:bold">$</span>labels[i]]][i]
}

seurat<span style="color:#000;font-weight:bold">@</span>meta.data<span style="color:#000;font-weight:bold">$</span>cell_type_singler_blueprintencode_main_score <span style="color:#000;font-weight:bold">&lt;-</span> singler_scores<span style="color:#000;font-weight:bold">$</span>assigned_score
</code></pre></div>
<figure >
  
    <a href="/images/projects/scrnaseq_workflow/singleR_scoreHeatmap_blueprintencode_main.png" target="_blank">
      <img src="/images/projects/scrnaseq_workflow/singleR_scoreHeatmap_blueprintencode_main.jpg"  style="width: 100%; max-width: 1000px" />
    </a>
  
  
</figure>


<h3 id="assignment-score-by-sample-cluster-and-cell-type">Assignment score by sample, cluster and cell type</h3>
<p>Here, we plot the assignment score for every sample, cluster, and cell type.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-r" data-lang="r">temp_labels <span style="color:#000;font-weight:bold">&lt;-</span> seurat<span style="color:#000;font-weight:bold">@</span>meta.data <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">group_by</span>(sample) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">tally</span>()

p1 <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">ggplot</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_half_violin</span>(
    data <span style="color:#000;font-weight:bold">=</span> seurat<span style="color:#000;font-weight:bold">@</span>meta.data,
    <span style="color:#900;font-weight:bold">aes</span>(
      x <span style="color:#000;font-weight:bold">=</span> sample,
      y <span style="color:#000;font-weight:bold">=</span> cell_type_singler_blueprintencode_main_score,
      fill <span style="color:#000;font-weight:bold">=</span> sample
    ),
    side <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">l&#39;</span>, show.legend <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">FALSE</span>, trim <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">FALSE</span>
  ) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_half_boxplot</span>(
    data <span style="color:#000;font-weight:bold">=</span> seurat<span style="color:#000;font-weight:bold">@</span>meta.data,
    <span style="color:#900;font-weight:bold">aes</span>(
      x <span style="color:#000;font-weight:bold">=</span> sample,
      y <span style="color:#000;font-weight:bold">=</span> cell_type_singler_blueprintencode_main_score,
      fill <span style="color:#000;font-weight:bold">=</span> sample
    ),
    side <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">r&#39;</span>, outlier.color <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">NA</span>, width <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0.4</span>, show.legend <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">FALSE</span>
  ) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_text</span>(
    data <span style="color:#000;font-weight:bold">=</span> temp_labels,
    <span style="color:#900;font-weight:bold">aes</span>(
      x <span style="color:#000;font-weight:bold">=</span> sample,
      y <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">Inf</span>,
      label <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">paste0</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">n = &#39;</span>, <span style="color:#900;font-weight:bold">format</span>(n, big.mark <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">,&#39;</span>, trim <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">TRUE</span>)),
      vjust <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">-1</span>
    ),
    color <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">black&#39;</span>, size <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">2.8</span>
  ) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_color_manual</span>(values <span style="color:#000;font-weight:bold">=</span> custom_colors<span style="color:#000;font-weight:bold">$</span>discrete) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_fill_manual</span>(values <span style="color:#000;font-weight:bold">=</span> custom_colors<span style="color:#000;font-weight:bold">$</span>discrete) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_y_continuous</span>(
    name <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Assignment score&#39;</span>,
    labels <span style="color:#000;font-weight:bold">=</span> scales<span style="color:#000;font-weight:bold">::</span>comma,
    limits <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">c</span>(<span style="color:#099">0</span>,<span style="color:#099">1</span>)
  ) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme_bw</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">labs</span>(title <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Samples&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme</span>(
    axis.text.x <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_text</span>(angle <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">45</span>, hjust <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">1</span>, vjust <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">1</span>),
    axis.title.x <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    panel.grid.major.x <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>()
  )

temp_labels <span style="color:#000;font-weight:bold">&lt;-</span> seurat<span style="color:#000;font-weight:bold">@</span>meta.data <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">group_by</span>(seurat_clusters) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">tally</span>()

p2 <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">ggplot</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_half_violin</span>(
    data <span style="color:#000;font-weight:bold">=</span> seurat<span style="color:#000;font-weight:bold">@</span>meta.data,
    <span style="color:#900;font-weight:bold">aes</span>(
      x <span style="color:#000;font-weight:bold">=</span> seurat_clusters,
      y <span style="color:#000;font-weight:bold">=</span> cell_type_singler_blueprintencode_main_score,
      fill <span style="color:#000;font-weight:bold">=</span> seurat_clusters
    ),
    side <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">l&#39;</span>, show.legend <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">FALSE</span>, trim <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">FALSE</span>
  ) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_half_boxplot</span>(
    data <span style="color:#000;font-weight:bold">=</span> seurat<span style="color:#000;font-weight:bold">@</span>meta.data,
    <span style="color:#900;font-weight:bold">aes</span>(
      x <span style="color:#000;font-weight:bold">=</span> seurat_clusters,
      y <span style="color:#000;font-weight:bold">=</span> cell_type_singler_blueprintencode_main_score,
      fill <span style="color:#000;font-weight:bold">=</span> seurat_clusters
    ),
    side <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">r&#39;</span>, outlier.color <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">NA</span>, width <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0.4</span>, show.legend <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">FALSE</span>
  ) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_text</span>(
    data <span style="color:#000;font-weight:bold">=</span> temp_labels,
    <span style="color:#900;font-weight:bold">aes</span>(
      x <span style="color:#000;font-weight:bold">=</span> seurat_clusters,
      y <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">Inf</span>,
      label <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">paste0</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">n = &#39;</span>, <span style="color:#900;font-weight:bold">format</span>(n, big.mark <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">,&#39;</span>, trim <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">TRUE</span>)),
      vjust <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">-1</span>
    ),
    color <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">black&#39;</span>, size <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">2.8</span>
  ) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_color_manual</span>(values <span style="color:#000;font-weight:bold">=</span> custom_colors<span style="color:#000;font-weight:bold">$</span>discrete) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_fill_manual</span>(values <span style="color:#000;font-weight:bold">=</span> custom_colors<span style="color:#000;font-weight:bold">$</span>discrete) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_y_continuous</span>(
    name <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Assignment score&#39;</span>,
    labels <span style="color:#000;font-weight:bold">=</span> scales<span style="color:#000;font-weight:bold">::</span>comma,
    limits <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">c</span>(<span style="color:#099">0</span>,<span style="color:#099">1</span>)
  ) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">labs</span>(title <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Clusters&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme_bw</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme</span>(
    axis.title.x <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    panel.grid.major.x <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>()
  )

temp_labels <span style="color:#000;font-weight:bold">&lt;-</span> seurat<span style="color:#000;font-weight:bold">@</span>meta.data <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">group_by</span>(cell_type_singler_blueprintencode_main) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">tally</span>()

p3 <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">ggplot</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_half_violin</span>(
    data <span style="color:#000;font-weight:bold">=</span> seurat<span style="color:#000;font-weight:bold">@</span>meta.data,
    <span style="color:#900;font-weight:bold">aes</span>(
      x <span style="color:#000;font-weight:bold">=</span> cell_type_singler_blueprintencode_main,
      y <span style="color:#000;font-weight:bold">=</span> cell_type_singler_blueprintencode_main_score,
      fill <span style="color:#000;font-weight:bold">=</span> cell_type_singler_blueprintencode_main
    ),
    side <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">l&#39;</span>, show.legend <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">FALSE</span>, trim <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">FALSE</span>
  ) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_half_boxplot</span>(
    data <span style="color:#000;font-weight:bold">=</span> seurat<span style="color:#000;font-weight:bold">@</span>meta.data,
    <span style="color:#900;font-weight:bold">aes</span>(
      x <span style="color:#000;font-weight:bold">=</span> cell_type_singler_blueprintencode_main,
      y <span style="color:#000;font-weight:bold">=</span> cell_type_singler_blueprintencode_main_score,
      fill <span style="color:#000;font-weight:bold">=</span> cell_type_singler_blueprintencode_main
    ),
    side <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">r&#39;</span>, outlier.color <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">NA</span>, width <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0.4</span>, show.legend <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">FALSE</span>
  ) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_text</span>(
    data <span style="color:#000;font-weight:bold">=</span> temp_labels,
    <span style="color:#900;font-weight:bold">aes</span>(
      x <span style="color:#000;font-weight:bold">=</span> cell_type_singler_blueprintencode_main,
      y <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">Inf</span>,
      label <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">paste0</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">n = &#39;</span>, <span style="color:#900;font-weight:bold">format</span>(n, big.mark <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">,&#39;</span>, trim <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">TRUE</span>)),
      vjust <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">-1</span>
    ),
    color <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">black&#39;</span>, size <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">2.8</span>
  ) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_color_manual</span>(values <span style="color:#000;font-weight:bold">=</span> custom_colors<span style="color:#000;font-weight:bold">$</span>discrete) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_fill_manual</span>(values <span style="color:#000;font-weight:bold">=</span> custom_colors<span style="color:#000;font-weight:bold">$</span>discrete) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_y_continuous</span>(
    name <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Assignment score&#39;</span>,
    labels <span style="color:#000;font-weight:bold">=</span> scales<span style="color:#000;font-weight:bold">::</span>comma,
    limits <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">c</span>(<span style="color:#099">0</span>,<span style="color:#099">1</span>)
  ) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">labs</span>(title <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Cell types&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme_bw</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme</span>(
    axis.title.x <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    panel.grid.major.x <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>()
  )

<span style="color:#900;font-weight:bold">ggsave</span>(
  <span style="color:#d14">&#39;</span><span style="color:#d14">plots/singleR_blueprintencode_main_assignment_scores_by_sample_cluster_cell_type.png&#39;</span>,
  p1 <span style="color:#000;font-weight:bold">+</span> p2 <span style="color:#000;font-weight:bold">+</span> p3 <span style="color:#000;font-weight:bold">+</span> <span style="color:#900;font-weight:bold">plot_layout</span>(ncol <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">1</span>), height <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">13</span>, width <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">16</span>
)
</code></pre></div>
<figure >
  
    <a href="/images/projects/scrnaseq_workflow/singleR_blueprintencode_main_assignment_scores_by_sample_cluster_cell_type.png" target="_blank">
      <img src="/images/projects/scrnaseq_workflow/singleR_blueprintencode_main_assignment_scores_by_sample_cluster_cell_type.jpg"  style="width: 100%; max-width: 1000px" />
    </a>
  
  
</figure>


<h3 id="composition-of-samples-and-clusters-by-cell-type">Composition of samples and clusters by cell type</h3>
<p>Then, we check how samples and clusters are composed in terms of identified cell types.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-r" data-lang="r">table_samples_by_cell_type <span style="color:#000;font-weight:bold">&lt;-</span> seurat<span style="color:#000;font-weight:bold">@</span>meta.data <span style="color:#000;font-weight:bold">%&gt;%</span>
  dplyr<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">group_by</span>(sample, cell_type_singler_blueprintencode_main) <span style="color:#000;font-weight:bold">%&gt;%</span>
  dplyr<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">summarize</span>(count <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">n</span>()) <span style="color:#000;font-weight:bold">%&gt;%</span>
  tidyr<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">spread</span>(cell_type_singler_blueprintencode_main, count, fill <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>) <span style="color:#000;font-weight:bold">%&gt;%</span>
  dplyr<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">ungroup</span>() <span style="color:#000;font-weight:bold">%&gt;%</span>
  dplyr<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">mutate</span>(total_cell_count <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">rowSums</span>(<span style="color:#900;font-weight:bold">.[c</span>(<span style="color:#099">2</span><span style="color:#000;font-weight:bold">:</span><span style="color:#900;font-weight:bold">ncol</span>(.))])) <span style="color:#000;font-weight:bold">%&gt;%</span>
  dplyr<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">select</span>(<span style="color:#900;font-weight:bold">c</span>(<span style="color:#d14">&#34;</span><span style="color:#d14">sample&#34;</span>, <span style="color:#d14">&#34;</span><span style="color:#d14">total_cell_count&#34;</span>, dplyr<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">everything</span>()))

table_samples_by_cell_type <span style="color:#000;font-weight:bold">%&gt;%</span> knitr<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">kable</span>()
<span style="color:#998;font-style:italic"># |sample | total_cell_count| B-cells| CD4+ T-cells| CD8+ T-cells| Erythrocytes| HSC| Monocytes| NK cells|</span>
<span style="color:#998;font-style:italic"># |:------|----------------:|-------:|------------:|------------:|------------:|---:|---------:|--------:|</span>
<span style="color:#998;font-style:italic"># |A      |             1696|      45|          328|          336|          357| 225|       370|       35|</span>
<span style="color:#998;font-style:italic"># |B      |             1818|      74|          484|          377|          415| 196|       247|       25|</span>
<span style="color:#998;font-style:italic"># |E      |             1881|     122|          316|          235|         1029|  65|        88|       26|</span>

table_clusters_by_cell_type <span style="color:#000;font-weight:bold">&lt;-</span> seurat<span style="color:#000;font-weight:bold">@</span>meta.data <span style="color:#000;font-weight:bold">%&gt;%</span>
  dplyr<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">group_by</span>(seurat_clusters, cell_type_singler_blueprintencode_main) <span style="color:#000;font-weight:bold">%&gt;%</span>
  dplyr<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">rename</span>(cluster <span style="color:#000;font-weight:bold">=</span> seurat_clusters) <span style="color:#000;font-weight:bold">%&gt;%</span>
  dplyr<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">summarize</span>(count <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">n</span>()) <span style="color:#000;font-weight:bold">%&gt;%</span>
  tidyr<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">spread</span>(cell_type_singler_blueprintencode_main, count, fill <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>) <span style="color:#000;font-weight:bold">%&gt;%</span>
  dplyr<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">ungroup</span>() <span style="color:#000;font-weight:bold">%&gt;%</span>
  dplyr<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">mutate</span>(total_cell_count <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">rowSums</span>(<span style="color:#900;font-weight:bold">.[c</span>(<span style="color:#099">2</span><span style="color:#000;font-weight:bold">:</span><span style="color:#900;font-weight:bold">ncol</span>(.))])) <span style="color:#000;font-weight:bold">%&gt;%</span>
  dplyr<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">select</span>(<span style="color:#900;font-weight:bold">c</span>(<span style="color:#d14">&#34;</span><span style="color:#d14">cluster&#34;</span>, <span style="color:#d14">&#34;</span><span style="color:#d14">total_cell_count&#34;</span>, dplyr<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">everything</span>()))

table_clusters_by_cell_type <span style="color:#000;font-weight:bold">%&gt;%</span> knitr<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">kable</span>()
<span style="color:#998;font-style:italic"># |cluster | total_cell_count| B-cells| CD4+ T-cells| CD8+ T-cells| Erythrocytes| HSC| Monocytes| NK cells|</span>
<span style="color:#998;font-style:italic"># |:-------|----------------:|-------:|------------:|------------:|------------:|---:|---------:|--------:|</span>
<span style="color:#998;font-style:italic"># |0       |             1138|       1|          733|          403|            0|   1|         0|        0|</span>
<span style="color:#998;font-style:italic"># |1       |              616|       0|          387|          229|            0|   0|         0|        0|</span>
<span style="color:#998;font-style:italic"># |2       |              503|       0|            0|            0|          503|   0|         0|        0|</span>
<span style="color:#998;font-style:italic"># |3       |              429|       0|            0|            0|            0|   0|       429|        0|</span>
<span style="color:#998;font-style:italic"># |4       |              353|       0|            0|            0|          353|   0|         0|        0|</span>
<span style="color:#998;font-style:italic"># |5       |              334|       0|            0|            0|          334|   0|         0|        0|</span>
<span style="color:#998;font-style:italic"># |6       |              290|       0|            0|            0|          287|   0|         3|        0|</span>
<span style="color:#998;font-style:italic"># |7       |              229|       0|            0|            0|           11| 218|         0|        0|</span>
<span style="color:#998;font-style:italic"># |8       |              214|       0|            0|          129|            0|   0|         0|       85|</span>
<span style="color:#998;font-style:italic"># |9       |              195|       0|            8|          186|            0|   0|         0|        1|</span>
<span style="color:#998;font-style:italic"># |10      |              193|       0|            0|            0|          193|   0|         0|        0|</span>
<span style="color:#998;font-style:italic"># |11      |              181|     178|            0|            1|            0|   2|         0|        0|</span>
<span style="color:#998;font-style:italic"># |12      |              152|       0|            0|            0|            0|  84|        68|        0|</span>
<span style="color:#998;font-style:italic"># |13      |              150|      34|            0|            0|            5| 111|         0|        0|</span>
<span style="color:#998;font-style:italic"># |14      |              118|       0|            0|            0|          114|   4|         0|        0|</span>
<span style="color:#998;font-style:italic"># |15      |              110|       0|            0|            0|            0|  21|        89|        0|</span>
<span style="color:#998;font-style:italic"># |16      |               90|       0|            0|            0|            0|   0|        90|        0|</span>
<span style="color:#998;font-style:italic"># |17      |               76|       7|            0|            0|            0|  43|        26|        0|</span>
<span style="color:#998;font-style:italic"># |18      |               24|      21|            0|            0|            1|   2|         0|        0|</span>
</code></pre></div>

<div class="tabs">
  <input type="radio" name="composition_samples_clusters_cell_type_1" id="composition_samples_clusters_cell_type_1_1" checked="checked">
  <label for="composition_samples_clusters_cell_type_1_1">Number of cells</label>
  <div class="tab">


<p>Shown below is the composition of samples/clusters by actual number of cells.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-r" data-lang="r">temp_labels <span style="color:#000;font-weight:bold">&lt;-</span> seurat<span style="color:#000;font-weight:bold">@</span>meta.data <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">group_by</span>(sample) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">tally</span>()

p1 <span style="color:#000;font-weight:bold">&lt;-</span> table_samples_by_cell_type <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">select</span>(<span style="color:#000;font-weight:bold">-</span><span style="color:#900;font-weight:bold">c</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">total_cell_count&#39;</span>)) <span style="color:#000;font-weight:bold">%&gt;%</span>
  reshape2<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">melt</span>(id.vars <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">sample&#39;</span>) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">mutate</span>(sample <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">factor</span>(sample, levels <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">levels</span>(seurat<span style="color:#000;font-weight:bold">@</span>meta.data<span style="color:#000;font-weight:bold">$</span>sample))) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">ggplot</span>(<span style="color:#900;font-weight:bold">aes</span>(sample, value)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_bar</span>(<span style="color:#900;font-weight:bold">aes</span>(fill <span style="color:#000;font-weight:bold">=</span> variable), position <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">stack&#39;</span>, stat <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">identity&#39;</span>, show.legend <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">FALSE</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_text</span>(
    data <span style="color:#000;font-weight:bold">=</span> temp_labels,
    <span style="color:#900;font-weight:bold">aes</span>(
      x <span style="color:#000;font-weight:bold">=</span> sample,
      y <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">Inf</span>,
      label <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">paste0</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">n = &#39;</span>, <span style="color:#900;font-weight:bold">format</span>(n, big.mark <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">,&#39;</span>, trim <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">TRUE</span>)),
      vjust <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">-1</span>
    ),
    color <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">black&#39;</span>, size <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">2.8</span>
  ) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_fill_manual</span>(name <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Cell type&#39;</span>, values <span style="color:#000;font-weight:bold">=</span> custom_colors<span style="color:#000;font-weight:bold">$</span>discrete) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_y_continuous</span>(
    name <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Number of cells&#39;</span>,
    labels <span style="color:#000;font-weight:bold">=</span> scales<span style="color:#000;font-weight:bold">::</span>comma,
    expand <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">c</span>(<span style="color:#099">0.01</span>,<span style="color:#099">0</span>)
  ) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">coord_cartesian</span>(clip <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">off&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme_bw</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme</span>(
    legend.position <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">none&#39;</span>,
    plot.title <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_text</span>(hjust <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0.5</span>),
    text <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_text</span>(size <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">16</span>),
    panel.grid.major <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    panel.grid.minor <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    axis.title.x <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    axis.text.x <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_text</span>(angle <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">45</span>, hjust <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">1</span>, vjust <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">1</span>),
    plot.margin <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">margin</span>(t <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">20</span>, r <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>, b <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>, l <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>, unit <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">pt&#39;</span>)
  )

temp_labels <span style="color:#000;font-weight:bold">&lt;-</span> seurat<span style="color:#000;font-weight:bold">@</span>meta.data <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">group_by</span>(seurat_clusters) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">tally</span>() <span style="color:#000;font-weight:bold">%&gt;%</span>
  dplyr<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">rename</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">cluster&#39;</span> <span style="color:#000;font-weight:bold">=</span> seurat_clusters)

p2 <span style="color:#000;font-weight:bold">&lt;-</span> table_clusters_by_cell_type <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">select</span>(<span style="color:#000;font-weight:bold">-</span><span style="color:#900;font-weight:bold">c</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">total_cell_count&#39;</span>)) <span style="color:#000;font-weight:bold">%&gt;%</span>
  reshape2<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">melt</span>(id.vars <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">cluster&#39;</span>) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">mutate</span>(cluster <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">factor</span>(cluster, levels <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">levels</span>(seurat<span style="color:#000;font-weight:bold">@</span>meta.data<span style="color:#000;font-weight:bold">$</span>seurat_clusters))) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">ggplot</span>(<span style="color:#900;font-weight:bold">aes</span>(cluster, value)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_bar</span>(<span style="color:#900;font-weight:bold">aes</span>(fill <span style="color:#000;font-weight:bold">=</span> variable), position <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">stack&#39;</span>, stat <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">identity&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_text</span>(
    data <span style="color:#000;font-weight:bold">=</span> temp_labels,
    <span style="color:#900;font-weight:bold">aes</span>(
      x <span style="color:#000;font-weight:bold">=</span> cluster,
      y <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">Inf</span>,
      label <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">paste0</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">n = &#39;</span>, <span style="color:#900;font-weight:bold">format</span>(n, big.mark <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">,&#39;</span>, trim <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">TRUE</span>)),
      vjust <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">-1</span>
    ), color <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">black&#39;</span>, size <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">2.8</span>
  ) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_fill_manual</span>(name <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Cell type&#39;</span>, values <span style="color:#000;font-weight:bold">=</span> custom_colors<span style="color:#000;font-weight:bold">$</span>discrete) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_y_continuous</span>(
    name <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Number of cells&#39;</span>,
    labels <span style="color:#000;font-weight:bold">=</span> scales<span style="color:#000;font-weight:bold">::</span>comma,
    expand <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">c</span>(<span style="color:#099">0.01</span>,<span style="color:#099">0</span>)
  ) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">coord_cartesian</span>(clip <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">off&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme_bw</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme</span>(
    legend.position <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">right&#39;</span>,
    plot.title <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_text</span>(hjust <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0.5</span>),
    text <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_text</span>(size <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">16</span>),
    panel.grid.major <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    panel.grid.minor <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    axis.title <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    plot.margin <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">margin</span>(t <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">20</span>, r <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>, b <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>, l <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">10</span>, unit <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">pt&#39;</span>)
  )

<span style="color:#900;font-weight:bold">ggsave</span>(
  <span style="color:#d14">&#39;</span><span style="color:#d14">plots/composition_samples_clusters_by_cell_type_singler_blueprintencode_main_by_number.png&#39;</span>,
  p1 <span style="color:#000;font-weight:bold">+</span> p2 <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">plot_layout</span>(ncol <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">2</span>, widths <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">c</span>(
    seurat<span style="color:#000;font-weight:bold">@</span>meta.data<span style="color:#000;font-weight:bold">$</span>sample <span style="color:#000;font-weight:bold">%&gt;%</span> <span style="color:#900;font-weight:bold">unique</span>() <span style="color:#000;font-weight:bold">%&gt;%</span> <span style="color:#900;font-weight:bold">length</span>(),
    seurat<span style="color:#000;font-weight:bold">@</span>meta.data<span style="color:#000;font-weight:bold">$</span>seurat_clusters <span style="color:#000;font-weight:bold">%&gt;%</span> <span style="color:#900;font-weight:bold">unique</span>() <span style="color:#000;font-weight:bold">%&gt;%</span> <span style="color:#900;font-weight:bold">length</span>()
  )),
  width <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">18</span>, height <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">8</span>
)
</code></pre></div>
<figure >
  
    <a href="/images/projects/scrnaseq_workflow/composition_samples_clusters_by_cell_type_singler_blueprintencode_main_by_number.png" target="_blank">
      <img src="/images/projects/scrnaseq_workflow/composition_samples_clusters_by_cell_type_singler_blueprintencode_main_by_number.jpg"  style="width: 100%; max-width: 1000px" />
    </a>
  
  
</figure>




  </div>
  <input type="radio" name="composition_samples_clusters_cell_type_1" id="composition_samples_clusters_cell_type_1_2">
  <label for="composition_samples_clusters_cell_type_1_2">Percent of cells</label>
  <div class="tab">


<p>Shown below is the composition of samples/clusters by percent of cells.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-r" data-lang="r">temp_labels <span style="color:#000;font-weight:bold">&lt;-</span> seurat<span style="color:#000;font-weight:bold">@</span>meta.data <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">group_by</span>(sample) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">tally</span>()

p1 <span style="color:#000;font-weight:bold">&lt;-</span> table_samples_by_cell_type <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">select</span>(<span style="color:#000;font-weight:bold">-</span><span style="color:#900;font-weight:bold">c</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">total_cell_count&#39;</span>)) <span style="color:#000;font-weight:bold">%&gt;%</span>
  reshape2<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">melt</span>(id.vars <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">sample&#39;</span>) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">mutate</span>(sample <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">factor</span>(sample, levels <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">levels</span>(seurat<span style="color:#000;font-weight:bold">@</span>meta.data<span style="color:#000;font-weight:bold">$</span>sample))) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">ggplot</span>(<span style="color:#900;font-weight:bold">aes</span>(sample, value)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_bar</span>(<span style="color:#900;font-weight:bold">aes</span>(fill <span style="color:#000;font-weight:bold">=</span> variable), position <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">fill&#39;</span>, stat <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">identity&#39;</span>, show.legend <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">FALSE</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_text</span>(
    data <span style="color:#000;font-weight:bold">=</span> temp_labels,
    <span style="color:#900;font-weight:bold">aes</span>(
      x <span style="color:#000;font-weight:bold">=</span> sample,
      y <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">Inf</span>,
      label <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">paste0</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">n = &#39;</span>, <span style="color:#900;font-weight:bold">format</span>(n, big.mark <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">,&#39;</span>, trim <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">TRUE</span>)),
      vjust <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">-1</span>
    ),
    color <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">black&#39;</span>, size <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">2.8</span>
  ) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_fill_manual</span>(name <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Cell type&#39;</span>, values <span style="color:#000;font-weight:bold">=</span> custom_colors<span style="color:#000;font-weight:bold">$</span>discrete) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_y_continuous</span>(
    name <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Percentage [%]&#39;</span>,
    labels <span style="color:#000;font-weight:bold">=</span> scales<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">percent_format</span>(),
    expand <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">c</span>(<span style="color:#099">0.01</span>,<span style="color:#099">0</span>)
  ) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">coord_cartesian</span>(clip <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">off&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme_bw</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme</span>(
    legend.position <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">none&#39;</span>,
    plot.title <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_text</span>(hjust <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0.5</span>),
    text <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_text</span>(size <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">16</span>),
    panel.grid.major <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    panel.grid.minor <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    axis.title.x <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    axis.text.x <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_text</span>(angle <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">45</span>, hjust <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">1</span>, vjust <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">1</span>),
    plot.margin <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">margin</span>(t <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">20</span>, r <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>, b <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>, l <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>, unit <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">pt&#39;</span>)
  )

temp_labels <span style="color:#000;font-weight:bold">&lt;-</span> seurat<span style="color:#000;font-weight:bold">@</span>meta.data <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">group_by</span>(seurat_clusters) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">tally</span>() <span style="color:#000;font-weight:bold">%&gt;%</span>
  dplyr<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">rename</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">cluster&#39;</span> <span style="color:#000;font-weight:bold">=</span> seurat_clusters)

p2 <span style="color:#000;font-weight:bold">&lt;-</span> table_clusters_by_cell_type <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">select</span>(<span style="color:#000;font-weight:bold">-</span><span style="color:#900;font-weight:bold">c</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">total_cell_count&#39;</span>)) <span style="color:#000;font-weight:bold">%&gt;%</span>
  reshape2<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">melt</span>(id.vars <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">cluster&#39;</span>) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">mutate</span>(cluster <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">factor</span>(cluster, levels <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">levels</span>(seurat<span style="color:#000;font-weight:bold">@</span>meta.data<span style="color:#000;font-weight:bold">$</span>seurat_clusters))) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">ggplot</span>(<span style="color:#900;font-weight:bold">aes</span>(cluster, value)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_bar</span>(<span style="color:#900;font-weight:bold">aes</span>(fill <span style="color:#000;font-weight:bold">=</span> variable), position <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">fill&#39;</span>, stat <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">identity&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_text</span>(
    data <span style="color:#000;font-weight:bold">=</span> temp_labels,
    <span style="color:#900;font-weight:bold">aes</span>(
      x <span style="color:#000;font-weight:bold">=</span> cluster,
      y <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">Inf</span>,
      label <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">paste0</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">n = &#39;</span>, <span style="color:#900;font-weight:bold">format</span>(n, big.mark <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">,&#39;</span>, trim <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">TRUE</span>)),
      vjust <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">-1</span>
    ),
    color <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">black&#39;</span>, size <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">2.8</span>
  ) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_fill_manual</span>(name <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Cell type&#39;</span>, values <span style="color:#000;font-weight:bold">=</span> custom_colors<span style="color:#000;font-weight:bold">$</span>discrete) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_y_continuous</span>(
    name <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Percentage [%]&#39;</span>,
    labels <span style="color:#000;font-weight:bold">=</span> scales<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">percent_format</span>(),
    expand <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">c</span>(<span style="color:#099">0.01</span>,<span style="color:#099">0</span>)
  ) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">coord_cartesian</span>(clip <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">off&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme_bw</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme</span>(
    legend.position <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">right&#39;</span>,
    plot.title <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_text</span>(hjust <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0.5</span>),
    text <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_text</span>(size <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">16</span>),
    panel.grid.major <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    panel.grid.minor <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    axis.title <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    plot.margin <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">margin</span>(t <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">20</span>, r <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>, b <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>, l <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">10</span>, unit <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">pt&#39;</span>)
  )

<span style="color:#900;font-weight:bold">ggsave</span>(
  <span style="color:#d14">&#39;</span><span style="color:#d14">plots/composition_samples_clusters_by_cell_type_singler_blueprintencode_main_by_percent.png&#39;</span>,
  p1 <span style="color:#000;font-weight:bold">+</span> p2 <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">plot_layout</span>(ncol <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">2</span>, widths <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">c</span>(
    seurat<span style="color:#000;font-weight:bold">@</span>meta.data<span style="color:#000;font-weight:bold">$</span>sample <span style="color:#000;font-weight:bold">%&gt;%</span> <span style="color:#900;font-weight:bold">unique</span>() <span style="color:#000;font-weight:bold">%&gt;%</span> <span style="color:#900;font-weight:bold">length</span>(),
    seurat<span style="color:#000;font-weight:bold">@</span>meta.data<span style="color:#000;font-weight:bold">$</span>seurat_clusters <span style="color:#000;font-weight:bold">%&gt;%</span> <span style="color:#900;font-weight:bold">unique</span>() <span style="color:#000;font-weight:bold">%&gt;%</span> <span style="color:#900;font-weight:bold">length</span>()
  )),
  width <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">18</span>, height <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">8</span>
)
</code></pre></div>
<figure >
  
    <a href="/images/projects/scrnaseq_workflow/composition_samples_clusters_by_cell_type_singler_blueprintencode_main_by_percent.png" target="_blank">
      <img src="/images/projects/scrnaseq_workflow/composition_samples_clusters_by_cell_type_singler_blueprintencode_main_by_percent.jpg"  style="width: 100%; max-width: 1000px" />
    </a>
  
  
</figure>




  </div>
</div>


<h4 id="alluvial-plots">Alluvial plots</h4>
<p>Samples by clusters.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-r" data-lang="r"><span style="color:#998;font-style:italic">## get sample and cluster names</span>
samples <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">levels</span>(seurat<span style="color:#000;font-weight:bold">@</span>meta.data<span style="color:#000;font-weight:bold">$</span>sample)
clusters <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">levels</span>(seurat<span style="color:#000;font-weight:bold">@</span>meta.data<span style="color:#000;font-weight:bold">$</span>seurat_clusters)

<span style="color:#998;font-style:italic">## create named vector holding the color assignments for both samples and</span>
<span style="color:#998;font-style:italic">## clusters</span>
color_assignments <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">setNames</span>(
  <span style="color:#900;font-weight:bold">c</span>(custom_colors<span style="color:#000;font-weight:bold">$</span>discrete[1<span style="color:#000;font-weight:bold">:</span><span style="color:#900;font-weight:bold">length</span>(samples)], custom_colors<span style="color:#000;font-weight:bold">$</span>discrete[1<span style="color:#000;font-weight:bold">:</span><span style="color:#900;font-weight:bold">length</span>(clusters)]),
  <span style="color:#900;font-weight:bold">c</span>(samples,clusters)
)

<span style="color:#998;font-style:italic">## prepare data for the plot; factor() calls are necessary for the right order</span>
<span style="color:#998;font-style:italic">## of columns (first samples then clusters) and boxes within each column (</span>
<span style="color:#998;font-style:italic">## cluster 1, 2, 3, ..., not 1, 10, 11, ...)</span>
data <span style="color:#000;font-weight:bold">&lt;-</span> seurat<span style="color:#000;font-weight:bold">@</span>meta.data <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">group_by</span>(sample,seurat_clusters) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">tally</span>() <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">ungroup</span>() <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">gather_set_data</span>(<span style="color:#099">1</span><span style="color:#000;font-weight:bold">:</span><span style="color:#099">2</span>) <span style="color:#000;font-weight:bold">%&gt;%</span>
  dplyr<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">mutate</span>(
    x <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">factor</span>(x, levels <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">unique</span>(x)),
    y <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">factor</span>(y, levels <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">unique</span>(y))
  )

<span style="color:#900;font-weight:bold">DataFrame</span>(data)
<span style="color:#998;font-style:italic"># DataFrame with 114 rows and 6 columns</span>
<span style="color:#998;font-style:italic">#       sample seurat_clusters         n        id               x        y</span>
<span style="color:#998;font-style:italic">#     &lt;factor&gt;        &lt;factor&gt; &lt;integer&gt; &lt;integer&gt;        &lt;factor&gt; &lt;factor&gt;</span>
<span style="color:#998;font-style:italic"># 1          A               0       301         1          sample        A</span>
<span style="color:#998;font-style:italic"># 2          A               1       137         2          sample        A</span>
<span style="color:#998;font-style:italic"># 3          A               2       121         3          sample        A</span>
<span style="color:#998;font-style:italic"># 4          A               3       223         4          sample        A</span>
<span style="color:#998;font-style:italic"># 5          A               4        78         5          sample        A</span>
<span style="color:#998;font-style:italic"># ...      ...             ...       ...       ...             ...      ...</span>
<span style="color:#998;font-style:italic"># 110        E              14        19        53 seurat_clusters       14</span>
<span style="color:#998;font-style:italic"># 111        E              15        18        54 seurat_clusters       15</span>
<span style="color:#998;font-style:italic"># 112        E              16        10        55 seurat_clusters       16</span>
<span style="color:#998;font-style:italic"># 113        E              17         9        56 seurat_clusters       17</span>
<span style="color:#998;font-style:italic"># 114        E              18        15        57 seurat_clusters       18</span>

<span style="color:#998;font-style:italic">## create sample and cluster labels; hjust defines whether a label will be</span>
<span style="color:#998;font-style:italic">## aligned to the right (1) or to the left (0); the nudge_x parameter is used</span>
<span style="color:#998;font-style:italic">## to move the label outside of the boxes</span>
data_labels <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">tibble</span>(
    group <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">c</span>(
      <span style="color:#900;font-weight:bold">rep</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">sample&#39;</span>, <span style="color:#900;font-weight:bold">length</span>(samples)),
      <span style="color:#900;font-weight:bold">rep</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">seurat_clusters&#39;</span>, <span style="color:#900;font-weight:bold">length</span>(clusters))
    )
 ) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">mutate</span>(
    hjust <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">ifelse</span>(group <span style="color:#000;font-weight:bold">==</span> <span style="color:#d14">&#39;</span><span style="color:#d14">sample&#39;</span>, <span style="color:#099">1</span>, <span style="color:#099">0</span>),
    nudge_x <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">ifelse</span>(group <span style="color:#000;font-weight:bold">==</span> <span style="color:#d14">&#39;</span><span style="color:#d14">sample&#39;</span>, <span style="color:#099">-0.1</span>, <span style="color:#099">0.1</span>)
  )

<span style="color:#900;font-weight:bold">DataFrame</span>(data_labels)
<span style="color:#998;font-style:italic"># DataFrame with 22 rows and 3 columns</span>
<span style="color:#998;font-style:italic">#               group     hjust   nudge_x</span>
<span style="color:#998;font-style:italic">#         &lt;character&gt; &lt;numeric&gt; &lt;numeric&gt;</span>
<span style="color:#998;font-style:italic"># 1            sample         1      -0.1</span>
<span style="color:#998;font-style:italic"># 2            sample         1      -0.1</span>
<span style="color:#998;font-style:italic"># 3            sample         1      -0.1</span>
<span style="color:#998;font-style:italic"># 4   seurat_clusters         0       0.1</span>
<span style="color:#998;font-style:italic"># 5   seurat_clusters         0       0.1</span>
<span style="color:#998;font-style:italic"># ...             ...       ...       ...</span>
<span style="color:#998;font-style:italic"># 18  seurat_clusters         0       0.1</span>
<span style="color:#998;font-style:italic"># 19  seurat_clusters         0       0.1</span>
<span style="color:#998;font-style:italic"># 20  seurat_clusters         0       0.1</span>
<span style="color:#998;font-style:italic"># 21  seurat_clusters         0       0.1</span>
<span style="color:#998;font-style:italic"># 22  seurat_clusters         0       0.1</span>

<span style="color:#998;font-style:italic">## create plot</span>
p1 <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">ggplot</span>(data, <span style="color:#900;font-weight:bold">aes</span>(x, id <span style="color:#000;font-weight:bold">=</span> id, split <span style="color:#000;font-weight:bold">=</span> y, value <span style="color:#000;font-weight:bold">=</span> n)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_parallel_sets</span>(<span style="color:#900;font-weight:bold">aes</span>(fill <span style="color:#000;font-weight:bold">=</span> seurat_clusters), alpha <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0.75</span>, axis.width <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0.15</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_parallel_sets_axes</span>(<span style="color:#900;font-weight:bold">aes</span>(fill <span style="color:#000;font-weight:bold">=</span> y), color <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">black&#39;</span>, axis.width <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0.1</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_text</span>(
    <span style="color:#900;font-weight:bold">aes</span>(y <span style="color:#000;font-weight:bold">=</span> n, split <span style="color:#000;font-weight:bold">=</span> y), stat <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">parallel_sets_axes&#39;</span>, fontface <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">bold&#39;</span>,
    hjust <span style="color:#000;font-weight:bold">=</span> data_labels<span style="color:#000;font-weight:bold">$</span>hjust, nudge_x <span style="color:#000;font-weight:bold">=</span> data_labels<span style="color:#000;font-weight:bold">$</span>nudge_x
  ) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_x_discrete</span>(labels <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">c</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">Sample&#39;</span>,<span style="color:#d14">&#39;</span><span style="color:#d14">Cluster&#39;</span>)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_fill_manual</span>(values <span style="color:#000;font-weight:bold">=</span> color_assignments) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme_bw</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme</span>(
    legend.position <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">none&#39;</span>,
    axis.title <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    axis.text.x <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_text</span>(face <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">bold&#39;</span>, colour <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">black&#39;</span>, size <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">15</span>),
    axis.text.y <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    axis.ticks <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    panel.grid.major <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    panel.grid.minor <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    panel.border <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>()
  )
</code></pre></div><p>Clusters by cell types.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-r" data-lang="r">clusters <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">levels</span>(seurat<span style="color:#000;font-weight:bold">@</span>meta.data<span style="color:#000;font-weight:bold">$</span>seurat_clusters)
cell_types <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">sort</span>(<span style="color:#900;font-weight:bold">unique</span>(seurat<span style="color:#000;font-weight:bold">@</span>meta.data<span style="color:#000;font-weight:bold">$</span>cell_type_singler_blueprintencode_main))

color_assignments <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">setNames</span>(
  <span style="color:#900;font-weight:bold">c</span>(custom_colors<span style="color:#000;font-weight:bold">$</span>discrete[1<span style="color:#000;font-weight:bold">:</span><span style="color:#900;font-weight:bold">length</span>(clusters)], custom_colors<span style="color:#000;font-weight:bold">$</span>discrete[1<span style="color:#000;font-weight:bold">:</span><span style="color:#900;font-weight:bold">length</span>(cell_types)]),
  <span style="color:#900;font-weight:bold">c</span>(clusters,cell_types)
)

data <span style="color:#000;font-weight:bold">&lt;-</span> seurat<span style="color:#000;font-weight:bold">@</span>meta.data <span style="color:#000;font-weight:bold">%&gt;%</span>
  dplyr<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">rename</span>(cell_type <span style="color:#000;font-weight:bold">=</span> cell_type_singler_blueprintencode_main) <span style="color:#000;font-weight:bold">%&gt;%</span>
  dplyr<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">mutate</span>(cell_type <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">factor</span>(cell_type, levels <span style="color:#000;font-weight:bold">=</span> cell_types)) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">group_by</span>(seurat_clusters, cell_type) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">tally</span>() <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">ungroup</span>() <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">gather_set_data</span>(<span style="color:#099">1</span><span style="color:#000;font-weight:bold">:</span><span style="color:#099">2</span>) <span style="color:#000;font-weight:bold">%&gt;%</span>
  dplyr<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">mutate</span>(
    x <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">factor</span>(x, levels <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">unique</span>(x)),
    y <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">factor</span>(y, levels <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">c</span>(clusters,cell_types))
  )

data_labels <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">tibble</span>(
    group <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">c</span>(
      <span style="color:#900;font-weight:bold">rep</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">seurat_clusters&#39;</span>, <span style="color:#900;font-weight:bold">length</span>(clusters)),
      <span style="color:#900;font-weight:bold">rep</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">cell_type&#39;</span>, <span style="color:#900;font-weight:bold">length</span>(cell_types))
    )
 ) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">mutate</span>(
    hjust <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">ifelse</span>(group <span style="color:#000;font-weight:bold">==</span> <span style="color:#d14">&#39;</span><span style="color:#d14">seurat_clusters&#39;</span>, <span style="color:#099">1</span>, <span style="color:#099">0</span>),
    nudge_x <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">ifelse</span>(group <span style="color:#000;font-weight:bold">==</span> <span style="color:#d14">&#39;</span><span style="color:#d14">seurat_clusters&#39;</span>, <span style="color:#099">-0.1</span>, <span style="color:#099">0.1</span>)
  )

p2 <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">ggplot</span>(data, <span style="color:#900;font-weight:bold">aes</span>(x, id <span style="color:#000;font-weight:bold">=</span> id, split <span style="color:#000;font-weight:bold">=</span> y, value <span style="color:#000;font-weight:bold">=</span> n)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_parallel_sets</span>(<span style="color:#900;font-weight:bold">aes</span>(fill <span style="color:#000;font-weight:bold">=</span> seurat_clusters), alpha <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0.75</span>, axis.width <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0.15</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_parallel_sets_axes</span>(<span style="color:#900;font-weight:bold">aes</span>(fill <span style="color:#000;font-weight:bold">=</span> y), color <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">black&#39;</span>, axis.width <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0.1</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_text</span>(
    <span style="color:#900;font-weight:bold">aes</span>(y <span style="color:#000;font-weight:bold">=</span> n, split <span style="color:#000;font-weight:bold">=</span> y), stat <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">parallel_sets_axes&#39;</span>, fontface <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">bold&#39;</span>,
    hjust <span style="color:#000;font-weight:bold">=</span> data_labels<span style="color:#000;font-weight:bold">$</span>hjust, nudge_x <span style="color:#000;font-weight:bold">=</span> data_labels<span style="color:#000;font-weight:bold">$</span>nudge_x
  ) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_x_discrete</span>(labels <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">c</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">Cluster&#39;</span>,<span style="color:#d14">&#39;</span><span style="color:#d14">Cell type&#39;</span>)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_fill_manual</span>(values <span style="color:#000;font-weight:bold">=</span> color_assignments) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme_bw</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme</span>(
    legend.position <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">none&#39;</span>,
    axis.title <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    axis.text.x <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_text</span>(face <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">bold&#39;</span>, colour <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">black&#39;</span>, size <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">15</span>),
    axis.text.y <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    axis.ticks <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    panel.grid.major <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    panel.grid.minor <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    panel.border <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>()
  )
</code></pre></div><p>Combine the two plots.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-r" data-lang="r"><span style="color:#900;font-weight:bold">ggsave</span>(
  <span style="color:#d14">&#39;</span><span style="color:#d14">plots/samples_clusters_cell_types_alluvial.png&#39;</span>,
  p1 <span style="color:#000;font-weight:bold">+</span> p2 <span style="color:#000;font-weight:bold">+</span> <span style="color:#900;font-weight:bold">plot_layout</span>(ncol <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">2</span>),
  height <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">6</span>, width <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">8</span>
)
</code></pre></div>
<figure >
  
    <a href="/images/projects/scrnaseq_workflow/samples_clusters_cell_types_alluvial.png" target="_blank">
      <img src="/images/projects/scrnaseq_workflow/samples_clusters_cell_types_alluvial.jpg"  style="width: 100%; max-width: 1000px" />
    </a>
  
  
</figure>


<p><strong>Notes:</strong> It's currently not possible to scale the columns to equal heights with <code>ggforce</code>.
For example, I would expect the &ldquo;Samples&rdquo; columns to reach equal height as the &ldquo;Cluster&rdquo; column by increasing the gap size since it's the same number of total cells.
Anyway, I think it's still the best tool in R to make alluvial plots.</p>
<h3 id="umap-by-cell-type">UMAP by cell type</h3>
<p>Similar to the UMAP plot of clusters, we add cell type labels to the UMAP.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-r" data-lang="r">UMAP_centers_cell_type <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">tibble</span>(
    UMAP_1 <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">as.data.frame</span>(seurat<span style="color:#000;font-weight:bold">@</span>reductions<span style="color:#000;font-weight:bold">$</span>UMAP<span style="color:#000;font-weight:bold">@</span>cell.embeddings)<span style="color:#000;font-weight:bold">$</span>UMAP_1,
    UMAP_2 <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">as.data.frame</span>(seurat<span style="color:#000;font-weight:bold">@</span>reductions<span style="color:#000;font-weight:bold">$</span>UMAP<span style="color:#000;font-weight:bold">@</span>cell.embeddings)<span style="color:#000;font-weight:bold">$</span>UMAP_2,
    cell_type <span style="color:#000;font-weight:bold">=</span> seurat<span style="color:#000;font-weight:bold">@</span>meta.data<span style="color:#000;font-weight:bold">$</span>cell_type_singler_blueprintencode_main
  ) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">group_by</span>(cell_type) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">summarize</span>(x <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">median</span>(UMAP_1), y <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">median</span>(UMAP_2))

p <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">bind_cols</span>(seurat<span style="color:#000;font-weight:bold">@</span>meta.data, <span style="color:#900;font-weight:bold">as.data.frame</span>(seurat<span style="color:#000;font-weight:bold">@</span>reductions<span style="color:#000;font-weight:bold">$</span>UMAP<span style="color:#000;font-weight:bold">@</span>cell.embeddings)) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">ggplot</span>(<span style="color:#900;font-weight:bold">aes</span>(UMAP_1, UMAP_2, color <span style="color:#000;font-weight:bold">=</span> cell_type_singler_blueprintencode_main)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_point</span>(size <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0.2</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_label</span>(
    data <span style="color:#000;font-weight:bold">=</span> UMAP_centers_cell_type,
    mapping <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">aes</span>(x, y, label <span style="color:#000;font-weight:bold">=</span> cell_type),
    size <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">3.5</span>,
    fill <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">white&#39;</span>,
    color <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">black&#39;</span>,
    fontface <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">bold&#39;</span>,
    alpha <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0.5</span>,
    label.size <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>,
    show.legend <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">FALSE</span>
  ) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme_bw</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">expand_limits</span>(x <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">c</span>(<span style="color:#099">-22</span>,<span style="color:#099">15</span>)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_color_manual</span>(values <span style="color:#000;font-weight:bold">=</span> custom_colors<span style="color:#000;font-weight:bold">$</span>discrete) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">labs</span>(color <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Cell type&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">guides</span>(colour <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">guide_legend</span>(override.aes <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">list</span>(size <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">2</span>))) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme</span>(legend.position <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">right&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">coord_fixed</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">annotate</span>(
    geom <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">text&#39;</span>, x <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">Inf</span>, y <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">Inf</span>,
    label <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">paste0</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">n = &#39;</span>, <span style="color:#900;font-weight:bold">format</span>(<span style="color:#900;font-weight:bold">nrow</span>(seurat<span style="color:#000;font-weight:bold">@</span>meta.data), big.mark <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">,&#39;</span>, trim <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">TRUE</span>)),
    vjust <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">-1.5</span>, hjust <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">1.25</span>, color <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">black&#39;</span>, size <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">2.5</span>
  )

<span style="color:#900;font-weight:bold">ggsave</span>(
  <span style="color:#d14">&#39;</span><span style="color:#d14">plots/UMAP_by_cell_type_singler_blueprintencode_main.png&#39;</span>,
  p,
  height <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">4</span>,
  width <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">6</span>
)
</code></pre></div>
<figure >
  
    <a href="/images/projects/scrnaseq_workflow/UMAP_by_cell_type_singler_blueprintencode_main.png" target="_blank">
      <img src="/images/projects/scrnaseq_workflow/UMAP_by_cell_type_singler_blueprintencode_main.jpg"  style="width: 100%; max-width: 1000px" />
    </a>
  
  
</figure>


<p>To understand whether cell types overlap in the UMAP (which would be hard to see in the previous plot), we also plot the same and split the panels by cell type.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-r" data-lang="r">temp_labels <span style="color:#000;font-weight:bold">&lt;-</span> seurat<span style="color:#000;font-weight:bold">@</span>meta.data <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">group_by</span>(cell_type_singler_blueprintencode_main) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">tally</span>()

p <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">bind_cols</span>(seurat<span style="color:#000;font-weight:bold">@</span>meta.data, <span style="color:#900;font-weight:bold">as.data.frame</span>(seurat<span style="color:#000;font-weight:bold">@</span>reductions<span style="color:#000;font-weight:bold">$</span>UMAP<span style="color:#000;font-weight:bold">@</span>cell.embeddings)) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">ggplot</span>(<span style="color:#900;font-weight:bold">aes</span>(UMAP_1, UMAP_2, color <span style="color:#000;font-weight:bold">=</span> cell_type_singler_blueprintencode_main)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_point</span>(size <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0.2</span>, show.legend <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">FALSE</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_text</span>(
    data <span style="color:#000;font-weight:bold">=</span> temp_labels,
    <span style="color:#900;font-weight:bold">aes</span>(
      x <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">Inf</span>,
      y <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">Inf</span>,
      label <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">paste0</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">n = &#39;</span>, <span style="color:#900;font-weight:bold">format</span>(n, big.mark <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">,&#39;</span>, trim <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">TRUE</span>)),
      vjust <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">-1.5</span>,
      hjust <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">1.25</span>
    ),
    color <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">black&#39;</span>, size <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">2.8</span>
  ) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme_bw</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_color_manual</span>(values <span style="color:#000;font-weight:bold">=</span> custom_colors<span style="color:#000;font-weight:bold">$</span>discrete) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">labs</span>(color <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Cell type&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">guides</span>(colour <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">guide_legend</span>(override.aes <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">list</span>(size <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">2</span>))) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">coord_fixed</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">facet_wrap</span>(<span style="color:#000;font-weight:bold">~</span>cell_type_singler_blueprintencode_main, ncol <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">4</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme</span>(
    legend.position <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">right&#39;</span>,
    strip.text <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_text</span>(face <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">bold&#39;</span>, size <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">10</span>)
  )

<span style="color:#900;font-weight:bold">ggsave</span>(
  <span style="color:#d14">&#39;</span><span style="color:#d14">plots/UMAP_by_cell_type_singler_blueprintencode_main_split.png&#39;</span>,
  p, height <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">5</span>, width <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">8</span>
)
</code></pre></div>
<figure >
  
    <a href="/images/projects/scrnaseq_workflow/UMAP_by_cell_type_singler_blueprintencode_main_split.png" target="_blank">
      <img src="/images/projects/scrnaseq_workflow/UMAP_by_cell_type_singler_blueprintencode_main_split.jpg"  style="width: 100%; max-width: 1000px" />
    </a>
  
  
</figure>


<h3 id="umap-by-assignment-score">UMAP by assignment score</h3>
<p>Lastly, we make another UMAP with the cells colored by their assignment score.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-r" data-lang="r">p <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">bind_cols</span>(seurat<span style="color:#000;font-weight:bold">@</span>meta.data, <span style="color:#900;font-weight:bold">as.data.frame</span>(seurat<span style="color:#000;font-weight:bold">@</span>reductions<span style="color:#000;font-weight:bold">$</span>UMAP<span style="color:#000;font-weight:bold">@</span>cell.embeddings)) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">ggplot</span>(<span style="color:#900;font-weight:bold">aes</span>(UMAP_1, UMAP_2, color <span style="color:#000;font-weight:bold">=</span> cell_type_singler_blueprintencode_main_score)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_point</span>(size <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0.2</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme_bw</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_color_viridis</span>(
    name <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Score&#39;</span>, limits <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">c</span>(<span style="color:#099">0</span>,<span style="color:#099">1</span>), oob <span style="color:#000;font-weight:bold">=</span> scales<span style="color:#000;font-weight:bold">::</span>squish,
    guide <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">guide_colorbar</span>(frame.colour <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">black&#39;</span>, ticks.colour <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">black&#39;</span>)
  ) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">labs</span>(color <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Cell type&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme</span>(legend.position <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">right&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">coord_fixed</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">annotate</span>(
    geom <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">text&#39;</span>, x <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">Inf</span>, y <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">Inf</span>,
    label <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">paste0</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">n = &#39;</span>, <span style="color:#900;font-weight:bold">format</span>(<span style="color:#900;font-weight:bold">nrow</span>(seurat<span style="color:#000;font-weight:bold">@</span>meta.data), big.mark <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">,&#39;</span>, trim <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">TRUE</span>)),
    vjust <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">-1.5</span>, hjust <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">1.25</span>, color <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">black&#39;</span>, size <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">2.5</span>
  )

<span style="color:#900;font-weight:bold">ggsave</span>(
  <span style="color:#d14">&#39;</span><span style="color:#d14">plots/UMAP_by_cell_type_singler_blueprintencode_main_score.png&#39;</span>,
  p,
  height <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">5</span>,
  width <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">5.5</span>
)
</code></pre></div>
<figure >
  
    <a href="/images/projects/scrnaseq_workflow/UMAP_by_cell_type_singler_blueprintencode_main_score.png" target="_blank">
      <img src="/images/projects/scrnaseq_workflow/UMAP_by_cell_type_singler_blueprintencode_main_score.jpg"  style="width: 100%; max-width: 1000px" />
    </a>
  
  
</figure>


<h2 id="perform-analysis-for-cerebro">Perform analysis for Cerebro</h2>
<p>To allow further investigation of the data set in <a href="https://github.com/romanhaa/Cerebro">Cerebro</a> [4], we now add some more meta data, calculate marker genes, pathway enrichment of the marker genes, and export the data set. This procedure largely follows the workflow described on the <a href="https://romanhaa.github.io/cerebroApp/articles/cerebroApp_workflow_Seurat.html">cerebroApp website</a>.</p>
<h3 id="add-meta-data">Add meta data</h3>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-r" data-lang="r">seurat<span style="color:#000;font-weight:bold">@</span>misc<span style="color:#000;font-weight:bold">$</span>experiment <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">list</span>(
  experiment_name <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">bone_marrow_donor_cells&#39;</span>,
  organism <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">hg&#39;</span>,
  date_of_analysis <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">Sys.Date</span>()
)

seurat<span style="color:#000;font-weight:bold">@</span>misc<span style="color:#000;font-weight:bold">$</span>parameters <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">list</span>(
  gene_nomenclature <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">gene_name&#39;</span>,
  discard_genes_expressed_in_fewer_cells_than <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">6</span>,
  keep_mitochondrial_genes <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">TRUE</span>,
  variables_to_regress_out <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">nCount&#39;</span>,
  number_PCs <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">15</span>,
  cluster_resolution <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0.8</span>
)

seurat<span style="color:#000;font-weight:bold">@</span>misc<span style="color:#000;font-weight:bold">$</span>parameters<span style="color:#000;font-weight:bold">$</span>filtering <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">list</span>(
  UMI_min <span style="color:#000;font-weight:bold">=</span> thresholds_nCount[1],
  UMI_max <span style="color:#000;font-weight:bold">=</span> thresholds_nCount[2],
  genes_min <span style="color:#000;font-weight:bold">=</span> thresholds_nFeature[1],
  genes_max <span style="color:#000;font-weight:bold">=</span> thresholds_nFeature[2],
  pct_mito_min <span style="color:#000;font-weight:bold">=</span> thresholds_percent_MT[1],
  pct_mito_max <span style="color:#000;font-weight:bold">=</span> thresholds_percent_MT[2]
)

seurat<span style="color:#000;font-weight:bold">@</span>misc<span style="color:#000;font-weight:bold">$</span>technical_info<span style="color:#000;font-weight:bold">$</span>cerebroApp_version <span style="color:#000;font-weight:bold">&lt;-</span> utils<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">packageVersion</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">cerebroApp&#39;</span>)
seurat<span style="color:#000;font-weight:bold">@</span>misc<span style="color:#000;font-weight:bold">$</span>technical_info<span style="color:#000;font-weight:bold">$</span>Seurat <span style="color:#000;font-weight:bold">&lt;-</span> utils<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">packageVersion</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">Seurat&#39;</span>)
seurat<span style="color:#000;font-weight:bold">@</span>misc<span style="color:#000;font-weight:bold">$</span>technical_info <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">list</span>(
  <span style="color:#d14">&#39;</span><span style="color:#d14">R&#39;</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">capture.output</span>(devtools<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">session_info</span>())
)
</code></pre></div><h3 id="calculate-relationship-trees">Calculate relationship trees</h3>
<p>Here, we calculate a relationship tree - just like the one we made before for the clusters - for all three grouping variables: samples, clusters, and cell types. Each of them is added to the <code>@misc</code> slot of the Seurat object so it can be extracted to Cerebro.</p>
<p>Samples:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-r" data-lang="r"><span style="color:#900;font-weight:bold">Idents</span>(seurat) <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#d14">&#34;</span><span style="color:#d14">sample&#34;</span>
seurat <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">BuildClusterTree</span>(
  seurat,
  dims <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">1</span><span style="color:#000;font-weight:bold">:</span><span style="color:#099">15</span>,
  reorder <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">FALSE</span>,
  reorder.numeric <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">FALSE</span>
)
seurat<span style="color:#000;font-weight:bold">@</span>misc<span style="color:#000;font-weight:bold">$</span>trees<span style="color:#000;font-weight:bold">$</span>sample <span style="color:#000;font-weight:bold">&lt;-</span> seurat<span style="color:#000;font-weight:bold">@</span>tools<span style="color:#000;font-weight:bold">$</span>BuildClusterTree
</code></pre></div><p>Clusters:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-r" data-lang="r"><span style="color:#900;font-weight:bold">Idents</span>(seurat) <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#d14">&#34;</span><span style="color:#d14">seurat_clusters&#34;</span>
seurat <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">BuildClusterTree</span>(
  seurat,
  dims <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">1</span><span style="color:#000;font-weight:bold">:</span><span style="color:#099">15</span>,
  reorder <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">FALSE</span>,
  reorder.numeric <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">FALSE</span>
)
seurat<span style="color:#000;font-weight:bold">@</span>misc<span style="color:#000;font-weight:bold">$</span>trees<span style="color:#000;font-weight:bold">$</span>seurat_clusters <span style="color:#000;font-weight:bold">&lt;-</span> seurat<span style="color:#000;font-weight:bold">@</span>tools<span style="color:#000;font-weight:bold">$</span>BuildClusterTree
</code></pre></div><p>Cell types:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-r" data-lang="r"><span style="color:#900;font-weight:bold">Idents</span>(seurat) <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#d14">&#34;</span><span style="color:#d14">cell_type_singler_blueprintencode_main&#34;</span>
seurat <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">BuildClusterTree</span>(
  seurat,
  dims <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">1</span><span style="color:#000;font-weight:bold">:</span><span style="color:#099">15</span>,
  reorder <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">FALSE</span>,
  reorder.numeric <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">FALSE</span>
)
seurat<span style="color:#000;font-weight:bold">@</span>misc<span style="color:#000;font-weight:bold">$</span>trees<span style="color:#000;font-weight:bold">$</span>cell_type_singler_blueprintencode_main <span style="color:#000;font-weight:bold">&lt;-</span> seurat<span style="color:#000;font-weight:bold">@</span>tools<span style="color:#000;font-weight:bold">$</span>BuildClusterTree
</code></pre></div><h3 id="cerebroapp-steps">cerebroApp steps</h3>
<p>Here, we calculate the percentage of mitochondrial and ribosomal transcripts, get most expressed and marker genes, test for enriched pathways, and perform gene set enrichment analysis.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-r" data-lang="r">seurat <span style="color:#000;font-weight:bold">&lt;-</span> cerebroApp<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">addPercentMtRibo</span>(
  seurat,
  organism <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">hg&#39;</span>,
  gene_nomenclature <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">name&#39;</span>
)

seurat <span style="color:#000;font-weight:bold">&lt;-</span> cerebroApp<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">getMostExpressedGenes</span>(
  seurat,
  assay <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">RNA&#39;</span>,
  groups <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">c</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">sample&#39;</span>,<span style="color:#d14">&#39;</span><span style="color:#d14">seurat_clusters&#39;</span>,<span style="color:#d14">&#39;</span><span style="color:#d14">cell_type_singler_blueprintencode_main&#39;</span>)
)

seurat <span style="color:#000;font-weight:bold">&lt;-</span> cerebroApp<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">getMarkerGenes</span>(
  seurat,
  assay <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">RNA&#39;</span>,
  organism <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">hg&#39;</span>,
  groups <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">c</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">sample&#39;</span>,<span style="color:#d14">&#39;</span><span style="color:#d14">seurat_clusters&#39;</span>,<span style="color:#d14">&#39;</span><span style="color:#d14">cell_type_singler_blueprintencode_main&#39;</span>),
  name <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">cerebro_seurat&#39;</span>,
  only_pos <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">TRUE</span>
)

seurat <span style="color:#000;font-weight:bold">&lt;-</span> cerebroApp<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">getEnrichedPathways</span>(
  seurat,
  marker_genes_input <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">cerebro_seurat&#39;</span>,
  adj_p_cutoff <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0.01</span>,
  max_terms <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">100</span>
)

seurat <span style="color:#000;font-weight:bold">&lt;-</span> cerebroApp<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">performGeneSetEnrichmentAnalysis</span>(
  seurat,
  assay <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">RNA&#39;</span>,
  GMT_file <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">h.all.v7.2.symbols.gmt&#39;</span>,
  groups <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">c</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">sample&#39;</span>,<span style="color:#d14">&#39;</span><span style="color:#d14">seurat_clusters&#39;</span>,<span style="color:#d14">&#39;</span><span style="color:#d14">cell_type_singler_blueprintencode_main&#39;</span>),
  thresh_p_val <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0.05</span>,
  thresh_q_val <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0.1</span>,
  parallel.sz <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">1</span>,
  verbose <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">FALSE</span>
)
</code></pre></div><h3 id="export">Export</h3>
<p>Finally, we can export the data to a <code>.crb</code> file that can be loaded into Cerebro.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-r" data-lang="r">cerebroApp<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">exportFromSeurat</span>(
  seurat,
  assay <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">RNA&#39;</span>,
  slot <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">data&#39;</span>,
  experiment_name <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">bone_marrow_donor_cells&#39;</span>,
  file <span style="color:#000;font-weight:bold">=</span> glue<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">glue</span>(<span style="color:#d14">&#34;</span><span style="color:#d14">data/Cerebro_bone_marrow_donor_cells_{Sys.Date()}.crb&#34;</span>),
  organism <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">hg&#39;</span>,
  groups <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">c</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">sample&#39;</span>,<span style="color:#d14">&#39;</span><span style="color:#d14">seurat_clusters&#39;</span>,<span style="color:#d14">&#39;</span><span style="color:#d14">cell_type_singler_blueprintencode_main&#39;</span>),
  cell_cycle <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">c</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">cell_cycle_seurat&#39;</span>),
  nUMI <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">nCount_RNA&#39;</span>,
  nGene <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">nFeature_RNA&#39;</span>,
  add_all_meta_data <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">TRUE</span>
)
</code></pre></div><h2 id="expression-of-individual-genes">Expression of individual genes</h2>
<h3 id="violin-plot-single-gene">Violin plot (single gene)</h3>
<p>This seems very trivial, just take the log-normalized expression values and plot them, right?
I'd just like to mention three things.
Firstly, I find it useful to scale the violins by <code>width</code>, as opposed to <code>area</code>.
Secondly, I suggest trimming the violin to avoid the violin extending into the negative scale, which doesn't make sense since there aren't any negative expression values.
Thirdly, it might make sense to add a bit of noise to the data to avoid highlighting distinct values at the bottom end of the scale, e.g. <code>log(1)</code>, <code>log(2)</code>, etc.
This is done by default (there isn't even an option) when plotting expression values with Seurat.
In this case, the difference is quite subtle, as you can see below (erythrocytes and monocytes).</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-r" data-lang="r">p1 <span style="color:#000;font-weight:bold">&lt;-</span> seurat<span style="color:#000;font-weight:bold">@</span>meta.data <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">mutate</span>(expression <span style="color:#000;font-weight:bold">=</span> seurat<span style="color:#000;font-weight:bold">@</span>assays<span style="color:#000;font-weight:bold">$</span>SCT<span style="color:#000;font-weight:bold">@</span>data[<span style="color:#d14">&#39;</span><span style="color:#d14">CD69&#39;</span>,]) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">ggplot</span>(<span style="color:#900;font-weight:bold">aes</span>(x <span style="color:#000;font-weight:bold">=</span> cell_type_singler_blueprintencode_main, y <span style="color:#000;font-weight:bold">=</span> expression, fill <span style="color:#000;font-weight:bold">=</span> cell_type_singler_blueprintencode_main)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_violin</span>(draw_quantiles <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">c</span>(<span style="color:#099">0.5</span>), scale <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">width&#39;</span>, trim <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">TRUE</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme_bw</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_fill_manual</span>(values <span style="color:#000;font-weight:bold">=</span> custom_colors<span style="color:#000;font-weight:bold">$</span>discrete) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_x_discrete</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_y_continuous</span>(name <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Log-normalized expression&#39;</span>, labels <span style="color:#000;font-weight:bold">=</span> scales<span style="color:#000;font-weight:bold">::</span>comma) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">labs</span>(title <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;</span><span style="color:#d14">CD69 expression (without noise)&#34;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme</span>(
    axis.title.x <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    axis.text.x <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_text</span>(angle <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">45</span>, hjust <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">1</span>),
    panel.grid.major.x <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    panel.grid.minor.x <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    legend.position <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">none&#39;</span>
  )

p2 <span style="color:#000;font-weight:bold">&lt;-</span> seurat<span style="color:#000;font-weight:bold">@</span>meta.data <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">mutate</span>(
    expression <span style="color:#000;font-weight:bold">=</span> seurat<span style="color:#000;font-weight:bold">@</span>assays<span style="color:#000;font-weight:bold">$</span>SCT<span style="color:#000;font-weight:bold">@</span>data[<span style="color:#d14">&#39;</span><span style="color:#d14">CD69&#39;</span>,],
    expression <span style="color:#000;font-weight:bold">=</span> expression <span style="color:#000;font-weight:bold">+</span> <span style="color:#900;font-weight:bold">rnorm</span>(<span style="color:#900;font-weight:bold">nrow</span>(.))<span style="color:#000;font-weight:bold">/</span><span style="color:#099">200</span>
  ) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">ggplot</span>(<span style="color:#900;font-weight:bold">aes</span>(x <span style="color:#000;font-weight:bold">=</span> cell_type_singler_blueprintencode_main, y <span style="color:#000;font-weight:bold">=</span> expression, fill <span style="color:#000;font-weight:bold">=</span> cell_type_singler_blueprintencode_main)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_violin</span>(draw_quantiles <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">c</span>(<span style="color:#099">0.5</span>), scale <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">width&#39;</span>, trim <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">TRUE</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme_bw</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_fill_manual</span>(values <span style="color:#000;font-weight:bold">=</span> custom_colors<span style="color:#000;font-weight:bold">$</span>discrete) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_x_discrete</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_y_continuous</span>(name <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Log-normalized expression&#39;</span>, labels <span style="color:#000;font-weight:bold">=</span> scales<span style="color:#000;font-weight:bold">::</span>comma) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">labs</span>(title <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;</span><span style="color:#d14">CD69 expression (with noise)&#34;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme</span>(
    axis.title.x <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    axis.text.x <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_text</span>(angle <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">45</span>, hjust <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">1</span>),
    panel.grid.major.x <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    panel.grid.minor.x <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    legend.position <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">none&#39;</span>
  )

<span style="color:#900;font-weight:bold">ggsave</span>(
  <span style="color:#d14">&#39;</span><span style="color:#d14">plots/expression_CD69_violin_plot.png&#39;</span>,
  p1 <span style="color:#000;font-weight:bold">+</span> p2 <span style="color:#000;font-weight:bold">+</span> <span style="color:#900;font-weight:bold">plot_layout</span>(ncol <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">1</span>),
  height <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">6</span>, width <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">9</span>
)
</code></pre></div>
<figure >
  
    <a href="/images/projects/scrnaseq_workflow/expression_CD69_violin_plot.png" target="_blank">
      <img src="/images/projects/scrnaseq_workflow/expression_CD69_violin_plot.jpg"  style="width: 100%; max-width: 1000px" />
    </a>
  
  
</figure>


<h3 id="dot-plot-multiple-genes">Dot plot (multiple genes)</h3>
<p>Dot plots can be a useful method to show the expression of multiple genes by a certain grouping variable.
As an example, we will use the marker genes that we detected for cell types and clusters.</p>
<h4 id="by-cell-type">By cell type</h4>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-r" data-lang="r"><span style="color:#998;font-style:italic"># cells will be grouped by samples that they have been assigned to</span>
group_ids <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">unique</span>(seurat<span style="color:#000;font-weight:bold">@</span>meta.data<span style="color:#000;font-weight:bold">$</span>cell_type_singler_blueprintencode_main)

<span style="color:#998;font-style:italic"># select a set of genes for which we want to show expression</span>
genes_to_show <span style="color:#000;font-weight:bold">&lt;-</span> seurat<span style="color:#000;font-weight:bold">@</span>misc<span style="color:#000;font-weight:bold">$</span>marker_genes<span style="color:#000;font-weight:bold">$</span>cerebro_seurat<span style="color:#000;font-weight:bold">$</span>cell_type_singler_blueprintencode_main <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">group_by</span>(cell_type_singler_blueprintencode_main) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">arrange</span>(p_val_adj) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">filter</span>(<span style="color:#900;font-weight:bold">row_number</span>() <span style="color:#000;font-weight:bold">==</span> <span style="color:#099">1</span>) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">arrange</span>(cell_type_singler_blueprintencode_main) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">pull</span>(gene)

<span style="color:#998;font-style:italic"># for every sample-gene combination, calculate the average expression across</span>
<span style="color:#998;font-style:italic"># all cells and then transform the data into a data frame</span>
expression_levels_per_group <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">vapply</span>(
    group_ids, FUN.VALUE <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">numeric</span>(<span style="color:#900;font-weight:bold">length</span>(genes_to_show)), <span style="color:#900;font-weight:bold">function</span>(x) {
      cells_in_current_group <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">which</span>(seurat<span style="color:#000;font-weight:bold">@</span>meta.data<span style="color:#000;font-weight:bold">$</span>cell_type_singler_blueprintencode_main <span style="color:#000;font-weight:bold">==</span> x)
      Matrix<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">rowMeans</span>(seurat<span style="color:#000;font-weight:bold">@</span>assays<span style="color:#000;font-weight:bold">$</span>SCT<span style="color:#000;font-weight:bold">@</span>data[genes_to_show,cells_in_current_group])
    }
  ) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">t</span>() <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">as.data.frame</span>() <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">mutate</span>(cell_type_singler_blueprintencode_main <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">rownames</span>(.)) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">select</span>(cell_type_singler_blueprintencode_main, <span style="color:#900;font-weight:bold">everything</span>()) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">pivot_longer</span>(
    cols <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">c</span>(<span style="color:#099">2</span><span style="color:#000;font-weight:bold">:</span><span style="color:#900;font-weight:bold">ncol</span>(.)),
    names_to <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">gene&#39;</span>
  ) <span style="color:#000;font-weight:bold">%&gt;%</span>
  dplyr<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">rename</span>(expression <span style="color:#000;font-weight:bold">=</span> value) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">mutate</span>(id_to_merge <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">paste0</span>(cell_type_singler_blueprintencode_main, <span style="color:#d14">&#39;</span><span style="color:#d14">_&#39;</span>, gene))

<span style="color:#998;font-style:italic"># for every sample-gene combination, calculate the percentage of cells in the</span>
<span style="color:#998;font-style:italic"># respective group that has at least 1 transcript (this means we consider it</span>
<span style="color:#998;font-style:italic"># as expressing the gene) and then transform the data into a data frame</span>
percentage_of_cells_expressing_gene <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">vapply</span>(
    group_ids, FUN.VALUE <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">numeric</span>(<span style="color:#900;font-weight:bold">length</span>(genes_to_show)), <span style="color:#900;font-weight:bold">function</span>(x) {
      cells_in_current_group <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">which</span>(seurat<span style="color:#000;font-weight:bold">@</span>meta.data<span style="color:#000;font-weight:bold">$</span>cell_type_singler_blueprintencode_main <span style="color:#000;font-weight:bold">==</span> x)
      Matrix<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">rowSums</span>(seurat<span style="color:#000;font-weight:bold">@</span>assays<span style="color:#000;font-weight:bold">$</span>SCT<span style="color:#000;font-weight:bold">@</span>data[genes_to_show,cells_in_current_group] <span style="color:#000;font-weight:bold">!=</span> <span style="color:#099">0</span>)
    }
  ) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">t</span>() <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">as.data.frame</span>() <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">mutate</span>(cell_type_singler_blueprintencode_main <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">rownames</span>(.)) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">select</span>(cell_type_singler_blueprintencode_main, <span style="color:#900;font-weight:bold">everything</span>()) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">pivot_longer</span>(
    cols <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">c</span>(<span style="color:#099">2</span><span style="color:#000;font-weight:bold">:</span><span style="color:#900;font-weight:bold">ncol</span>(.)),
    names_to <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">gene&#39;</span>
  ) <span style="color:#000;font-weight:bold">%&gt;%</span>
  dplyr<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">rename</span>(cell_count <span style="color:#000;font-weight:bold">=</span> value) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">left_join</span>(
    .,
    seurat<span style="color:#000;font-weight:bold">@</span>meta.data <span style="color:#000;font-weight:bold">%&gt;%</span>
      <span style="color:#900;font-weight:bold">group_by</span>(cell_type_singler_blueprintencode_main) <span style="color:#000;font-weight:bold">%&gt;%</span>
      <span style="color:#900;font-weight:bold">tally</span>(),
    by <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">cell_type_singler_blueprintencode_main&#39;</span>) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">mutate</span>(
    id_to_merge <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">paste0</span>(cell_type_singler_blueprintencode_main, <span style="color:#d14">&#39;</span><span style="color:#d14">_&#39;</span>, gene),
    percent_cells <span style="color:#000;font-weight:bold">=</span> cell_count <span style="color:#000;font-weight:bold">/</span> n
  )

<span style="color:#998;font-style:italic"># merge the two data frames created before and plot the data</span>
p <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">left_join</span>(
    expression_levels_per_group,
    percentage_of_cells_expressing_gene <span style="color:#000;font-weight:bold">%&gt;%</span> <span style="color:#900;font-weight:bold">select</span>(id_to_merge, percent_cells),
    by <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">id_to_merge&#39;</span>
  ) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">mutate</span>(
    cell_type_singler_blueprintencode_main <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">factor</span>(cell_type_singler_blueprintencode_main, levels <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">rev</span>(group_ids)),
    gene <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">factor</span>(gene, levels <span style="color:#000;font-weight:bold">=</span> genes_to_show)
  ) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">arrange</span>(gene) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">ggplot</span>(<span style="color:#900;font-weight:bold">aes</span>(gene, cell_type_singler_blueprintencode_main)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_point</span>(<span style="color:#900;font-weight:bold">aes</span>(color <span style="color:#000;font-weight:bold">=</span> expression, size <span style="color:#000;font-weight:bold">=</span> percent_cells)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_color_distiller</span>(
    palette <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Reds&#39;</span>,
    direction <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">1</span>,
    name <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Log-normalised\nexpression&#39;</span>,
    guide <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">guide_colorbar</span>(frame.colour <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;</span><span style="color:#d14">black&#34;</span>, ticks.colour <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;</span><span style="color:#d14">black&#34;</span>)
  ) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_size</span>(name <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Percent\nof cells&#39;</span>, labels <span style="color:#000;font-weight:bold">=</span> scales<span style="color:#000;font-weight:bold">::</span>percent) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">labs</span>(y <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Cell type&#39;</span>, color <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Expression&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">coord_fixed</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme_bw</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme</span>(
    axis.title <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    axis.text.x <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_text</span>(angle <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">45</span>, hjust <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">1</span>)
  )

<span style="color:#900;font-weight:bold">ggsave</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">plots/marker_genes_by_cell_type_as_dot_plot.png&#39;</span>, p, height <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">5</span>, width <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">6</span>)
</code></pre></div>
<figure >
  
    <a href="/images/projects/scrnaseq_workflow/marker_genes_by_cell_type_as_dot_plot.png" target="_blank">
      <img src="/images/projects/scrnaseq_workflow/marker_genes_by_cell_type_as_dot_plot.jpg"  style="width: 100%; max-width: 1000px" />
    </a>
  
  
</figure>


<h4 id="by-cluster">By cluster</h4>
<p><strong>NOTE:</strong> No marker gene was identified for cluster 6.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-r" data-lang="r">group_ids <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">levels</span>(seurat<span style="color:#000;font-weight:bold">@</span>meta.data<span style="color:#000;font-weight:bold">$</span>seurat_clusters)

genes_to_show <span style="color:#000;font-weight:bold">&lt;-</span> seurat<span style="color:#000;font-weight:bold">@</span>misc<span style="color:#000;font-weight:bold">$</span>marker_genes<span style="color:#000;font-weight:bold">$</span>cerebro_seurat<span style="color:#000;font-weight:bold">$</span>seurat_clusters <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">group_by</span>(seurat_clusters) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">arrange</span>(p_val_adj) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">filter</span>(<span style="color:#900;font-weight:bold">row_number</span>() <span style="color:#000;font-weight:bold">==</span> <span style="color:#099">1</span>) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">arrange</span>(seurat_clusters) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">pull</span>(gene)

expression_levels_per_group <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">vapply</span>(
    group_ids, FUN.VALUE <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">numeric</span>(<span style="color:#900;font-weight:bold">length</span>(genes_to_show)), <span style="color:#900;font-weight:bold">function</span>(x) {
      cells_in_current_group <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">which</span>(seurat<span style="color:#000;font-weight:bold">@</span>meta.data<span style="color:#000;font-weight:bold">$</span>seurat_clusters <span style="color:#000;font-weight:bold">==</span> x)
      Matrix<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">rowMeans</span>(seurat<span style="color:#000;font-weight:bold">@</span>assays<span style="color:#000;font-weight:bold">$</span>SCT<span style="color:#000;font-weight:bold">@</span>data[genes_to_show,cells_in_current_group])
    }
  ) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">t</span>() <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">as.data.frame</span>() <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">mutate</span>(cluster <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">rownames</span>(.)) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">select</span>(cluster, <span style="color:#900;font-weight:bold">everything</span>()) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">pivot_longer</span>(
    cols <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">c</span>(<span style="color:#099">2</span><span style="color:#000;font-weight:bold">:</span><span style="color:#900;font-weight:bold">ncol</span>(.)),
    names_to <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">gene&#39;</span>
  ) <span style="color:#000;font-weight:bold">%&gt;%</span>
  dplyr<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">rename</span>(expression <span style="color:#000;font-weight:bold">=</span> value) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">mutate</span>(id_to_merge <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">paste0</span>(cluster, <span style="color:#d14">&#39;</span><span style="color:#d14">_&#39;</span>, gene))

percentage_of_cells_expressing_gene <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">vapply</span>(
    group_ids, FUN.VALUE <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">numeric</span>(<span style="color:#900;font-weight:bold">length</span>(genes_to_show)), <span style="color:#900;font-weight:bold">function</span>(x) {
      cells_in_current_group <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">which</span>(seurat<span style="color:#000;font-weight:bold">@</span>meta.data<span style="color:#000;font-weight:bold">$</span>seurat_cluster <span style="color:#000;font-weight:bold">==</span> x)
      Matrix<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">rowSums</span>(seurat<span style="color:#000;font-weight:bold">@</span>assays<span style="color:#000;font-weight:bold">$</span>SCT<span style="color:#000;font-weight:bold">@</span>data[genes_to_show,cells_in_current_group] <span style="color:#000;font-weight:bold">!=</span> <span style="color:#099">0</span>)
    }
  ) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">t</span>() <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">as.data.frame</span>() <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">mutate</span>(cluster <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">rownames</span>(.)) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">select</span>(cluster, <span style="color:#900;font-weight:bold">everything</span>()) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">pivot_longer</span>(
    cols <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">c</span>(<span style="color:#099">2</span><span style="color:#000;font-weight:bold">:</span><span style="color:#900;font-weight:bold">ncol</span>(.)),
    names_to <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">gene&#39;</span>
  ) <span style="color:#000;font-weight:bold">%&gt;%</span>
  dplyr<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">rename</span>(cell_count <span style="color:#000;font-weight:bold">=</span> value) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">left_join</span>(
    .,
    seurat<span style="color:#000;font-weight:bold">@</span>meta.data <span style="color:#000;font-weight:bold">%&gt;%</span>
      <span style="color:#900;font-weight:bold">group_by</span>(seurat_clusters) <span style="color:#000;font-weight:bold">%&gt;%</span>
      <span style="color:#900;font-weight:bold">tally</span>() <span style="color:#000;font-weight:bold">%&gt;%</span>
      dplyr<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">rename</span>(cluster <span style="color:#000;font-weight:bold">=</span> seurat_clusters),
    by <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">cluster&#39;</span>) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">mutate</span>(
    id_to_merge <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">paste0</span>(cluster, <span style="color:#d14">&#39;</span><span style="color:#d14">_&#39;</span>, gene),
    percent_cells <span style="color:#000;font-weight:bold">=</span> cell_count <span style="color:#000;font-weight:bold">/</span> n
  )

p <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">left_join</span>(
    expression_levels_per_group,
    percentage_of_cells_expressing_gene <span style="color:#000;font-weight:bold">%&gt;%</span> <span style="color:#900;font-weight:bold">select</span>(id_to_merge, percent_cells),
    by <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">id_to_merge&#39;</span>
  ) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">mutate</span>(
    cluster <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">factor</span>(cluster, levels <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">rev</span>(group_ids)),
    gene <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">factor</span>(gene, levels <span style="color:#000;font-weight:bold">=</span> genes_to_show)
  ) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">arrange</span>(gene) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">ggplot</span>(<span style="color:#900;font-weight:bold">aes</span>(gene, cluster)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_point</span>(<span style="color:#900;font-weight:bold">aes</span>(color <span style="color:#000;font-weight:bold">=</span> expression, size <span style="color:#000;font-weight:bold">=</span> percent_cells)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_color_distiller</span>(
    palette <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Reds&#39;</span>,
    direction <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">1</span>,
    name <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Log-normalised\nexpression&#39;</span>,
    guide <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">guide_colorbar</span>(frame.colour <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;</span><span style="color:#d14">black&#34;</span>, ticks.colour <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;</span><span style="color:#d14">black&#34;</span>)
  ) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_size</span>(name <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Percent\nof cells&#39;</span>, labels <span style="color:#000;font-weight:bold">=</span> scales<span style="color:#000;font-weight:bold">::</span>percent) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">labs</span>(y <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Cluster&#39;</span>, color <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Expression&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">coord_fixed</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme_bw</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme</span>(
    axis.title.x <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    axis.text.x <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_text</span>(angle <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">45</span>, hjust <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">1</span>)
  )

<span style="color:#900;font-weight:bold">ggsave</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">plots/marker_genes_by_cluster_as_dot_plot.png&#39;</span>, p, height <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">7</span>, width <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">8</span>)
</code></pre></div>
<figure >
  
    <a href="/images/projects/scrnaseq_workflow/marker_genes_by_cluster_as_dot_plot.png" target="_blank">
      <img src="/images/projects/scrnaseq_workflow/marker_genes_by_cluster_as_dot_plot.jpg"  style="width: 100%; max-width: 1000px" />
    </a>
  
  
</figure>


<h2 id="expression-of-gene-sets">Expression of gene sets</h2>
<p>Let's check the expression of the genes in the GO term &ldquo;B_CELL_ACTIVATION&rdquo; downloaded from the <a href="https://www.gsea-msigdb.org/gsea/msigdb/cards/GO_B_CELL_ACTIVATION.html">MSigDB</a> by cell type.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-r" data-lang="r"><span style="color:#900;font-weight:bold">library</span>(msigdbr)

gene_set <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">msigdbr</span>(species <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Homo sapiens&#39;</span>, category <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">C5&#39;</span>, subcategory <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">BP&#39;</span>) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">filter</span>(gs_name <span style="color:#000;font-weight:bold">==</span> <span style="color:#d14">&#39;</span><span style="color:#d14">GO_B_CELL_ACTIVATION&#39;</span>) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">pull</span>(gene_symbol) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">unique</span>()

gene_set_present <span style="color:#000;font-weight:bold">&lt;-</span> gene_set<span style="color:#900;font-weight:bold">[which</span>(gene_set <span style="color:#000;font-weight:bold">%in%</span> <span style="color:#900;font-weight:bold">rownames</span>(seurat<span style="color:#000;font-weight:bold">@</span>assays<span style="color:#000;font-weight:bold">$</span>SCT<span style="color:#000;font-weight:bold">@</span>data))]

<span style="color:#900;font-weight:bold">head</span>(gene_set_present)
<span style="color:#998;font-style:italic"># [1] &#34;ABL1&#34;    &#34;ADA&#34;     &#34;ADAM17&#34;  &#34;ADGRG3&#34;  &#34;AHR&#34;     &#34;AKAP17A&#34;</span>
</code></pre></div><h3 id="mean-log-expression">Mean log-expression</h3>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-r" data-lang="r">temp_labels <span style="color:#000;font-weight:bold">&lt;-</span> seurat<span style="color:#000;font-weight:bold">@</span>meta.data <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">group_by</span>(cell_type_singler_blueprintencode_main) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">tally</span>() <span style="color:#000;font-weight:bold">%&gt;%</span>
  dplyr<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">rename</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">cell_type&#39;</span> <span style="color:#000;font-weight:bold">=</span> cell_type_singler_blueprintencode_main)

p <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">tibble</span>(
  cell_type <span style="color:#000;font-weight:bold">=</span> seurat<span style="color:#000;font-weight:bold">@</span>meta.data<span style="color:#000;font-weight:bold">$</span>cell_type_singler_blueprintencode_main,
  mean_expression <span style="color:#000;font-weight:bold">=</span> Matrix<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">colMeans</span>(seurat<span style="color:#000;font-weight:bold">@</span>assays<span style="color:#000;font-weight:bold">$</span>SCT<span style="color:#000;font-weight:bold">@</span>data[gene_set_present,])
  ) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">ggplot</span>(<span style="color:#900;font-weight:bold">aes</span>(x <span style="color:#000;font-weight:bold">=</span> cell_type, y <span style="color:#000;font-weight:bold">=</span> mean_expression, fill <span style="color:#000;font-weight:bold">=</span> cell_type)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_violin</span>(draw_quantiles <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">c</span>(<span style="color:#099">0.5</span>), scale <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">area&#39;</span>, trim <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">FALSE</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_text</span>(
    data <span style="color:#000;font-weight:bold">=</span> temp_labels,
    <span style="color:#900;font-weight:bold">aes</span>(
      x <span style="color:#000;font-weight:bold">=</span> cell_type,
      y <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">Inf</span>,
      label <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">paste0</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">n = &#39;</span>, <span style="color:#900;font-weight:bold">format</span>(n, big.mark <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">,&#39;</span>, trim <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">TRUE</span>)),
      vjust <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">-1</span>
    ), 
    color <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">black&#39;</span>, size <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">2.8</span>
  ) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme_bw</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_fill_manual</span>(values <span style="color:#000;font-weight:bold">=</span> custom_colors<span style="color:#000;font-weight:bold">$</span>discrete) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_x_discrete</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_y_continuous</span>(name <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Mean log expression&#39;</span>, labels <span style="color:#000;font-weight:bold">=</span> scales<span style="color:#000;font-weight:bold">::</span>comma, expand <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">c</span>(<span style="color:#099">0.08</span>, <span style="color:#099">0</span>)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">labs</span>(title <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;</span><span style="color:#d14">GO term &#39;B_CELL_ACTIVATION&#39;&#34;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme</span>(
    axis.title.x <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    axis.text.x <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_text</span>(angle <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">45</span>, hjust <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">1</span>),
    panel.grid.major.x <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    panel.grid.minor.x <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    legend.position <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">none&#39;</span>
  )

<span style="color:#900;font-weight:bold">ggsave</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">plots/gene_set_expression_B_CELL_ACTIVATION_mean.png&#39;</span>, p, height <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">4</span>, width <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">7</span>)
</code></pre></div>
<figure >
  
    <a href="/images/projects/scrnaseq_workflow/gene_set_expression_B_CELL_ACTIVATION_mean.png" target="_blank">
      <img src="/images/projects/scrnaseq_workflow/gene_set_expression_B_CELL_ACTIVATION_mean.jpg"  style="width: 100%; max-width: 1000px" />
    </a>
  
  
</figure>


<h3 id="module-score">Module score</h3>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-r" data-lang="r">seurat <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">AddModuleScore</span>(
  seurat,
  features <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">list</span>(gene_set_present),
  name <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">GO_B_CELL_ACTIVATION&#39;</span>,
  assay <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">SCT&#39;</span>
)

temp_labels <span style="color:#000;font-weight:bold">&lt;-</span> seurat<span style="color:#000;font-weight:bold">@</span>meta.data <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">group_by</span>(cell_type_singler_blueprintencode_main) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">tally</span>()

p <span style="color:#000;font-weight:bold">&lt;-</span> seurat<span style="color:#000;font-weight:bold">@</span>meta.data <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">ggplot</span>(
    <span style="color:#900;font-weight:bold">aes</span>(
      x <span style="color:#000;font-weight:bold">=</span> cell_type_singler_blueprintencode_main,
      y <span style="color:#000;font-weight:bold">=</span> GO_B_CELL_ACTIVATION1,
      fill <span style="color:#000;font-weight:bold">=</span> cell_type_singler_blueprintencode_main
    )
  ) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_violin</span>(draw_quantiles <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">c</span>(<span style="color:#099">0.5</span>), scale <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">area&#39;</span>, trim <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">FALSE</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_text</span>(
    data <span style="color:#000;font-weight:bold">=</span> temp_labels,
    <span style="color:#900;font-weight:bold">aes</span>(
      x <span style="color:#000;font-weight:bold">=</span> cell_type_singler_blueprintencode_main,
      y <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#000;font-weight:bold">Inf</span>,
      label <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">paste0</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">n = &#39;</span>, <span style="color:#900;font-weight:bold">format</span>(n, big.mark <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">,&#39;</span>, trim <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">TRUE</span>)),
      vjust <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">-1</span>
    ),
    color <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">black&#39;</span>, size <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">2.8</span>
  ) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme_bw</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_fill_manual</span>(values <span style="color:#000;font-weight:bold">=</span> custom_colors<span style="color:#000;font-weight:bold">$</span>discrete) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_x_discrete</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_y_continuous</span>(name <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Module score&#39;</span>, labels <span style="color:#000;font-weight:bold">=</span> scales<span style="color:#000;font-weight:bold">::</span>comma, expand <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">c</span>(<span style="color:#099">0.08</span>, <span style="color:#099">0</span>)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">labs</span>(title <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;</span><span style="color:#d14">GO term &#39;B_CELL_ACTIVATION&#39;&#34;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme</span>(
    axis.title.x <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    axis.text.x <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_text</span>(angle <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">45</span>, hjust <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">1</span>),
    panel.grid.major.x <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    panel.grid.minor.x <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    legend.position <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">none&#39;</span>
  )

<span style="color:#900;font-weight:bold">ggsave</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">plots/gene_set_expression_B_CELL_ACTIVATION_module_score.png&#39;</span>, p, height <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">4</span>, width <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">7</span>)
</code></pre></div>
<figure >
  
    <a href="/images/projects/scrnaseq_workflow/gene_set_expression_B_CELL_ACTIVATION_module_score.png" target="_blank">
      <img src="/images/projects/scrnaseq_workflow/gene_set_expression_B_CELL_ACTIVATION_module_score.jpg"  style="width: 100%; max-width: 1000px" />
    </a>
  
  
</figure>


<h2 id="gene-set-enrichment-analysis">Gene set enrichment analysis</h2>
<h3 id="gsva">GSVA</h3>
<p>For illustrative reasons, we will use the <a href="https://www.gsea-msigdb.org/gsea/msigdb/index.jsp">50 hallmark gene sets from MSigDB</a> and compare monocytes to hematopoietic stem cells (HSC; control).</p>
<p>Thanks to <a href="https://twitter.com/Raveancic">Alessandro Raveane</a> for letting me start from his code.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-r" data-lang="r"><span style="color:#998;font-style:italic"># function to read GMT file</span>
read_GMT_file <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">function</span>(file) {
  gmt <span style="color:#000;font-weight:bold">&lt;-</span> readr<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">read_delim</span>(
    file,
    delim <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">;&#39;</span>,
    col_names <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">c</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">X1&#39;</span>),
    col_types <span style="color:#000;font-weight:bold">=</span> readr<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">cols</span>()
  )

  gene_set_genes <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">list</span>()
  <span style="color:#900;font-weight:bold">for </span>( i in <span style="color:#900;font-weight:bold">seq_len</span>(<span style="color:#900;font-weight:bold">nrow</span>(gmt)) )
  {
    temp_genes <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">strsplit</span>(gmt<span style="color:#000;font-weight:bold">$</span>X1[i], split <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">\t&#39;</span>)[[1]] <span style="color:#000;font-weight:bold">%&gt;%</span> <span style="color:#900;font-weight:bold">unlist</span>()
    temp_genes <span style="color:#000;font-weight:bold">&lt;-</span> temp_genes[3<span style="color:#000;font-weight:bold">:</span><span style="color:#900;font-weight:bold">length</span>(temp_genes)]
    gene_set_genes[[i]] <span style="color:#000;font-weight:bold">&lt;-</span> temp_genes
  }
  gene_set_loaded <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">list</span>(
    genesets <span style="color:#000;font-weight:bold">=</span> gene_set_genes,
    geneset.names <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">lapply</span>(<span style="color:#900;font-weight:bold">strsplit</span>(gmt<span style="color:#000;font-weight:bold">$</span>X1, split <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">\t&#39;</span>), <span style="color:#d14">&#39;</span><span style="color:#d14">[&#39;</span>, <span style="color:#099">1</span>) <span style="color:#000;font-weight:bold">%&gt;%</span> <span style="color:#900;font-weight:bold">unlist</span>(),
    geneset.description <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">lapply</span>(
        <span style="color:#900;font-weight:bold">strsplit</span>(gmt<span style="color:#000;font-weight:bold">$</span>X1, split <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">\t&#39;</span>), <span style="color:#d14">&#39;</span><span style="color:#d14">[&#39;</span>, <span style="color:#099">2</span>
      ) <span style="color:#000;font-weight:bold">%&gt;%</span> <span style="color:#900;font-weight:bold">unlist</span>()
  )

  <span style="color:#900;font-weight:bold">return</span>(gene_set_loaded)
}

<span style="color:#998;font-style:italic"># load gene sets from GMT file</span>
gene_sets <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">read_GMT_file</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">h.all.v7.2.symbols.gmt&#39;</span>)

<span style="color:#998;font-style:italic"># set gene set names</span>
<span style="color:#900;font-weight:bold">names</span>(gene_sets<span style="color:#000;font-weight:bold">$</span>genesets) <span style="color:#000;font-weight:bold">&lt;-</span> gene_sets<span style="color:#000;font-weight:bold">$</span>geneset.names

<span style="color:#998;font-style:italic"># get indices of cells which are either HSC or monocytes</span>
cells_to_analyze <span style="color:#000;font-weight:bold">&lt;-</span> seurat<span style="color:#000;font-weight:bold">@</span>meta.data <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">mutate</span>(row_number <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">row_number</span>()) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">filter</span>(<span style="color:#900;font-weight:bold">grepl</span>(cell_type_singler_blueprintencode_main, pattern <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">HSC|Monocytes&#39;</span>)) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">arrange</span>(cell_type_singler_blueprintencode_main) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">pull</span>(row_number)

<span style="color:#998;font-style:italic"># get list of genes unique genes across all gene sets</span>
genes_to_analyze <span style="color:#000;font-weight:bold">&lt;-</span> gene_sets<span style="color:#000;font-weight:bold">$</span>genesets <span style="color:#000;font-weight:bold">%&gt;%</span> <span style="color:#900;font-weight:bold">unlist</span>() <span style="color:#000;font-weight:bold">%&gt;%</span> <span style="color:#900;font-weight:bold">unique</span>()
<span style="color:#998;font-style:italic"># filter gene list for those which are present in the data set</span>
genes_to_analyze <span style="color:#000;font-weight:bold">&lt;-</span> genes_to_analyze<span style="color:#900;font-weight:bold">[which</span>(genes_to_analyze <span style="color:#000;font-weight:bold">%in%</span> <span style="color:#900;font-weight:bold">rownames</span>(seurat<span style="color:#000;font-weight:bold">@</span>assays<span style="color:#000;font-weight:bold">$</span>SCT<span style="color:#000;font-weight:bold">@</span>counts))]

<span style="color:#998;font-style:italic"># get expression matrix and reduce it to cells and genes of interest</span>
expression_matrix <span style="color:#000;font-weight:bold">&lt;-</span> seurat<span style="color:#000;font-weight:bold">@</span>assays<span style="color:#000;font-weight:bold">$</span>SCT<span style="color:#000;font-weight:bold">@</span>counts[ genes_to_analyze , cells_to_analyze] <span style="color:#000;font-weight:bold">%&gt;%</span> <span style="color:#900;font-weight:bold">as.matrix</span>()

<span style="color:#998;font-style:italic"># perform GSVA</span>
gsva <span style="color:#000;font-weight:bold">&lt;-</span> GSVA<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">gsva</span>(
  expression_matrix,
  gset.idx.list <span style="color:#000;font-weight:bold">=</span> gene_sets<span style="color:#000;font-weight:bold">$</span>genesets,
  parallel.sz <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">1</span>
)

<span style="color:#998;font-style:italic"># load limma library for statistical testing</span>
<span style="color:#900;font-weight:bold">library</span>(limma)

<span style="color:#998;font-style:italic"># generate design matrix</span>
design_matrix <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">tibble</span>(
  control <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">1</span>,
  test <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">c</span>(
    <span style="color:#900;font-weight:bold">rep</span>(<span style="color:#099">0</span>, seurat<span style="color:#000;font-weight:bold">@</span>meta.data <span style="color:#000;font-weight:bold">%&gt;%</span> <span style="color:#900;font-weight:bold">filter</span>(cell_type_singler_blueprintencode_main <span style="color:#000;font-weight:bold">==</span> <span style="color:#d14">&#39;</span><span style="color:#d14">HSC&#39;</span>) <span style="color:#000;font-weight:bold">%&gt;%</span> <span style="color:#900;font-weight:bold">nrow</span>()),
    <span style="color:#900;font-weight:bold">rep</span>(<span style="color:#099">1</span>, seurat<span style="color:#000;font-weight:bold">@</span>meta.data <span style="color:#000;font-weight:bold">%&gt;%</span> <span style="color:#900;font-weight:bold">filter</span>(cell_type_singler_blueprintencode_main <span style="color:#000;font-weight:bold">==</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Monocytes&#39;</span>) <span style="color:#000;font-weight:bold">%&gt;%</span> <span style="color:#900;font-weight:bold">nrow</span>())
  )
)

<span style="color:#900;font-weight:bold">head</span>(design_matrix)
<span style="color:#998;font-style:italic"># A tibble: 6 x 2</span>
<span style="color:#998;font-style:italic">#   control  test</span>
<span style="color:#998;font-style:italic">#     &lt;dbl&gt; &lt;dbl&gt;</span>
<span style="color:#998;font-style:italic"># 1       1     0</span>
<span style="color:#998;font-style:italic"># 2       1     0</span>
<span style="color:#998;font-style:italic"># 3       1     0</span>
<span style="color:#998;font-style:italic"># 4       1     0</span>
<span style="color:#998;font-style:italic"># 5       1     0</span>
<span style="color:#998;font-style:italic"># 6       1     0</span>

<span style="color:#998;font-style:italic"># fit linear model, followed by empirical Bayes statistics for differential</span>
<span style="color:#998;font-style:italic"># enrichment analysis</span>
fit <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">lmFit</span>(gsva, design_matrix)
fit <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">eBayes</span>(fit)

<span style="color:#998;font-style:italic"># prepare data for plotting</span>
data <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">topTable</span>(fit, coef <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">test&#39;</span>, number <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">50</span>) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">mutate</span>(gene_set <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">rownames</span>(fit<span style="color:#000;font-weight:bold">$</span>t)) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">arrange</span>(t) <span style="color:#000;font-weight:bold">%&gt;%</span>
  <span style="color:#900;font-weight:bold">mutate</span>(
    gene_set <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">factor</span>(gene_set, levels <span style="color:#000;font-weight:bold">=</span> gene_set),
    just <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">ifelse</span>(t <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#099">0</span>, <span style="color:#099">0</span>, <span style="color:#099">1</span>),
    nudge_y <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">ifelse</span>(t <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#099">0</span>, <span style="color:#099">1</span>, <span style="color:#099">-1</span>),
    color <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">ifelse</span>(t <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#099">-5</span> <span style="color:#000;font-weight:bold">|</span> t <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#099">5</span>, <span style="color:#d14">&#39;</span><span style="color:#d14">black&#39;</span>, <span style="color:#d14">&#39;</span><span style="color:#d14">grey&#39;</span>)
  )

<span style="color:#900;font-weight:bold">DataFrame</span>(data)
<span style="color:#998;font-style:italic"># DataFrame with 50 rows and 10 columns</span>
<span style="color:#998;font-style:italic">#         logFC     AveExpr         t      P.Value    adj.P.Val         B                            gene_set      just   nudge_y       color</span>
<span style="color:#998;font-style:italic">#     &lt;numeric&gt;   &lt;numeric&gt; &lt;numeric&gt;    &lt;numeric&gt;    &lt;numeric&gt; &lt;numeric&gt;                            &lt;factor&gt; &lt;numeric&gt; &lt;numeric&gt; &lt;character&gt;</span>
<span style="color:#998;font-style:italic"># 1   -0.369443  -0.1569690  -35.1619 1.26066e-186 1.05055e-185   415.980  HALLMARK_TGF_BETA_SIGNALING                0         1       black</span>
<span style="color:#998;font-style:italic"># 2   -0.251413  -0.0820012  -27.2261 1.96152e-127 8.91598e-127   279.761  HALLMARK_NOTCH_SIGNALING                   0         1       black</span>
<span style="color:#998;font-style:italic"># 3   -0.288169  -0.1202293  -26.1464 1.40712e-119 5.41201e-119   261.689  HALLMARK_ESTROGEN_RESPONSE_EARLY           0         1       black</span>
<span style="color:#998;font-style:italic"># 4   -0.135034  -0.1511146  -22.3565  8.50194e-93  2.36165e-92   200.094  HALLMARK_INTERFERON_ALPHA_RESPONSE         0         1       black</span>
<span style="color:#998;font-style:italic"># 5   -0.203651  -0.1049498  -22.0728  7.44006e-91  1.95791e-90   195.628  HALLMARK_INTERFERON_GAMMA_RESPONSE         0         1       black</span>
<span style="color:#998;font-style:italic"># ...       ...         ...       ...          ...          ...       ...                                 ...       ...       ...         ...</span>
<span style="color:#998;font-style:italic"># 46   0.200259  0.25341594   35.9250 2.31901e-192 2.31901e-191   429.182 HALLMARK_WNT_BETA_CATENIN_SIGNALING         1        -1       black</span>
<span style="color:#998;font-style:italic"># 47   0.293113 -0.08115610   36.1995 2.00784e-194 2.50980e-193   433.929 HALLMARK_MITOTIC_SPINDLE                    1        -1       black</span>
<span style="color:#998;font-style:italic"># 48   0.338449  0.11583774   36.2560 7.56196e-195 1.26033e-193   434.906 HALLMARK_CHOLESTEROL_HOMEOSTASIS            1        -1       black</span>
<span style="color:#998;font-style:italic"># 49   0.251678  0.00262136   37.5117 2.86772e-204 7.16930e-203   456.592 HALLMARK_HYPOXIA                            1        -1       black</span>
<span style="color:#998;font-style:italic"># 50   0.282907 -0.05021404   48.5971 1.72523e-285 8.62616e-284   643.571 HALLMARK_TNFA_SIGNALING_VIA_NFKB            1        -1       black</span>

<span style="color:#998;font-style:italic"># plot t-value</span>
p <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">ggplot</span>(data <span style="color:#000;font-weight:bold">=</span> data, <span style="color:#900;font-weight:bold">aes</span>(x <span style="color:#000;font-weight:bold">=</span> gene_set, y <span style="color:#000;font-weight:bold">=</span> t, fill <span style="color:#000;font-weight:bold">=</span> t)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_col</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_hline</span>(yintercept <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">c</span>(<span style="color:#099">-5</span>,<span style="color:#099">5</span>), linetype <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">dashed&#39;</span>, color <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">grey80&#39;</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">geom_text</span>(
    <span style="color:#900;font-weight:bold">aes</span>(
      x <span style="color:#000;font-weight:bold">=</span> gene_set,
      y <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>,
      label <span style="color:#000;font-weight:bold">=</span> gene_set,
      hjust <span style="color:#000;font-weight:bold">=</span> just,
      color <span style="color:#000;font-weight:bold">=</span> color
    ),
    nudge_y <span style="color:#000;font-weight:bold">=</span> data<span style="color:#000;font-weight:bold">$</span>nudge_y, size <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">3</span>
  ) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_x_discrete</span>(name <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">&#39;</span>, labels <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">NULL</span>) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_y_continuous</span>(name <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">t-value&#39;</span>, limits <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">c</span>(<span style="color:#099">-55</span>,<span style="color:#099">55</span>)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_fill_distiller</span>(palette <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">Spectral&#39;</span>, limits <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">c</span>(<span style="color:#000;font-weight:bold">-</span><span style="color:#900;font-weight:bold">max</span>(data<span style="color:#000;font-weight:bold">$</span>t), <span style="color:#900;font-weight:bold">max</span>(data<span style="color:#000;font-weight:bold">$</span>t))) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">scale_color_manual</span>(values <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">c</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">black&#39;</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">black&#39;</span>, <span style="color:#d14">&#39;</span><span style="color:#d14">grey&#39;</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">grey&#39;</span>)) <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">coord_flip</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme_bw</span>() <span style="color:#000;font-weight:bold">+</span>
  <span style="color:#900;font-weight:bold">theme</span>(
    panel.grid <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">element_blank</span>(),
    axis.ticks.y <span style="color:#000;font-weight:bold">=</span>  <span style="color:#900;font-weight:bold">element_blank</span>(),
    legend.position <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;</span><span style="color:#d14">none&#39;</span>
  )

<span style="color:#900;font-weight:bold">ggsave</span>(<span style="color:#d14">&#39;</span><span style="color:#d14">plots/GSVA_hallmark_gene_sets_monocytes_vs_HSC.png&#39;</span>, height <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">7.5</span>, width <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">7.5</span>)
</code></pre></div>
<figure >
  
    <a href="/images/projects/scrnaseq_workflow/GSVA_hallmark_gene_sets_monocytes_vs_HSC.png" target="_blank">
      <img src="/images/projects/scrnaseq_workflow/GSVA_hallmark_gene_sets_monocytes_vs_HSC.jpg"  style="width: 100%; max-width: 1000px" />
    </a>
  
  
</figure>


<h2 id="store-data">Store data</h2>
<p>Finally, we store our Seurat object so we can continue the analysis later.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-r" data-lang="r"><span style="color:#900;font-weight:bold">saveRDS</span>(seurat, <span style="color:#d14">&#39;</span><span style="color:#d14">data/seurat.rds&#39;</span>)
</code></pre></div><h2 id="session-info">Session info</h2>
<p>Here we report information about the version of R and R packages we used.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-r" data-lang="r"><span style="color:#998;font-style:italic"># devtools::session_info()</span>
<span style="color:#998;font-style:italic">#  Session info </span>
<span style="color:#998;font-style:italic">#  setting  value</span>
<span style="color:#998;font-style:italic">#  version  R version 4.0.2 Patched (2020-08-19 r79057)</span>
<span style="color:#998;font-style:italic">#  os       macOS Catalina 10.15.7</span>
<span style="color:#998;font-style:italic">#  system   x86_64, darwin17.0</span>
<span style="color:#998;font-style:italic">#  ui       X11</span>
<span style="color:#998;font-style:italic">#  language (EN)</span>
<span style="color:#998;font-style:italic">#  collate  en_US.UTF-8</span>
<span style="color:#998;font-style:italic">#  ctype    en_US.UTF-8</span>
<span style="color:#998;font-style:italic">#  tz       Europe/Amsterdam</span>
<span style="color:#998;font-style:italic">#  date     2020-10-07</span>
<span style="color:#998;font-style:italic"># </span>
<span style="color:#998;font-style:italic">#  Packages </span>
<span style="color:#998;font-style:italic">#  package                * version  date       lib source</span>
<span style="color:#998;font-style:italic">#  abind                    1.4-5    2016-07-21 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  annotate                 1.66.0   2020-04-28 [1] Bioconductor</span>
<span style="color:#998;font-style:italic">#  AnnotationDbi            1.50.3   2020-07-25 [1] Bioconductor</span>
<span style="color:#998;font-style:italic">#  AnnotationHub            2.20.2   2020-08-18 [1] Bioconductor</span>
<span style="color:#998;font-style:italic">#  ape                      5.4-1    2020-08-13 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  aplot                    0.0.6    2020-09-03 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  askpass                  1.1      2019-01-13 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  assertthat               0.2.1    2019-03-21 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  backports                1.1.9    2020-08-24 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  beeswarm                 0.2.3    2016-04-25 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  Biobase                * 2.48.0   2020-04-27 [1] Bioconductor</span>
<span style="color:#998;font-style:italic">#  BiocFileCache            1.12.1   2020-08-04 [1] Bioconductor</span>
<span style="color:#998;font-style:italic">#  BiocGenerics           * 0.34.0   2020-04-27 [1] Bioconductor</span>
<span style="color:#998;font-style:italic">#  BiocManager              1.30.10  2019-11-16 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  BiocNeighbors            1.6.0    2020-04-27 [1] Bioconductor</span>
<span style="color:#998;font-style:italic">#  BiocParallel             1.22.0   2020-04-27 [1] Bioconductor</span>
<span style="color:#998;font-style:italic">#  BiocSingular             1.4.0    2020-04-27 [1] Bioconductor</span>
<span style="color:#998;font-style:italic">#  BiocVersion              3.11.1   2020-04-07 [1] Bioconductor</span>
<span style="color:#998;font-style:italic">#  biomaRt                  2.44.1   2020-06-17 [1] Bioconductor</span>
<span style="color:#998;font-style:italic">#  bit                      4.0.4    2020-08-04 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  bit64                    4.0.2    2020-07-30 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  bitops                   1.0-6    2013-08-17 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  blob                     1.2.1    2020-01-20 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  broom                    0.7.0    2020-07-09 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  callr                    3.4.3    2020-03-28 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  cellranger               1.1.0    2016-07-27 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  cerebroApp               1.3.0    2020-10-07 [1] Github (romanhaa/cerebroApp@7fb55f0)</span>
<span style="color:#998;font-style:italic">#  cli                      2.0.2    2020-02-28 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  cluster                * 2.1.0    2019-06-19 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  coda                     0.19-4   2020-09-30 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  codetools                0.2-16   2018-12-24 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  colorspace               1.4-1    2019-03-18 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  colourpicker             1.0      2017-09-27 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  cowplot                  1.0.0    2019-07-11 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  crayon                   1.3.4    2017-09-16 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  crosstalk                1.1.0.1  2020-03-13 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  curl                     4.3      2019-12-02 [1] CRAN (R 4.0.1)</span>
<span style="color:#998;font-style:italic">#  data.table               1.13.0   2020-07-24 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  DBI                      1.1.0    2019-12-15 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  dbplyr                   1.4.4    2020-05-27 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  DelayedArray           * 0.14.1   2020-07-14 [1] Bioconductor</span>
<span style="color:#998;font-style:italic">#  DelayedMatrixStats       1.10.1   2020-07-03 [1] Bioconductor</span>
<span style="color:#998;font-style:italic">#  deldir                   0.1-28   2020-07-15 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  desc                     1.2.0    2018-05-01 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  devtools                 2.3.1    2020-07-21 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  digest                   0.6.25   2020-02-23 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  dplyr                  * 1.0.2    2020-08-18 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  dqrng                    0.2.1    2019-05-17 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  DT                       0.15     2020-08-05 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  edgeR                    3.30.3   2020-06-02 [1] Bioconductor</span>
<span style="color:#998;font-style:italic">#  ellipsis                 0.3.1    2020-05-15 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  ExperimentHub            1.14.2   2020-08-18 [1] Bioconductor</span>
<span style="color:#998;font-style:italic">#  fansi                    0.4.1    2020-01-08 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  farver                   2.0.3    2020-01-16 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  fastmap                  1.0.1    2019-10-08 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  fastmatch                1.1-0    2017-01-28 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  fitdistrplus             1.1-1    2020-05-19 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  forcats                * 0.5.0    2020-03-01 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  fs                       1.5.0    2020-07-31 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  future                   1.18.0   2020-07-09 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  future.apply             1.6.0    2020-07-01 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  generics                 0.0.2    2018-11-29 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  GenomeInfoDb           * 1.24.2   2020-06-15 [1] Bioconductor</span>
<span style="color:#998;font-style:italic">#  GenomeInfoDbData         1.2.3    2020-08-26 [1] Bioconductor</span>
<span style="color:#998;font-style:italic">#  GenomicRanges          * 1.40.0   2020-04-27 [1] Bioconductor</span>
<span style="color:#998;font-style:italic">#  ggbeeswarm               0.6.0    2017-08-07 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  ggforce                * 0.3.2    2020-06-23 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  gghalves               * 0.1.0    2020-03-28 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  ggnetwork              * 0.5.8    2020-02-12 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  ggplot2                * 3.3.2    2020-06-19 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  ggrepel                  0.8.2    2020-03-08 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  ggridges               * 0.5.2    2020-01-12 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  ggtree                   2.2.4    2020-07-28 [1] Bioconductor</span>
<span style="color:#998;font-style:italic">#  globals                  0.12.5   2019-12-07 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  glue                     1.4.2    2020-08-27 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  goftest                  1.2-2    2019-12-02 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  graph                    1.66.0   2020-04-27 [1] Bioconductor</span>
<span style="color:#998;font-style:italic">#  gridExtra                2.3      2017-09-09 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  GSEABase                 1.50.1   2020-05-29 [1] Bioconductor</span>
<span style="color:#998;font-style:italic">#  GSVA                     1.36.2   2020-06-17 [1] Bioconductor</span>
<span style="color:#998;font-style:italic">#  gtable                   0.3.0    2019-03-25 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  haven                    2.3.1    2020-06-01 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  highr                    0.8      2019-03-20 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  hms                      0.5.3    2020-01-08 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  htmltools                0.5.0    2020-06-16 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  htmlwidgets              1.5.1    2019-10-08 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  httpuv                   1.5.4    2020-06-06 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  httr                     1.4.2    2020-07-20 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  ica                      1.0-2    2018-05-24 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  igraph                   1.2.5    2020-03-19 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  interactiveDisplayBase   1.26.3   2020-06-02 [1] Bioconductor</span>
<span style="color:#998;font-style:italic">#  intrinsicDimension       1.2.0    2019-06-07 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  IRanges                * 2.22.2   2020-05-21 [1] Bioconductor</span>
<span style="color:#998;font-style:italic">#  irlba                    2.3.3    2019-02-05 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  jsonlite                 1.7.0    2020-06-25 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  KernSmooth               2.23-17  2020-04-26 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  knitr                    1.29     2020-06-23 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  labeling                 0.3      2014-08-23 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  later                    1.1.0.1  2020-06-05 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  lattice                  0.20-41  2020-04-02 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  lazyeval                 0.2.2    2019-03-15 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  leiden                   0.3.3    2020-02-04 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  lifecycle                0.2.0    2020-03-06 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  limma                  * 3.44.3   2020-06-12 [1] Bioconductor</span>
<span style="color:#998;font-style:italic">#  listenv                  0.8.0    2019-12-05 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  lmtest                   0.9-37   2019-04-30 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  locfit                   1.5-9.4  2020-03-25 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  lubridate                1.7.9    2020-06-08 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  magrittr                 1.5      2014-11-22 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  MASS                     7.3-52   2020-08-18 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  Matrix                   1.2-18   2019-11-27 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  matrixStats            * 0.56.0   2020-03-13 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  memoise                  1.1.0    2017-04-21 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  mgcv                     1.8-32   2020-08-19 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  mime                     0.9      2020-02-04 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  miniUI                   0.1.1.1  2018-05-18 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  modelr                   0.1.8    2020-05-19 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  msigdbr                * 7.1.1    2020-05-14 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  munsell                  0.5.0    2018-06-12 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  network                  1.16.0   2019-12-01 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  nlme                     3.1-149  2020-08-23 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  openssl                  1.4.3    2020-09-18 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  patchwork              * 1.0.1    2020-06-22 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  pbapply                  1.4-3    2020-08-18 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  pheatmap                 1.0.12   2019-01-04 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  pillar                   1.4.6    2020-07-10 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  pkgbuild                 1.1.0    2020-07-13 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  pkgconfig                2.0.3    2019-09-22 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  pkgload                  1.1.0    2020-05-29 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  plotly                   4.9.2.1  2020-04-04 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  plyr                     1.8.6    2020-03-03 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  png                      0.1-7    2013-12-03 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  polyclip                 1.10-0   2019-03-14 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  prettyunits              1.1.1    2020-01-24 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  processx                 3.4.3    2020-07-05 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  progress                 1.2.2    2019-05-16 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  promises                 1.1.1    2020-06-09 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  ps                       1.3.4    2020-08-11 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  purrr                  * 0.3.4    2020-04-17 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  qvalue                   2.20.0   2020-04-27 [1] Bioconductor</span>
<span style="color:#998;font-style:italic">#  R6                       2.4.1    2019-11-12 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  randomForest             4.6-14   2018-03-25 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  RANN                     2.6.1    2019-01-08 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  rappdirs                 0.3.1    2016-03-28 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  RColorBrewer             1.1-2    2014-12-07 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  Rcpp                     1.0.5    2020-07-06 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  RcppAnnoy                0.0.16   2020-03-08 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  RCurl                    1.98-1.2 2020-04-18 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  readr                  * 1.3.1    2018-12-21 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  readxl                   1.3.1    2019-03-13 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  remotes                  2.2.0    2020-07-21 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  reprex                   0.3.0    2019-05-16 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  reshape2                 1.4.4    2020-04-09 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  reticulate               1.16     2020-05-27 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  rlang                    0.4.7    2020-07-09 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  rle                      0.9.2    2020-09-25 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  ROCR                     1.0-11   2020-05-02 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  rpart                    4.1-15   2019-04-12 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  rprojroot                1.3-2    2018-01-03 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  RSpectra                 0.16-0   2019-12-01 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  RSQLite                  2.2.0    2020-01-07 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  rstudioapi               0.11     2020-02-07 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  rsvd                     1.0.3    2020-02-17 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  Rtsne                    0.15     2018-11-10 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  rvcheck                  0.1.8    2020-03-01 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  rvest                    0.3.6    2020-07-25 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  S4Vectors              * 0.26.1   2020-05-16 [1] Bioconductor</span>
<span style="color:#998;font-style:italic">#  scales                   1.1.1    2020-05-11 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  scater                   1.16.2   2020-06-26 [1] Bioconductor</span>
<span style="color:#998;font-style:italic">#  scDblFinder            * 1.2.0    2020-04-27 [1] Bioconductor</span>
<span style="color:#998;font-style:italic">#  scran                  * 1.16.0   2020-04-27 [1] Bioconductor</span>
<span style="color:#998;font-style:italic">#  sctransform              0.2.1    2019-12-17 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  sessioninfo              1.1.1    2018-11-05 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  Seurat                 * 3.2.0    2020-07-16 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  shiny                  * 1.5.0    2020-06-23 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  shinycssloaders          1.0.0    2020-07-28 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  shinydashboard           0.7.1    2018-10-17 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  shinyFiles               0.8.0    2020-04-14 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  shinyjs                  1.1      2020-01-13 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  shinythemes              1.1.2    2018-11-06 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  shinyWidgets             0.5.3    2020-06-01 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  SingleCellExperiment   * 1.10.1   2020-04-28 [1] Bioconductor</span>
<span style="color:#998;font-style:italic">#  SingleR                * 1.2.4    2020-05-25 [1] Bioconductor</span>
<span style="color:#998;font-style:italic">#  sna                      2.5      2019-12-10 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  spatstat                 1.64-1   2020-05-12 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  spatstat.data            1.4-3    2020-01-26 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  spatstat.utils           1.17-0   2020-02-07 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  statmod                  1.4.34   2020-02-17 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  statnet.common           4.4.1    2020-10-03 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  stringi                  1.5.3    2020-09-09 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  stringr                * 1.4.0    2019-02-10 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  SummarizedExperiment   * 1.18.2   2020-07-14 [1] Bioconductor</span>
<span style="color:#998;font-style:italic">#  survival                 3.2-3    2020-06-13 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  tensor                   1.5      2012-05-05 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  testthat                 2.3.2    2020-03-02 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  tibble                 * 3.0.3    2020-07-10 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  tidyr                  * 1.1.1    2020-07-31 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  tidyselect               1.1.0    2020-05-11 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  tidytree                 0.3.3    2020-04-02 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  tidyverse              * 1.3.0    2019-11-21 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  treeio                   1.12.0   2020-04-27 [1] Bioconductor</span>
<span style="color:#998;font-style:italic">#  tweenr                   1.0.1    2018-12-14 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  usethis                  1.6.1    2020-04-29 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  utf8                     1.1.4    2018-05-24 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  uwot                     0.1.8    2020-03-16 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  vctrs                    0.3.2    2020-07-15 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  vipor                    0.4.5    2017-03-22 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  viridis                * 0.5.1    2018-03-29 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  viridisLite            * 0.3.0    2018-02-01 [1] CRAN (R 4.0.1)</span>
<span style="color:#998;font-style:italic">#  withr                    2.3.0    2020-09-22 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  xfun                     0.16     2020-07-24 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  XML                      3.99-0.5 2020-07-23 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  xml2                     1.3.2    2020-04-23 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  xtable                   1.8-4    2019-04-21 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  XVector                  0.28.0   2020-04-27 [1] Bioconductor</span>
<span style="color:#998;font-style:italic">#  yaImpute                 1.0-32   2020-02-17 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  yaml                     2.2.1    2020-02-01 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic">#  zlibbioc                 1.34.0   2020-04-27 [1] Bioconductor</span>
<span style="color:#998;font-style:italic">#  zoo                      1.8-8    2020-05-02 [1] CRAN (R 4.0.2)</span>
<span style="color:#998;font-style:italic"># </span>
<span style="color:#998;font-style:italic"># [1] /Library/Frameworks/R.framework/Versions/4.0/Resources/library</span>
</code></pre></div><h2 id="to-do">To do</h2>
<ul>
<li>Differential expression analysis with muscat.</li>
<li>Cluster on diffusion map components.</li>
</ul>
<h2 id="references">References</h2>



<ol type="1">
  <li>Human bone marrow assessment by single-cell RNA sequencing, mass cytometry, and flow cytometry. Oetjen <i>et al.</i>, JCI (2018) | <a href="https://doi.org/10.1172/jci.insight.124928" target="_blank">DOI</a>
<br></li>
  <li>pipeComp, a general framework for the evaluation of computational pipelines, reveals performant single-cell RNA-seq preprocessing tools. Germain <i>et al.</i>, bioRxiv (2020) | <a href="https://doi.org/10.1101/2020.02.02.930578" target="_blank">DOI</a></li>
  <li>A benchmark of batch-effect correction methods for single-cell RNA sequencing data. Tran <i>et al.</i>, Genome Biology (2020) | <a href="https://doi.org/10.1186/s13059-019-1850-9" target="_blank">DOI</a></li>
  <li>Cerebro: interactive visualization of scRNA-seq data. Hillje <i>et al.</i>, Bioinformatics (2019) | <a href="https://doi.org/10.1093/bioinformatics/btz877" target="_blank">DOI</a></li>
</ol>



<h2 id="changelog">Changelog</h2>
<p><strong>07.10.2020</strong></p>
<ul>
<li>Removed attempt to write function that prints head and tail of a data frame as the <code>DataFrame</code> structure of the <code>S4Vectors</code> can already do that.</li>
<li>Modified <code>load10xData()</code> function so that it keeps transcript counts in sparse matrix format to reduce memory footprint.</li>
<li>Coherently with the changes to the <code>load10xData()</code> function, the merging procedure of transcript counts from different samples was adapted to avoid conversion to data frame format and thereby reduce memory consumption.</li>
<li>Update cerebroApp steps to be compatible with v1.3.</li>
<li>Minor changes to plots.
<ul>
<li>Remove individual dots from violin/box plots.</li>
<li>Properly remove axis titles instead of replacing it with an empty string.</li>
<li>Add numbers to heatmaps.</li>
</ul>
</li>
</ul>

            </div>
        </body>
        </div>
      </div>
    </div>
  </div>
  <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
  <script src="/js/fold_code_boxes.js"></script>
  <script src="/js/line_under_header.js"></script>

      </div>
<footer class="footer">
  <div class="container">
    <div class="row">
      <div class="col-md-4 col-sm-4 text-center text-lg-left">
        &copy; Copyright Roman Hillje - All rights reserved
      </div>
      <section class="col-md-4 col-sm-4 text-center">
        <a target="_blank" href="https://www.twitter.com/fakechek1"><i class="fab fa-twitter" style="color: rgba(0,0,0,.44); font-size: 2rem; margin-left: 10px" aria-hidden="true"></i></a>
        <a target="_blank" href="https://github.com/romanhaa"><i class="fab fa-github" style="color: rgba(0,0,0,.44); font-size: 2rem; margin-left: 10px" aria-hidden="true"></i></a>
        <a target="_blank" href="https://gitlab.com/romanhaa"><i class="fab fa-gitlab" style="color: rgba(0,0,0,.44); font-size: 2rem; margin-left: 10px" aria-hidden="true"></i></a>
        <a target="_blank" href="https://hub.docker.com/u/romanhaa"><i class="fab fa-docker" style="color: rgba(0,0,0,.44); font-size: 2rem; margin-left: 10px" aria-hidden="true"></i></a>
        <a target="_blank" href="https://linkedin.com/in/roman.hillje"><i class="fab fa-linkedin" style="color: rgba(0,0,0,.44); font-size: 2rem; margin-left: 10px" aria-hidden="true"></i></a>
      </section>
      <div class="col-md-4 col-sm-4 text-center text-lg-right">
        Adapted from <a target="_blank" href="https://www.wowthemes.net">Mediumish Theme</a>
      </div>
    </div>
  </div>
</footer>
</div>

<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
<script src="/js/mediumish.js"></script>
<script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script>
<script src="/js/toc.js"></script>

  </body>
</html>
